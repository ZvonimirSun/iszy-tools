var fe=Object.defineProperty;var de=(t,n,e)=>n in t?fe(t,n,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[n]=e;var X=(t,n,e)=>de(t,typeof n!="symbol"?n+"":n,e);import{k as R,a4 as Q,T,E as C,r as k,Y as N,G as ee,K as c,x as h,F as L,Z as te,w as b,W as ne,L as re,N as O,aA as oe,H as U,a0 as A,ai as ae,an as se,aZ as D,a_ as q,ab as ie,q as j,R as I,a9 as me,n as z,t as _e,aq as ye,X as ge}from"./index-CKDQabUk.js";import{E as he,a as ve}from"./el-tab-pane-DPcqdoW1.js";import{a as be,E as we}from"./el-form-item-Xocx3jtc.js";/* empty css               */import{a as Ee,E as Me}from"./el-select-DJBhRUkI.js";import"./el-popper-A00Nsn62.js";import{E as ke}from"./el-divider-CrLTRxXI.js";import{L as Se,l as F}from"./leaflet-mZlgSoQn.js";import{a as Ce,r as Pe,c as Ge,b as Le,d as xe}from"./mapUtils-ChoJ4A4w.js";import{v as Fe}from"./Router-MkuFlnk8.js";import{c as Ae}from"./createFile-BHfs3asn.js";import{V as Je}from"./VanillaJsonEditor-vBNJTTh5.js";import{u as Ne}from"./useComponentRef-BqgUyf_3.js";import{E as Ie,a as Oe}from"./el-descriptions-item-B4eE-HPS.js";import{E as Re}from"./el-empty-B19PBCfZ.js";import{E as Te,a as Ve}from"./el-table-v2-7UNs4D2X.js";import"./strings-C3QMkCNz.js";import"./castArray-C_vv_5Bo.js";import"./clone-DDlismd0.js";import"./index-qnK0QE8G.js";import"./_baseIteratee-bRzrIXxH.js";import"./index-IlaroXlv.js";import"./index-DWZwF0R7.js";import"./isUndefined-DCTLXrZ8.js";import"./el-dialog-BuwIaAd9.js";import"./el-space-CoY8TTBq.js";import"./formatBytes-aAslYXQD.js";import"./jse-theme-dark-BFUQRR9h.js";import"./_baseEach-BMR1PXEj.js";import"./_castFunction-DvhW8SIP.js";import"./map-BFrkAfhp.js";import"./toFinite-D85UWBuC.js";import"./index-CuikOomq.js";import"./index-Vcq4gwWv.js";import"./memoize-one.esm-BdPwpGay.js";import"./index-DzUXqSkD.js";import"./range-RuczrdJf.js";import"./raf--HVlgomt.js";class _{static on(n,e){if(n&&typeof e=="function"){const r=this._events.get(n);r?r.push(e):this._events.set(n,[e])}}static off(n,e){const r=this._events.get(n);if(r)if(typeof e=="function"){for(let o=r.length-1;o>=0;o--)e===r[o]&&r.splice(o,1);r.length===0&&this._events.delete(n)}else this._events.delete(n)}static emit(n,...e){const r=this._events.get(n);if(r)for(const o of r)o(...e)}}X(_,"_events",new Map);var w=63710088e-1,Be={centimeters:w*100,centimetres:w*100,degrees:360/(2*Math.PI),feet:w*3.28084,inches:w*39.37,kilometers:w/1e3,kilometres:w/1e3,meters:w,metres:w,miles:w/1609.344,millimeters:w*1e3,millimetres:w*1e3,nauticalmiles:w/1852,radians:1,yards:w*1.0936};function le(t,n,e={}){const r={type:"Feature"};return(e.id===0||e.id)&&(r.id=e.id),e.bbox&&(r.bbox=e.bbox),r.properties=n||{},r.geometry=t,r}function De(t,n,e={}){if(!t)throw new Error("coordinates is required");if(!Array.isArray(t))throw new Error("coordinates must be an Array");if(t.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!Y(t[0])||!Y(t[1]))throw new Error("coordinates must contain numbers");return le({type:"Point",coordinates:t},n,e)}function $e(t,n,e={}){for(const o of t){if(o.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");if(o[o.length-1].length!==o[0].length)throw new Error("First and last Position are not equivalent.");for(let a=0;a<o[o.length-1].length;a++)if(o[o.length-1][a]!==o[0][a])throw new Error("First and last Position are not equivalent.")}return le({type:"Polygon",coordinates:t},n,e)}function Ke(t,n="kilometers"){const e=Be[n];if(!e)throw new Error(n+" units is invalid");return t/e}function H(t){return t%(2*Math.PI)*180/Math.PI}function $(t){return t%360*Math.PI/180}function Y(t){return!isNaN(t)&&t!==null&&!Array.isArray(t)}function Ue(t){if(!t)throw new Error("coord is required");if(!Array.isArray(t)){if(t.type==="Feature"&&t.geometry!==null&&t.geometry.type==="Point")return[...t.geometry.coordinates];if(t.type==="Point")return[...t.coordinates]}if(Array.isArray(t)&&t.length>=2&&!Array.isArray(t[0])&&!Array.isArray(t[1]))return[...t];throw new Error("coord must be GeoJSON Point or an Array of numbers")}function qe(t,n,e,r={}){const o=Ue(t),a=$(o[0]),s=$(o[1]),i=$(e),l=Ke(n,r.units),y=Math.asin(Math.sin(s)*Math.cos(l)+Math.cos(s)*Math.sin(l)*Math.cos(i)),g=a+Math.atan2(Math.sin(i)*Math.sin(l)*Math.cos(s),Math.cos(l)-Math.sin(s)*Math.sin(y)),v=H(g),d=H(y);return De([v,d],r.properties)}function ze(t,n){var e,r,o,a,s,i,l,y,g,v,d=0,f=t.type==="FeatureCollection",u=t.type==="Feature",m=f?t.features.length:1;for(e=0;e<m;e++){for(i=f?t.features[e].geometry:u?t.geometry:t,y=f?t.features[e].properties:u?t.properties:{},g=f?t.features[e].bbox:u?t.bbox:void 0,v=f?t.features[e].id:u?t.id:void 0,l=i?i.type==="GeometryCollection":!1,s=l?i.geometries.length:1,o=0;o<s;o++){if(a=l?i.geometries[o]:i,a===null){if(n(null,d,y,g,v)===!1)return!1;continue}switch(a.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":{if(n(a,d,y,g,v)===!1)return!1;break}case"GeometryCollection":{for(r=0;r<a.geometries.length;r++)if(n(a.geometries[r],d,y,g,v)===!1)return!1;break}default:throw new Error("Unknown Geometry Type")}}d++}}function je(t,n,e){var r=e;return ze(t,function(o,a,s,i,l){a===0&&e===void 0?r=o:r=n(r,o,a,s,i,l)}),r}function Xe(t){return je(t,(n,e)=>n+He(e),0)}function He(t){let n=0,e;switch(t.type){case"Polygon":return Z(t.coordinates);case"MultiPolygon":for(e=0;e<t.coordinates.length;e++)n+=Z(t.coordinates[e]);return n;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":return 0}return 0}function Z(t){let n=0;if(t&&t.length>0){n+=Math.abs(W(t[0]));for(let e=1;e<t.length;e++)n-=Math.abs(W(t[e]))}return n}var Ye=w*w/2,K=Math.PI/180;function W(t){const n=t.length-1;if(n<=2)return 0;let e=0,r=0;for(;r<n;){const o=t[r],a=t[r+1===n?0:r+1],s=t[r+2>=n?(r+2)%n:r+2],i=o[0]*K,l=a[1]*K,y=s[0]*K;e+=(y-i)*Math.sin(l),r++}return e*Ye}function Ze(t,n,e={}){const r=e.steps||64,o=e.properties?e.properties:!Array.isArray(t)&&t.type==="Feature"&&t.properties?t.properties:{},a=[];for(let s=0;s<r;s++)a.push(qe(t,n,s*-360/r,e).geometry.coordinates);return a.push(a[0]),$e([a],o)}function We(t,{onChange:n}){t.on("pm:change",({layer:e})=>{n(e)})}function Qe(t,n,{onCreate:e,onRemove:r,onChange:o}={}){t.pm||Se.PM.reInitLayer(t),t.pm.setLang("zh"),t.pm.setGlobalOptions({layerGroup:n}),t.pm.addControls({position:"topright",drawCircleMarker:!1,drawText:!1,rotateMode:!0}),e&&(t.on("pm:create",({shape:s,layer:i})=>{a({shape:s,layer:i}),e(i)}),t.on("pm:cut",({layer:s})=>{a({layer:s}),e(s)})),r&&t.on("pm:remove",({layer:s})=>{r(s)}),o&&(t.on("pm:create",({shape:s,layer:i})=>{a({shape:s,layer:i}),o(i)}),t.on("pm:cut",({layer:s})=>{o(s)}),t.on("pm:remove",({layer:s})=>{o(s)}));function a({shape:s,layer:i}){if(s==="Circle"){const l=i,y=l.getLatLng(),g=l.getRadius();n.addData(Ze([y.lng,y.lat],g/1e3))}else n.addData(i.toGeoJSON());n.removeLayer(i)}}function et({geojson:t,onEachFeature:n,pointToLayer:e}={}){return F.geoJSON(t,{onEachFeature:n,pointToLayer:e??tt})}function tt(t,n){return F.marker(n)}const nt={class:"layer-wrapper"},rt=["title"],ot=["title"],at=R({__name:"AddService",setup(t){let n;const e=Q({count:0,name:"服务 1",url:"",type:"supermap_rest",layers:[]});T(()=>{_.emit("getMap",a=>{n=a})});function r(){const a=e.url,s=e.type,i=e.name;e.count++,e.name=`服务 ${e.count}`;let l;try{l=Ce(n,{name:i,type:s,url:a})}catch{oe.error("添加服务失败");return}l&&e.layers.push({name:i,url:a,layer:l,id:Fe()})}function o(a){var s;(s=e.layers[a])!=null&&s.layer&&(Pe(n,e.layers[a].layer),e.layers.splice(a,1))}return(a,s)=>{const i=re,l=ke,y=ne,g=we,v=Me,d=Ee,f=be;return k(),C(N,null,[h(e).layers.length?(k(),C(N,{key:0},[L("div",nt,[(k(!0),C(N,null,te(h(e).layers,(u,m)=>(k(),C("div",{key:u.id,class:"layer-item"},[L("div",{class:"layer-item-title",title:u.name},U(u.name),9,rt),L("div",{class:"layer-item-url",title:u.url},U(u.url),9,ot),c(i,{onClick:p=>o(m)},{default:b(()=>s[3]||(s[3]=[O(" 移除 ")])),_:2},1032,["onClick"])]))),128))]),c(l)],64)):ee("",!0),c(f,{colon:!1,class:"addService"},{default:b(()=>[c(g,{label:"服务名称"},{default:b(()=>[c(y,{modelValue:h(e).name,"onUpdate:modelValue":s[0]||(s[0]=u=>h(e).name=u)},null,8,["modelValue"])]),_:1}),c(g,{label:"服务地址"},{default:b(()=>[c(y,{modelValue:h(e).url,"onUpdate:modelValue":s[1]||(s[1]=u=>h(e).url=u)},null,8,["modelValue"])]),_:1}),c(g,{label:"服务类型"},{default:b(()=>[c(d,{modelValue:h(e).type,"onUpdate:modelValue":s[2]||(s[2]=u=>h(e).type=u)},{default:b(()=>[c(v,{value:"supermap_rest",label:"超图动态"}),c(v,{value:"supermap_tile",label:"超图切片"}),c(v,{value:"arcgis_rest",label:"ArcGIS 动态"}),c(v,{value:"arcgis_tile",label:"ArcGIS 切片"}),c(v,{value:"tms",label:"TMS"})]),_:1},8,["modelValue"])]),_:1}),c(g,{class:"formBtnItem"},{default:b(()=>[c(i,{type:"primary",onClick:r},{default:b(()=>s[4]||(s[4]=[O(" 添加 ")])),_:1})]),_:1})]),_:1})],64)}}}),st=A(at,[["__scopeId","data-v-92b9f3b9"]]),it={class:"controlMenu"},lt={__name:"ControlMenu",setup(t){function n(o){if(o.target.files.length){const a=o.target.files[0],s=new FileReader;s.onload=()=>{if(s.result&&typeof s.result=="string")try{const i=JSON.parse(s.result);_.emit("updateEditor",i),_.emit("updateGeojsonLayer",i)}catch{}},s.readAsText(a)}o.target.value=""}function e(){_.emit("getGeoJson",o=>{o?Ae(JSON.stringify(o),"exportFile.geojson"):oe.warning("无可导出数据")})}function r(){_.emit("getGeoJson",o=>{if(o){const a=Xe(o);a<1e6?D.alert(`面积: ${a.toFixed(2)} 平方米`,"信息"):a<1e8?D.alert(`面积: ${(a/1e4).toFixed(2)} 公顷`,"信息"):D.alert(`面积: ${(a/1e6).toFixed(2)} 平方千米`,"信息")}})}return(o,a)=>{const s=re;return k(),C("div",it,[ae(L("input",{ref:"uploader",type:"file",accept:".json,.JSON,.geojson,.GEOJSON",onChange:n},null,544),[[se,!1]]),c(s,{onClick:a[0]||(a[0]=i=>o.$refs.uploader.click())},{default:b(()=>a[1]||(a[1]=[O(" 打开 ")])),_:1}),c(s,{onClick:e},{default:b(()=>a[2]||(a[2]=[O(" 保存 ")])),_:1}),L("i",{class:"i-icon-park-outline-info",onClick:r})])}}},ut=A(lt,[["__scopeId","data-v-f5de7732"]]),ct=R({__name:"Editor",setup(t){const n=Ne();let e={type:"FeatureCollection",features:[]};const r=q(s,500);T(()=>{_.on("updateEditor",r)}),ie(()=>{_.off("updateEditor",r)});const o=q(a,500);function a(i){try{typeof i=="string"?e=JSON.parse(i):e=i,_.emit("updateGeojsonLayer",e)}catch{}}function s(i){var l;(l=n.value)==null||l.update(i)}return(i,l)=>(k(),j(Je,{ref_key:"editor",ref:n,class:"edit-data-json",config:{mode:"text"},content:h(e),onChange:h(o)},null,8,["content","onChange"]))}}),pt=A(ct,[["__scopeId","data-v-f3d70d49"]]),ft={key:0,class:"content"},dt=R({__name:"MainMap",setup(t){const n=new F.Icon.Default,e=new F.Icon.Default({iconUrl:"marker-icon-yellow.png",iconRetinaUrl:"marker-icon-2x-yellow.png"});let r,o;const a=I(),s=I(),i=I();T(()=>{_.on("getMap",l),_.on("updateGeojsonLayer",v),_.on("getGeoJson",d),_.on("selectFeature",u),y()}),ie(()=>{_.off("getMap",l),_.off("updateGeojsonLayer",v),_.off("getGeoJson",d),_.off("selectFeature",u),o&&o.remove()});function l(){return o}function y(){s.value&&(o=Ge({dom:s.value,view:{center:[35,105],zoom:4}}),Le(o),r=et({onEachFeature:g}).addTo(o),xe(o,{name:"图形",layer:r}),Qe(o,r,{onChange(){f()}}))}function g(m,p){We(p,{onChange:()=>{f()}}),m.properties||(m.properties={}),i.value&&p.bindPopup(i.value).on("popupopen",()=>{a.value=m,o.hasLayer(p)&&(p instanceof F.Marker?p.setIcon(e):p.setStyle({color:"#ffff00",weight:5,opacity:.65}))}).on("popupclose",()=>{a.value=void 0,o.hasLayer(p)&&(p instanceof F.Marker?p.setIcon(n):r.resetStyle(p))})}function v(m){r.clearLayers();try{r.addData(m),o.fitBounds(r.getBounds())}catch{}}function d(m){m(r==null?void 0:r.toGeoJSON())}function f(){r.getLayers().length===0?_.emit("updateEditor",{type:"FeatureCollection",features:[]}):_.emit("updateEditor",r.toGeoJSON())}function u(m){if(r.getLayers().length>m){const p=r.getLayers()[m];p.openPopup(),o.fitBounds(p.getBounds())}}return(m,p)=>{var P,G;const E=Oe,S=Ie;return k(),C(N,null,[L("div",{ref_key:"mapContainer",ref:s,class:"map-container"},null,512),ae(L("div",{ref_key:"propertyPopup",ref:i,class:"property-popup"},[p[0]||(p[0]=L("div",{class:"title"},[L("span",null,"属性")],-1)),(P=h(a))!=null&&P.properties&&Object.keys((G=h(a))==null?void 0:G.properties).length?(k(),C("div",ft,[c(S,{column:1,border:!0},{default:b(()=>[(k(!0),C(N,null,te(h(a).properties,(x,J,V)=>(k(),j(E,{key:V,label:J.toString()},{default:b(()=>[O(U(x),1)]),_:2},1032,["label"]))),128))]),_:1})])):ee("",!0)],512),[[se,!1]])],64)}}}),mt=A(dt,[["__scopeId","data-v-09090af8"]]),_t=R({__name:"PropertyTable",props:{height:{default:null}},setup(t){T(()=>{_.on("updateGeojsonLayer",g),_.on("updateEditor",g)});const n=me(),e=Q({row:null,col:null,value:null,changed:!1});let r=!1;const o=z(()=>{var d,f;return(f=(d=n.value)==null?void 0:d.features)!=null&&f.length?n.value.features.map(u=>u.properties||{}):[]}),a=z(()=>{var d,f;if((f=(d=n.value)==null?void 0:d.features)!=null&&f.length){const u=v(o.value);if(!u.length)return null;const m=u.map(p=>({title:p,dataKey:p,key:p,width:150,cellRenderer:({rowData:E,column:S,rowIndex:P,columnIndex:G})=>{let x,J;E[S.dataKey]!=null?(J=typeof E[S.dataKey],~["boolean","number","string"].indexOf(J)?x=E[S.dataKey].toString():x=JSON.stringify(E[S.dataKey])):x="";const V=()=>{e.row=P,e.col=G,e.value=x},ue=()=>{if(e.changed){let M;if(e.value!=null?M=e.value.trim():M="",J!=="string")try{M=JSON.parse(M)}catch{}l(P,G,M)}e.row=null,e.col=null,e.value=null,e.changed=!1},ce=M=>{e.value=M,e.changed=!0},pe=M=>{var B;(B=M==null?void 0:M.focus)==null||B.call(M)};return e.row===P&&e.col===G?c(ne,{ref:pe,modelValue:e.value,onInput:ce,onBlur:ue},null):c("div",{class:"table-v2-inline-editing-trigger",onClick:V,title:x},[x])}}));return m.unshift({title:"序号",dataKey:"index",key:"index",width:50,fixed:!0,cellRenderer:({rowIndex:p})=>c("span",{class:"_index"},[p+1])}),m}else return null}),s=q(y,500);function i(d){var u;let f=d.target;if(f.classList.contains("el-table-v2__row")||(f=f.closest(".el-table-v2__row")),f&&f.parentElement){const m=[].indexOf.call(f.parentElement.children,f),p=(u=f.closest(".el-table-v2__root"))==null?void 0:u.querySelectorAll("._index")[m];if(p){const E=Number.parseInt(p.textContent||"1")-1;_.emit("selectFeature",E)}}}function l(d,f,u){var p,E,S,P;const m=(E=(p=n.value)==null?void 0:p.features)==null?void 0:E[d];if(m){m.properties||(m.properties={});const G=(P=(S=a.value)==null?void 0:S[f])==null?void 0:P.dataKey;G&&(m.properties[G]=u)}n.value&&s(ye(n.value))}function y(d){r||(r=!0,_.emit("updateEditor",d),r=!1)}function g(){r||_.emit("getGeoJson",d=>{n.value=d})}function v(d){return[...d.reduce((f,u)=>(Object.keys(u).forEach(m=>f.add(m)),f),new Set)]}return(d,f)=>{const u=Ve,m=Te,p=Re;return h(a)?(k(),C("div",{key:0,"w-full":"",style:_e({height:d.height?`${d.height}px`:void 0})},[c(m,null,{default:b(({height:E,width:S})=>[c(u,{columns:h(a),data:h(o),width:S,height:E,fixed:"",onClick:i},null,8,["columns","data","width","height"])]),_:1})],4)):(k(),j(p,{key:1}))}}}),yt=A(_t,[["__scopeId","data-v-79a41de3"]]),gt=R({__name:"geoJson",setup(t){const n=I("geoJson"),e=I(),r=z(()=>e.value?Number.parseFloat(getComputedStyle(e.value).height)-40:400);return(o,a)=>{const s=he,i=ve;return k(),C("div",{ref_key:"wrapper",ref:e,class:"wrapper"},[c(mt),c(i,{modelValue:h(n),"onUpdate:modelValue":a[0]||(a[0]=l=>ge(n)?n.value=l:null),type:"card"},{default:b(()=>[c(s,{name:"geoJson",label:"GeoJSON"},{default:b(()=>[c(pt)]),_:1}),c(s,{name:"table",label:"属性表"},{default:b(()=>[c(yt,{height:h(r)},null,8,["height"])]),_:1}),c(s,{name:"addService",label:"添加服务"},{default:b(()=>[c(st)]),_:1})]),_:1},8,["modelValue"]),c(ut)],512)}}}),rn=A(gt,[["__scopeId","data-v-d74242be"]]);export{rn as default};
