var b=Object.defineProperty;var p=Object.getOwnPropertySymbols;var _=Object.prototype.hasOwnProperty,w=Object.prototype.propertyIsEnumerable;var f=(n,e,t)=>e in n?b(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,m=(n,e)=>{for(var t in e||(e={}))_.call(e,t)&&f(n,t,e[t]);if(p)for(var t of p(e))w.call(e,t)&&f(n,t,e[t]);return n};import{C as E}from"./vue-codemirror.a2ad42b5.js";import{E as P,a as S,o as g,c as T,w as B,e as h,f as k,Q as z,P as L,p as A,h as M}from"./vendor.3bd2b7e4.js";import{_ as G}from"./index.8932276d.js";class v{constructor(e,t){this.x=e.x,this.y=e.y,this.value=t||2,this.previousPosition=null,this.mergedFrom=null}savePosition(){this.previousPosition={x:this.x,y:this.y}}updatePosition(e){this.x=e.x,this.y=e.y}serialize(){return{position:{x:this.x,y:this.y},value:this.value}}}class y{constructor(e,t){this.size=e,this.cells=t?this.fromState(t):this.empty()}empty(){const e=[];for(let t=0;t<this.size;t++){const s=e[t]=[];for(let i=0;i<this.size;i++)s.push(null)}return e}fromState(e){const t=[];for(let s=0;s<this.size;s++){const i=t[s]=[];for(let o=0;o<this.size;o++){const a=e[s][o];i.push(a?new v(a.position,a.value):null)}}return t}randomAvailableCell(){const e=this.availableCells();if(e.length)return e[Math.floor(Math.random()*e.length)]}availableCells(){const e=[];return this.eachCell(function(t,s,i){i||e.push({x:t,y:s})}),e}eachCell(e){for(let t=0;t<this.size;t++)for(let s=0;s<this.size;s++)e(t,s,this.cells[t][s])}cellsAvailable(){return!!this.availableCells().length}cellAvailable(e){return!this.cellOccupied(e)}cellOccupied(e){return!!this.cellContent(e)}cellContent(e){return this.withinBounds(e)?this.cells[e.x][e.y]:null}insertTile(e){this.cells[e.x][e.y]=e}removeTile(e){this.cells[e.x][e.y]=null}withinBounds(e){return e.x>=0&&e.x<this.size&&e.y>=0&&e.y<this.size}serialize(){const e=[];for(let t=0;t<this.size;t++){const s=e[t]=[];for(let i=0;i<this.size;i++)s.push(this.cells[t][i]?this.cells[t][i].serialize():null)}return{size:this.size,cells:e}}}class K{constructor(e){this.events={},this.vue=e,this.map={ArrowUp:0,ArrowRight:1,ArrowDown:2,ArrowLeft:3,KeyK:0,KeyL:1,keyJ:2,keyH:3,KeyW:0,KeyD:1,KeyS:2,KeyA:3},window.navigator.msPointerEnabled?(this.eventTouchstart="MSPointerDown",this.eventTouchmove="MSPointerMove",this.eventTouchend="MSPointerUp"):(this.eventTouchstart="touchstart",this.eventTouchmove="touchmove",this.eventTouchend="touchend"),this.retryButton=this.vue.$refs.retryButton,this.restartButton=this.vue.$refs.restartButton,this.keepPlayingButton=this.vue.$refs.keepPlayingButton,this.gameContainer=this.vue.$refs.gameContainer,this.touchStartClientX=void 0,this.touchStartClientY=void 0,this.listen()}on(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)}emit(e,t){const s=this.events[e];s&&s.forEach(function(i){i(t)})}listen(){document.addEventListener("keydown",this._keyboardEvent.bind(this)),this.bindButtonPress(this.retryButton,this.restart),this.bindButtonPress(this.restartButton,this.restart),this.bindButtonPress(this.keepPlayingButton,this.keepPlaying),this.gameContainer.addEventListener(this.eventTouchstart,this._touchStartEvent.bind(this)),this.gameContainer.addEventListener("mousedown",this._touchStartEvent.bind(this)),this.gameContainer.addEventListener(this.eventTouchmove,function(e){e.preventDefault()}),this.gameContainer.addEventListener(this.eventTouchend,this._touchEndEvent.bind(this)),this.gameContainer.addEventListener("mouseup",this._touchEndEvent.bind(this))}restart(e){e.preventDefault(),this.emit("restart")}keepPlaying(e){e.preventDefault(),this.emit("keepPlaying")}bindButtonPress(e,t){e.addEventListener("click",t.bind(this)),e.addEventListener(this.eventTouchend,t.bind(this))}removeButtonPress(e){e.addEventListener("click"),e.addEventListener(this.eventTouchend)}_keyboardEvent(e){const t=e.altKey||e.ctrlKey||e.metaKey||e.shiftKey,s=this.map[e.code];t||s!==void 0&&(e.preventDefault(),this.emit("move",s)),!t&&e.code==="KeyR"&&this.restart(e)}_touchStartEvent(e){e.type!=="mousedown"&&(!window.navigator.msPointerEnabled&&e.touches.length>1||e.targetTouches.length>1)||(window.navigator.msPointerEnabled||e.type==="mousedown"?(this.touchStartClientX=e.pageX,this.touchStartClientY=e.pageY):(this.touchStartClientX=e.touches[0].clientX,this.touchStartClientY=e.touches[0].clientY),e.preventDefault())}_touchEndEvent(e){if(e.type!=="mouseup"&&(!window.navigator.msPointerEnabled&&e.touches.length>0||e.targetTouches.length>0))return;let t,s;window.navigator.msPointerEnabled||e.type==="mouseup"?(t=e.pageX,s=e.pageY):(t=e.changedTouches[0].clientX,s=e.changedTouches[0].clientY);const i=t-this.touchStartClientX,o=Math.abs(i),a=s-this.touchStartClientY,r=Math.abs(a);Math.max(o,r)>10&&this.emit("move",o>r?i>0?1:3:a>0?2:0)}destroy(){document.removeEventListener("keydown",this._keyboardEvent),this.removeButtonPress(this.retryButton),this.removeButtonPress(this.restartButton),this.removeButtonPress(this.keepPlayingButton),this.gameContainer.addEventListener("mousedown"),this.gameContainer.addEventListener("mouseup"),this.gameContainer.addEventListener(this.eventTouchstart),this.gameContainer.addEventListener(this.eventTouchmove),this.gameContainer.addEventListener(this.eventTouchend)}}class ${constructor(e){this.vue=e,this.tileContainer=this.vue.$refs.tileContainer,this.scoreContainer=this.vue.$refs.scoreContainer,this.bestContainer=this.vue.$refs.bestContainer,this.messageContainer=this.vue.$refs.messageContainer,this.score=0}actuate(e,t){const s=this;window.requestAnimationFrame(function(){s.clearContainer(s.tileContainer),e.cells.forEach(function(i){i.forEach(function(o){o&&s.addTile(o)})}),s.updateScore(t.score),s.updateBestScore(t.bestScore),t.terminated&&(t.over?s.message(!1):t.won&&s.message(!0))})}continueGame(){this.clearMessage()}clearContainer(e){for(;e.firstChild;)e.removeChild(e.firstChild)}addTile(e){const t=this,s=document.createElement("div"),i=document.createElement("div"),o=e.previousPosition||{x:e.x,y:e.y},a=this.positionClass(o),r=["tile","tile-"+e.value,a];e.value>2048&&r.push("tile-super"),this.applyClasses(s,r),i.classList.add("tile-inner"),i.textContent=e.value,e.previousPosition?window.requestAnimationFrame(function(){r[2]=t.positionClass({x:e.x,y:e.y}),t.applyClasses(s,r)}):e.mergedFrom?(r.push("tile-merged"),this.applyClasses(s,r),e.mergedFrom.forEach(function(l){t.addTile(l)})):(r.push("tile-new"),this.applyClasses(s,r)),s.appendChild(i),this.tileContainer.appendChild(s)}applyClasses(e,t){e.setAttribute("class",t.join(" "))}normalizePosition(e){return{x:e.x+1,y:e.y+1}}positionClass(e){return e=this.normalizePosition(e),"tile-position-"+e.x+"-"+e.y}updateScore(e){this.clearContainer(this.scoreContainer);const t=e-this.score;if(this.score=e,this.scoreContainer.textContent=this.score,t>0){const s=document.createElement("div");s.classList.add("score-addition"),s.textContent="+"+t,this.scoreContainer.appendChild(s)}}updateBestScore(e){this.bestContainer.textContent=e}message(e){const t=e?"game-won":"game-over",s=e?"\u4F60\u8D62\u5566!":"\u6E38\u620F\u7ED3\u675F!";this.messageContainer.classList.add(t),this.messageContainer.getElementsByTagName("p")[0].textContent=s}clearMessage(){this.messageContainer.classList.remove("game-won"),this.messageContainer.classList.remove("game-over")}}class F{constructor(e,t){this.vue=t,this.size=e,this.inputManager=new K(t),this.actuator=new $(t),this.startTiles=2,this.inputManager.on("move",this.move.bind(this)),this.inputManager.on("restart",this.restart.bind(this)),this.inputManager.on("keepPlaying",this.keepPlaying.bind(this)),this.setup()}destroy(){}restart(){this.vue.clearGameState(),this.actuator.continueGame(),this.setup()}keepPlaying(){this.keepPlaying=!0,this.actuator.continueGame()}isGameTerminated(){return this.over||this.won&&!this.keepPlaying}setup(){const e=this.vue.gameState;e?(this.grid=new y(e.grid.size,e.grid.cells),this.score=e.score,this.over=e.over,this.won=e.won,this.keepPlaying=e.keepPlaying):(this.grid=new y(this.size),this.score=0,this.over=!1,this.won=!1,this.keepPlaying=!1,this.addStartTiles()),this.actuate()}addStartTiles(){for(let e=0;e<this.startTiles;e++)this.addRandomTile()}addRandomTile(){if(this.grid.cellsAvailable()){const e=Math.random()<.9?2:4,t=new v(this.grid.randomAvailableCell(),e);this.grid.insertTile(t)}}actuate(){this.vue.bestScore<this.score&&this.vue.setBestScore(this.score),this.over?this.vue.clearGameState():this.vue.setGameState(this.serialize()),this.vue.state={grid:this.grid,score:this.score,over:this.over,won:this.won,bestScore:this.vue.bestScore,terminated:this.isGameTerminated()},this.actuator.actuate(this.grid,{score:this.score,over:this.over,won:this.won,bestScore:this.vue.bestScore,terminated:this.isGameTerminated()})}serialize(){return{grid:this.grid.serialize(),score:this.score,over:this.over,won:this.won,keepPlaying:this.keepPlaying}}prepareTiles(){this.grid.eachCell(function(e,t,s){s&&(s.mergedFrom=null,s.savePosition())})}moveTile(e,t){this.grid.cells[e.x][e.y]=null,this.grid.cells[t.x][t.y]=e,e.updatePosition(t)}move(e){const t=this;if(this.isGameTerminated())return;let s,i;const o=this.getVector(e),a=this.buildTraversals(o);let r=!1;this.prepareTiles(),a.x.forEach(function(l){a.y.forEach(function(x){if(s={x:l,y:x},i=t.grid.cellContent(s),i){const c=t.findFarthestPosition(s,o),d=t.grid.cellContent(c.next);if(d&&d.value===i.value&&!d.mergedFrom){const u=new v(c.next,i.value*2);u.mergedFrom=[i,d],t.grid.insertTile(u),t.grid.removeTile(i),i.updatePosition(c.next),t.score+=u.value,u.value===2048&&(t.won=!0)}else t.moveTile(i,c.farthest);t.positionsEqual(s,i)||(r=!0)}})}),r&&(this.addRandomTile(),this.movesAvailable()||(this.over=!0),this.actuate())}getVector(e){return{0:{x:0,y:-1},1:{x:1,y:0},2:{x:0,y:1},3:{x:-1,y:0}}[e]}buildTraversals(e){const t={x:[],y:[]};for(let s=0;s<this.size;s++)t.x.push(s),t.y.push(s);return e.x===1&&(t.x=t.x.reverse()),e.y===1&&(t.y=t.y.reverse()),t}findFarthestPosition(e,t){let s;do s=e,e={x:s.x+t.x,y:s.y+t.y};while(this.grid.withinBounds(e)&&this.grid.cellAvailable(e));return{farthest:s,next:e}}movesAvailable(){return this.grid.cellsAvailable()||this.tileMatchesAvailable()}tileMatchesAvailable(){const e=this;let t;for(let s=0;s<this.size;s++)for(let i=0;i<this.size;i++)if(t=this.grid.cellContent({x:s,y:i}),t)for(let o=0;o<4;o++){const a=e.getVector(o),r={x:s+a.x,y:i+a.y},l=e.grid.cellContent(r);if(l&&l.value===t.value)return!0}return!1}positionsEqual(e,t){return e.x===t.x&&e.y===t.y}}const{mapActions:D,mapState:X}=P("g2048");let C;const Y={name:"2048",components:{Container:E},data:()=>({state:{}}),computed:m({},X({gameState:n=>n.gameState,bestScore:n=>n.bestScore})),mounted(){C=new F(4,this)},methods:m({},D(["setBestScore","setGameState","clearGameState"])),beforeUnmount(){C.destroy()}},I=n=>(A("data-v-f3404b56"),n=n(),M(),n),R={class:"panel"},j={class:"container"},q={class:"above-game"},V={class:"scores-container"},H={class:"score-container",ref:"scoreContainer"},N={class:"best-container",ref:"bestContainer"},U={class:"restart-button",ref:"restartButton"},O={class:"game-container",ref:"gameContainer"},J={class:"game-message",ref:"messageContainer"},Q=I(()=>h("p",null,null,-1)),W={class:"lower"},Z={class:"keep-playing-button",ref:"keepPlayingButton"},ee={class:"retry-button",ref:"retryButton"},te={class:"grid-container"},se={class:"tile-container",ref:"tileContainer"};function ie(n,e,t,s,i,o){const a=S("container");return g(),T(a,null,{default:B(()=>[h("div",R,[h("div",j,[h("div",q,[h("div",V,[h("div",H,"0",512),h("div",N,"0",512)]),h("a",U,"\u65B0\u6E38\u620F",512)]),h("div",O,[h("div",J,[Q,h("div",W,[h("a",Z,"\u7EE7\u7EED\u6311\u6218",512),h("a",ee,"\u91CD\u65B0\u5F00\u59CB",512)])],512),h("div",te,[(g(),k(L,null,z(16,r=>h("div",{class:"grid-cell",key:r})),64))]),h("div",se,null,512)],512)])])]),_:1})}var he=G(Y,[["render",ie],["__scopeId","data-v-f3404b56"]]);export{he as default};
