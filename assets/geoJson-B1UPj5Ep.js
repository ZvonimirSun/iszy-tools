import{a as N,U as Q,J as O,v as M,N as J,y as Y,C as u,j as v,x as S,O as Z,w as b,L as W,E as ee,D as I,aq as te,z as D,o as E,Q as G,a7 as re,ad as ne,aT as T,aU as $,a0 as oe,g as K,I as A,Z as ue,c as U,n as ce,ag as pe,M as fe}from"./index-Bkf1MTYi.js";import{E as de,a as me}from"./el-tab-pane-DAt2V6fh.js";import{a as ye,E as ge}from"./el-form-item-DSDN4CXf.js";/* empty css               */import{a as _e,E as he}from"./el-select-CWqbTjI4.js";import"./el-popper-CinPRLFX.js";import{E as ve}from"./el-divider-B1QRV2SH.js";import{L as be,l as x}from"./leaflet-DxYi5tFJ.js";import{a as we,r as Ee,c as Me,b as ke,d as Se}from"./mapUtils-C7UYam94.js";import{v as Ce}from"./Router-2RCa5O6V.js";import{c as Le}from"./createFile-jAa6k8pM.js";import{V as Pe}from"./VanillaJsonEditor-C4pA5YI4.js";import{u as xe}from"./useComponentRef-7KAuBRY7.js";import{E as Ge,a as Fe}from"./el-descriptions-item-KezlEJPZ.js";import{E as Je}from"./el-empty-CWdM2z0h.js";import{E as Ae,a as Ie}from"./el-table-v2-GcHstSOG.js";import"./raf-CVCfuMuZ.js";import"./strings-BH2VfOjy.js";import"./clamp-C3iGt3fs.js";import"./omit-eJuxsPpX.js";import"./last-D-rYfuUG.js";import"./castArray-hV_lnj3K.js";import"./clone-BbUbFHvm.js";import"./index-DSL_aX27.js";import"./_baseIteratee-D0SHzwa0.js";import"./index-Be1B6z83.js";import"./index-BwaX_Gqv.js";import"./index-Ck7UIilF.js";import"./el-dialog-RIoHIMuO.js";import"./el-space-3ig5pSO1.js";import"./jse-theme-dark-CSLMZsQO.js";import"./memoize-one.esm-BdPwpGay.js";import"./index-C7c8vKF6.js";import"./index-Vcq4gwWv.js";import"./map-CVv9iTwN.js";import"./_baseEach-BdepwM8o.js";import"./range-DVQkrMwX.js";import"./toFinite-vFEi5aVS.js";import"./_castFunction-BOcjAzxW.js";import"./formatBytes-aAslYXQD.js";class y{static _events=new Map;static on(r,e){if(r&&typeof e=="function"){const n=this._events.get(r);n?n.push(e):this._events.set(r,[e])}}static off(r,e){const n=this._events.get(r);if(n)if(typeof e=="function"){for(let o=n.length-1;o>=0;o--)e===n[o]&&n.splice(o,1);n.length===0&&this._events.delete(r)}else this._events.delete(r)}static emit(r,...e){const n=this._events.get(r);if(n)for(const o of n)o(...e)}}var w=63710088e-1,Ne={centimeters:w*100,centimetres:w*100,degrees:360/(2*Math.PI),feet:w*3.28084,inches:w*39.37,kilometers:w/1e3,kilometres:w/1e3,meters:w,metres:w,miles:w/1609.344,millimeters:w*1e3,millimetres:w*1e3,nauticalmiles:w/1852,radians:1,yards:w*1.0936};function ae(t,r,e={}){const n={type:"Feature"};return(e.id===0||e.id)&&(n.id=e.id),e.bbox&&(n.bbox=e.bbox),n.properties=r||{},n.geometry=t,n}function q(t,r,e={}){if(!t)throw new Error("coordinates is required");if(!Array.isArray(t))throw new Error("coordinates must be an Array");if(t.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!j(t[0])||!j(t[1]))throw new Error("coordinates must contain numbers");return ae({type:"Point",coordinates:t},r,e)}function Oe(t,r,e={}){for(const o of t){if(o.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");if(o[o.length-1].length!==o[0].length)throw new Error("First and last Position are not equivalent.");for(let a=0;a<o[o.length-1].length;a++)if(o[o.length-1][a]!==o[0][a])throw new Error("First and last Position are not equivalent.")}return ae({type:"Polygon",coordinates:t},r,e)}function Re(t,r="kilometers"){const e=Ne[r];if(!e)throw new Error(r+" units is invalid");return t/e}function z(t){return t%(2*Math.PI)*180/Math.PI}function V(t){return t%360*Math.PI/180}function j(t){return!isNaN(t)&&t!==null&&!Array.isArray(t)}function Te(t){if(!t)throw new Error("coord is required");if(!Array.isArray(t)){if(t.type==="Feature"&&t.geometry!==null&&t.geometry.type==="Point")return[...t.geometry.coordinates];if(t.type==="Point")return[...t.coordinates]}if(Array.isArray(t)&&t.length>=2&&!Array.isArray(t[0])&&!Array.isArray(t[1]))return[...t];throw new Error("coord must be GeoJSON Point or an Array of numbers")}function Ve(t,r,e,n={}){const o=Te(t),a=V(o[0]),s=V(o[1]),i=V(e),p=Re(r,n.units),g=Math.asin(Math.sin(s)*Math.cos(p)+Math.cos(s)*Math.sin(p)*Math.cos(i)),_=a+Math.atan2(Math.sin(i)*Math.sin(p)*Math.cos(s),Math.cos(p)-Math.sin(s)*Math.sin(g)),h=z(_),d=z(g);return o[2]!==void 0?q([h,d,o[2]],n.properties):q([h,d],n.properties)}function Be(t,r){var e,n,o,a,s,i,p,g,_,h,d=0,m=t.type==="FeatureCollection",l=t.type==="Feature",c=m?t.features.length:1;for(e=0;e<c;e++){for(i=m?t.features[e].geometry:l?t.geometry:t,g=m?t.features[e].properties:l?t.properties:{},_=m?t.features[e].bbox:l?t.bbox:void 0,h=m?t.features[e].id:l?t.id:void 0,p=i?i.type==="GeometryCollection":!1,s=p?i.geometries.length:1,o=0;o<s;o++){if(a=p?i.geometries[o]:i,a===null){if(r(null,d,g,_,h)===!1)return!1;continue}switch(a.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":{if(r(a,d,g,_,h)===!1)return!1;break}case"GeometryCollection":{for(n=0;n<a.geometries.length;n++)if(r(a.geometries[n],d,g,_,h)===!1)return!1;break}default:throw new Error("Unknown Geometry Type")}}d++}}function De(t,r,e){var n=e;return Be(t,function(o,a,s,i,p){a===0&&e===void 0?n=o:n=r(n,o,a,s,i,p)}),n}function $e(t){return De(t,(r,e)=>r+Ue(e),0)}function Ue(t){let r=0,e;switch(t.type){case"Polygon":return X(t.coordinates);case"MultiPolygon":for(e=0;e<t.coordinates.length;e++)r+=X(t.coordinates[e]);return r;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":return 0}return 0}function X(t){let r=0;if(t&&t.length>0){r+=Math.abs(H(t[0]));for(let e=1;e<t.length;e++)r-=Math.abs(H(t[e]))}return r}var Ke=w*w/2,B=Math.PI/180;function H(t){const r=t.length-1;if(r<=2)return 0;let e=0,n=0;for(;n<r;){const o=t[n],a=t[n+1===r?0:n+1],s=t[n+2>=r?(n+2)%r:n+2],i=o[0]*B,p=a[1]*B,g=s[0]*B;e+=(g-i)*Math.sin(p),n++}return e*Ke}function qe(t,r,e={}){const n=e.steps||64,o=e.properties?e.properties:!Array.isArray(t)&&t.type==="Feature"&&t.properties?t.properties:{},a=[];for(let s=0;s<n;s++)a.push(Ve(t,r,s*-360/n,e).geometry.coordinates);return a.push(a[0]),Oe([a],o)}function ze(t,{onChange:r}){t.on("pm:change",({layer:e})=>{r(e)})}function je(t,r,{onCreate:e,onRemove:n,onChange:o}={}){t.pm||be.PM.reInitLayer(t),t.pm.setLang("zh"),t.pm.setGlobalOptions({layerGroup:r}),t.pm.addControls({position:"topright",drawCircleMarker:!1,drawText:!1,rotateMode:!0}),e&&(t.on("pm:create",({shape:s,layer:i})=>{a({shape:s,layer:i}),e(i)}),t.on("pm:cut",({layer:s})=>{a({layer:s}),e(s)})),n&&t.on("pm:remove",({layer:s})=>{n(s)}),o&&(t.on("pm:create",({shape:s,layer:i})=>{a({shape:s,layer:i}),o(i)}),t.on("pm:cut",({layer:s})=>{o(s)}),t.on("pm:remove",({layer:s})=>{o(s)}));function a({shape:s,layer:i}){if(s==="Circle"){const p=i,g=p.getLatLng(),_=p.getRadius();r.addData(qe([g.lng,g.lat],_/1e3))}else r.addData(i.toGeoJSON());r.removeLayer(i)}}function Xe({geojson:t,onEachFeature:r,pointToLayer:e}={}){return x.geoJSON(t,{onEachFeature:r,pointToLayer:e??He})}function He(t,r){return x.marker(r)}const Qe={class:"layer-wrapper"},Ye=["title"],Ze=["title"],We=N({__name:"AddService",setup(t){let r;const e=Q({count:0,name:"服务 1",url:"",type:"supermap_rest",layers:[]});O(()=>{y.emit("getMap",a=>{r=a})});function n(){const a=e.url,s=e.type,i=e.name;e.count++,e.name=`服务 ${e.count}`;let p;try{p=we(r,{name:i,type:s,url:a})}catch{te.error("添加服务失败");return}p&&e.layers.push({name:i,url:a,layer:p,id:Ce()})}function o(a){e.layers[a]?.layer&&(Ee(r,e.layers[a].layer),e.layers.splice(a,1))}return(a,s)=>{const i=ee,p=ve,g=W,_=ge,h=he,d=_e,m=ye;return E(),M(J,null,[v(e).layers.length?(E(),M(J,{key:0},[S("div",Qe,[(E(!0),M(J,null,Z(v(e).layers,(l,c)=>(E(),M("div",{key:l.id,class:"layer-item"},[S("div",{class:"layer-item-title",title:l.name},D(l.name),9,Ye),S("div",{class:"layer-item-url",title:l.url},D(l.url),9,Ze),u(i,{onClick:f=>o(c)},{default:b(()=>[...s[3]||(s[3]=[I(" 移除 ",-1)])]),_:1},8,["onClick"])]))),128))]),u(p)],64)):Y("",!0),u(m,{colon:!1,class:"addService"},{default:b(()=>[u(_,{label:"服务名称"},{default:b(()=>[u(g,{modelValue:v(e).name,"onUpdate:modelValue":s[0]||(s[0]=l=>v(e).name=l)},null,8,["modelValue"])]),_:1}),u(_,{label:"服务地址"},{default:b(()=>[u(g,{modelValue:v(e).url,"onUpdate:modelValue":s[1]||(s[1]=l=>v(e).url=l)},null,8,["modelValue"])]),_:1}),u(_,{label:"服务类型"},{default:b(()=>[u(d,{modelValue:v(e).type,"onUpdate:modelValue":s[2]||(s[2]=l=>v(e).type=l)},{default:b(()=>[u(h,{value:"supermap_rest",label:"超图动态"}),u(h,{value:"supermap_tile",label:"超图切片"}),u(h,{value:"arcgis_rest",label:"ArcGIS 动态"}),u(h,{value:"arcgis_tile",label:"ArcGIS 切片"}),u(h,{value:"tms",label:"TMS"})]),_:1},8,["modelValue"])]),_:1}),u(_,{class:"formBtnItem"},{default:b(()=>[u(i,{type:"primary",onClick:n},{default:b(()=>[...s[4]||(s[4]=[I(" 添加 ",-1)])]),_:1})]),_:1})]),_:1})],64)}}}),et=G(We,[["__scopeId","data-v-92b9f3b9"]]),tt={class:"controlMenu"},rt={__name:"ControlMenu",setup(t){function r(o){if(o.target.files.length){const a=o.target.files[0],s=new FileReader;s.onload=()=>{if(s.result&&typeof s.result=="string")try{const i=JSON.parse(s.result);y.emit("updateEditor",i),y.emit("updateGeojsonLayer",i)}catch{}},s.readAsText(a)}o.target.value=""}function e(){y.emit("getGeoJson",o=>{o?Le(JSON.stringify(o),"exportFile.geojson"):te.warning("无可导出数据")})}function n(){y.emit("getGeoJson",o=>{if(o){const a=$e(o);a<1e6?T.alert(`面积: ${a.toFixed(2)} 平方米`,"信息"):a<1e8?T.alert(`面积: ${(a/1e4).toFixed(2)} 公顷`,"信息"):T.alert(`面积: ${(a/1e6).toFixed(2)} 平方千米`,"信息")}})}return(o,a)=>{const s=ee;return E(),M("div",tt,[re(S("input",{ref:"uploader",type:"file",accept:".json,.JSON,.geojson,.GEOJSON",onChange:r},null,544),[[ne,!1]]),u(s,{onClick:a[0]||(a[0]=i=>o.$refs.uploader.click())},{default:b(()=>[...a[1]||(a[1]=[I(" 打开 ",-1)])]),_:1}),u(s,{onClick:e},{default:b(()=>[...a[2]||(a[2]=[I(" 保存 ",-1)])]),_:1}),S("i",{class:"i-icon-park-outline-info",onClick:n})])}}},nt=G(rt,[["__scopeId","data-v-f5de7732"]]),ot=N({__name:"Editor",setup(t){const r=xe();let e={type:"FeatureCollection",features:[]};const n=$(s,500);O(()=>{y.on("updateEditor",n)}),oe(()=>{y.off("updateEditor",n)});const o=$(a,500);function a(i){try{typeof i=="string"?e=JSON.parse(i):e=i,y.emit("updateGeojsonLayer",e)}catch{}}function s(i){r.value?.update(i)}return(i,p)=>(E(),K(Pe,{ref_key:"editor",ref:r,class:"edit-data-json",config:{mode:"text"},content:v(e),onChange:v(o)},null,8,["content","onChange"]))}}),at=G(ot,[["__scopeId","data-v-f3d70d49"]]),st={key:0,class:"content"},it=N({__name:"MainMap",setup(t){const r=new x.Icon.Default,e=new x.Icon.Default({iconUrl:"marker-icon-yellow.png",iconRetinaUrl:"marker-icon-2x-yellow.png"});let n,o;const a=A(),s=A(),i=A();O(()=>{y.on("getMap",p),y.on("updateGeojsonLayer",h),y.on("getGeoJson",d),y.on("selectFeature",l),g()}),oe(()=>{y.off("getMap",p),y.off("updateGeojsonLayer",h),y.off("getGeoJson",d),y.off("selectFeature",l),o&&o.remove()});function p(){return o}function g(){s.value&&(o=Me({dom:s.value,view:{center:[35,105],zoom:4}}),ke(o),n=Xe({onEachFeature:_}).addTo(o),Se(o,{name:"图形",layer:n}),je(o,n,{onChange(){m()}}))}function _(c,f){ze(f,{onChange:()=>{m()}}),c.properties||(c.properties={}),i.value&&f.bindPopup(i.value).on("popupopen",()=>{a.value=c,o.hasLayer(f)&&(f instanceof x.Marker?f.setIcon(e):f.setStyle({color:"#ffff00",weight:5,opacity:.65}))}).on("popupclose",()=>{a.value=void 0,o.hasLayer(f)&&(f instanceof x.Marker?f.setIcon(r):n.resetStyle(f))})}function h(c){n.clearLayers();try{n.addData(c),o.fitBounds(n.getBounds())}catch{}}function d(c){c(n?.toGeoJSON())}function m(){n.getLayers().length===0?y.emit("updateEditor",{type:"FeatureCollection",features:[]}):y.emit("updateEditor",n.toGeoJSON())}function l(c){if(n.getLayers().length>c){const f=n.getLayers()[c];f.openPopup(),o.fitBounds(f.getBounds())}}return(c,f)=>{const L=Fe,P=Ge;return E(),M(J,null,[S("div",{ref_key:"mapContainer",ref:s,class:"map-container"},null,512),re(S("div",{ref_key:"propertyPopup",ref:i,class:"property-popup"},[f[0]||(f[0]=S("div",{class:"title"},[S("span",null,"属性")],-1)),v(a)?.properties&&Object.keys(v(a)?.properties).length?(E(),M("div",st,[u(P,{column:1,border:!0},{default:b(()=>[(E(!0),M(J,null,Z(v(a).properties,(C,F,R)=>(E(),K(L,{key:R,label:F.toString()},{default:b(()=>[I(D(C),1)]),_:2},1032,["label"]))),128))]),_:1})])):Y("",!0)],512),[[ne,!1]])],64)}}}),lt=G(it,[["__scopeId","data-v-09090af8"]]),ut=N({__name:"PropertyTable",props:{height:{default:null}},setup(t){O(()=>{y.on("updateGeojsonLayer",_),y.on("updateEditor",_)});const r=ue(),e=Q({row:null,col:null,value:null,changed:!1});let n=!1;const o=U(()=>r.value?.features?.length?r.value.features.map(d=>d.properties||{}):[]),a=U(()=>{if(r.value?.features?.length){const d=h(o.value);if(!d.length)return null;const m=d.map(l=>({title:l,dataKey:l,key:l,width:150,cellRenderer:({rowData:c,column:f,rowIndex:L,columnIndex:P})=>{let C,F;c[f.dataKey]!=null?(F=typeof c[f.dataKey],~["boolean","number","string"].indexOf(F)?C=c[f.dataKey].toString():C=JSON.stringify(c[f.dataKey])):C="";const R=()=>{e.row=L,e.col=P,e.value=C},se=()=>{if(e.changed){let k;if(e.value!=null?k=e.value.trim():k="",F!=="string")try{k=JSON.parse(k)}catch{}p(L,P,k)}e.row=null,e.col=null,e.value=null,e.changed=!1},ie=k=>{e.value=k,e.changed=!0},le=k=>{k?.focus?.()};return e.row===L&&e.col===P?u(W,{ref:le,modelValue:e.value,onInput:ie,onBlur:se},null):u("div",{class:"table-v2-inline-editing-trigger",onClick:R,title:C},[C])}}));return m.unshift({title:"序号",dataKey:"index",key:"index",width:50,fixed:!0,cellRenderer:({rowIndex:l})=>u("span",{class:"_index"},[l+1])}),m}else return null}),s=$(g,500);function i(d){let m=d.target;if(m.classList.contains("el-table-v2__row")||(m=m.closest(".el-table-v2__row")),m&&m.parentElement){const l=[].indexOf.call(m.parentElement.children,m),c=m.closest(".el-table-v2__root")?.querySelectorAll("._index")[l];if(c){const f=Number.parseInt(c.textContent||"1")-1;y.emit("selectFeature",f)}}}function p(d,m,l){const c=r.value?.features?.[d];if(c){c.properties||(c.properties={});const f=a.value?.[m]?.dataKey;f&&(c.properties[f]=l)}r.value&&s(pe(r.value))}function g(d){n||(n=!0,y.emit("updateEditor",d),n=!1)}function _(){n||y.emit("getGeoJson",d=>{r.value=d})}function h(d){return[...d.reduce((m,l)=>(Object.keys(l).forEach(c=>m.add(c)),m),new Set)]}return(d,m)=>{const l=Ie,c=Ae,f=Je;return v(a)?(E(),M("div",{key:0,"w-full":"",style:ce({height:t.height?`${t.height}px`:void 0})},[u(c,null,{default:b(({height:L,width:P})=>[u(l,{columns:v(a),data:v(o),width:P,height:L,fixed:"",onClick:i},null,8,["columns","data","width","height"])]),_:1})],4)):(E(),K(f,{key:1}))}}}),ct=G(ut,[["__scopeId","data-v-47823758"]]),pt=N({__name:"geoJson",setup(t){const r=A("geoJson"),e=A(),n=U(()=>e.value?Number.parseFloat(getComputedStyle(e.value).height)-40:400);return(o,a)=>{const s=de,i=me;return E(),M("div",{ref_key:"wrapper",ref:e,class:"wrapper"},[u(lt),u(i,{modelValue:v(r),"onUpdate:modelValue":a[0]||(a[0]=p=>fe(r)?r.value=p:null),type:"card"},{default:b(()=>[u(s,{name:"geoJson",label:"GeoJSON"},{default:b(()=>[u(at)]),_:1}),u(s,{name:"table",label:"属性表"},{default:b(()=>[u(ct,{height:v(n)},null,8,["height"])]),_:1}),u(s,{name:"addService",label:"添加服务"},{default:b(()=>[u(et)]),_:1})]),_:1},8,["modelValue"]),u(nt)],512)}}}),Wt=G(pt,[["__scopeId","data-v-d74242be"]]);export{Wt as default};
