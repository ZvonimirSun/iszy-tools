var de=Object.defineProperty;var me=(t,r,e)=>r in t?de(t,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[r]=e;var X=(t,r,e)=>(me(t,typeof r!="symbol"?r+"":r,e),e);import{F as T,t as J,o as V,v as ee,J as S,K as C,ap as G,P as te,u as g,X as c,a1 as b,T as N,ax as re,a0 as H,ar as O,ai as K,a3 as ae,ab as ne,aA as _e,aB as ye,aC as A,bk as z,s as ve,aE as oe,m as q,N as ge,az as ie,aS as he,a$ as se,as as le,bl as $,aw as be}from"./index-IFmvZR23.js";import{E as we,a as Ee}from"./el-tab-pane-9cCnoand.js";import{E as Me,a as Se}from"./el-descriptions-item-9fGJ0Co-.js";import{l as L,L as ke}from"./leaflet-src-xuFLwAGL.js";import{c as Ce,a as xe,b as Pe,d as Ge,r as Ie}from"./leaflet-geoman-bSHn7FCb.js";import{V as Le}from"./VanillaJsonEditor-iOfKrhse.js";import{u as Ae}from"./useComponentRef-yj-v4mt6.js";import{E as Fe}from"./el-empty-Pd4mHpqZ.js";import{E as Je,a as Ne}from"./el-table-v2-QBBGmD0c.js";import"./el-scrollbar-vz8xv5bG.js";import{a as Oe,E as Te}from"./el-form-item-ZmXsUc-A.js";/* empty css               */import{E as Ve,a as Re}from"./el-select-DlyDMMKy.js";import{v as Be}from"./Router-fh6J4qL9.js";import{E as $e}from"./el-divider-ONhr9-5p.js";import{c as De}from"./createFile-uGBaShqb.js";import"./strings-XU1GClZ6.js";import"./el-dialog-9q6FV5jp.js";import"./el-space-zbKE7TOm.js";import"./jse-theme-dark-fXoqOi3a.js";import"./_baseEach-cDVgKv3V.js";import"./_castFunction--lnznvdy.js";import"./_baseSlice-dEb6GWcI.js";import"./index-t2m1rPvd.js";import"./hasIn-G5_2sI6H.js";import"./map-JOBu1Em8.js";import"./toInteger-8VmjLHMR.js";import"./toFinite-dlpa1aR7.js";import"./index-Dd4nB5yZ.js";import"./memoize-one.esm-JaOscZgY.js";import"./range-AzelRJPR.js";import"./formatBytes-TJBQWjKc.js";import"./castArray-UoUr7tx-.js";import"./raf-RQSX2HvH.js";import"./index-SxZUzbS-.js";import"./index-J65H5C9j.js";class y{static on(r,e){if(r&&typeof e=="function"){const a=this._events.get(r);a?a.push(e):this._events.set(r,[e])}}static off(r,e){const a=this._events.get(r);if(a)if(typeof e=="function"){for(let i=a.length-1;i>=0;i--)e===a[i]&&a.splice(i,1);a.length===0&&this._events.delete(r)}else this._events.delete(r)}static emit(r,...e){const a=this._events.get(r);if(a)for(const i of a)i(...e)}}X(y,"_events",new Map);function Ue({geojson:t,onEachFeature:r,pointToLayer:e}={}){return L.geoJSON(t,{onEachFeature:r,pointToLayer:e??Ke})}function Ke(t,r){return L.marker(r)}var w=63710088e-1,ze={centimeters:w*100,centimetres:w*100,degrees:w/111325,feet:w*3.28084,inches:w*39.37,kilometers:w/1e3,kilometres:w/1e3,meters:w,metres:w,miles:w/1609.344,millimeters:w*1e3,millimetres:w*1e3,nauticalmiles:w/1852,radians:1,yards:w*1.0936};function ue(t,r,e){e===void 0&&(e={});var a={type:"Feature"};return(e.id===0||e.id)&&(a.id=e.id),e.bbox&&(a.bbox=e.bbox),a.properties=r||{},a.geometry=t,a}function qe(t,r,e){if(e===void 0&&(e={}),!t)throw new Error("coordinates is required");if(!Array.isArray(t))throw new Error("coordinates must be an Array");if(t.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!W(t[0])||!W(t[1]))throw new Error("coordinates must contain numbers");var a={type:"Point",coordinates:t};return ue(a,r,e)}function He(t,r,e){e===void 0&&(e={});for(var a=0,i=t;a<i.length;a++){var o=i[a];if(o.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");for(var n=0;n<o[o.length-1].length;n++)if(o[o.length-1][n]!==o[0][n])throw new Error("First and last Position are not equivalent.")}var s={type:"Polygon",coordinates:t};return ue(s,r,e)}function Xe(t,r){r===void 0&&(r="kilometers");var e=ze[r];if(!e)throw new Error(r+" units is invalid");return t/e}function Q(t){var r=t%(2*Math.PI);return r*180/Math.PI}function D(t){var r=t%360;return r*Math.PI/180}function W(t){return!isNaN(t)&&t!==null&&!Array.isArray(t)}function Qe(t,r){var e,a,i,o,n,s,l,_,v,h,p=0,f=t.type==="FeatureCollection",u=t.type==="Feature",m=f?t.features.length:1;for(e=0;e<m;e++){for(s=f?t.features[e].geometry:u?t.geometry:t,_=f?t.features[e].properties:u?t.properties:{},v=f?t.features[e].bbox:u?t.bbox:void 0,h=f?t.features[e].id:u?t.id:void 0,l=s?s.type==="GeometryCollection":!1,n=l?s.geometries.length:1,i=0;i<n;i++){if(o=l?s.geometries[i]:s,o===null){if(r(null,p,_,v,h)===!1)return!1;continue}switch(o.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":{if(r(o,p,_,v,h)===!1)return!1;break}case"GeometryCollection":{for(a=0;a<o.geometries.length;a++)if(r(o.geometries[a],p,_,v,h)===!1)return!1;break}default:throw new Error("Unknown Geometry Type")}}p++}}function We(t,r,e){var a=e;return Qe(t,function(i,o,n,s,l){o===0&&e===void 0?a=i:a=r(a,i,o,n,s,l)}),a}function Ye(t){if(!t)throw new Error("coord is required");if(!Array.isArray(t)){if(t.type==="Feature"&&t.geometry!==null&&t.geometry.type==="Point")return t.geometry.coordinates;if(t.type==="Point")return t.coordinates}if(Array.isArray(t)&&t.length>=2&&!Array.isArray(t[0])&&!Array.isArray(t[1]))return t;throw new Error("coord must be GeoJSON Point or an Array of numbers")}function Ze(t,r,e,a){a===void 0&&(a={});var i=Ye(t),o=D(i[0]),n=D(i[1]),s=D(e),l=Xe(r,a.units),_=Math.asin(Math.sin(n)*Math.cos(l)+Math.cos(n)*Math.sin(l)*Math.cos(s)),v=o+Math.atan2(Math.sin(s)*Math.sin(l)*Math.cos(n),Math.cos(l)-Math.sin(n)*Math.sin(_)),h=Q(v),p=Q(_);return qe([h,p],a.properties)}function je(t,r,e){e===void 0&&(e={});for(var a=e.steps||64,i=e.properties?e.properties:!Array.isArray(t)&&t.type==="Feature"&&t.properties?t.properties:{},o=[],n=0;n<a;n++)o.push(Ze(t,r,n*-360/a,e).geometry.coordinates);return o.push(o[0]),He([o],i)}var Y=6378137;function et(t){return We(t,function(r,e){return r+tt(e)},0)}function tt(t){var r=0,e;switch(t.type){case"Polygon":return Z(t.coordinates);case"MultiPolygon":for(e=0;e<t.coordinates.length;e++)r+=Z(t.coordinates[e]);return r;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":return 0}return 0}function Z(t){var r=0;if(t&&t.length>0){r+=Math.abs(j(t[0]));for(var e=1;e<t.length;e++)r-=Math.abs(j(t[e]))}return r}function j(t){var r,e,a,i,o,n,s,l=0,_=t.length;if(_>2){for(s=0;s<_;s++)s===_-2?(i=_-2,o=_-1,n=0):s===_-1?(i=_-1,o=0,n=1):(i=s,o=s+1,n=s+2),r=t[i],e=t[o],a=t[n],l+=(U(a[0])-U(r[0]))*Math.sin(U(e[1]));l=l*Y*Y/2}return l}function U(t){return t*Math.PI/180}function rt(t,{onChange:r}){t.on("pm:change",({layer:e})=>{r(e)})}function at(t,r,{onCreate:e,onRemove:a,onChange:i}={}){t.pm||ke.PM.reInitLayer(t),t.pm.setLang("zh"),t.pm.setGlobalOptions({layerGroup:r}),t.pm.addControls({position:"topright",drawCircleMarker:!1,drawText:!1,rotateMode:!0}),e&&(t.on("pm:create",({shape:n,layer:s})=>{o({shape:n,layer:s}),e(s)}),t.on("pm:cut",({layer:n})=>{o({layer:n}),e(n)})),a&&t.on("pm:remove",({layer:n})=>{a(n)}),i&&(t.on("pm:create",({shape:n,layer:s})=>{o({shape:n,layer:s}),i(s)}),t.on("pm:cut",({layer:n})=>{i(n)}),t.on("pm:remove",({layer:n})=>{i(n)}));function o({shape:n,layer:s}){if(n==="Circle"){const l=s,_=l.getLatLng(),v=l.getRadius();r.addData(je([_.lng,_.lat],v/1e3))}else r.addData(s.toGeoJSON());r.removeLayer(s)}}const nt=t=>(_e("data-v-57bfadf3"),t=t(),ye(),t),ot=nt(()=>G("div",{class:"title"},[G("span",null,"属性")],-1)),it={key:0,class:"content"},st=T({__name:"MainMap",setup(t){const r=new L.Icon.Default,e=new L.Icon.Default({iconUrl:"marker-icon-yellow.png",iconRetinaUrl:"marker-icon-2x-yellow.png"});let a,i;const o=J(),n=J(),s=J();V(()=>{y.on("getMap",l),y.on("updateGeojsonLayer",h),y.on("getGeoJson",p),y.on("selectFeature",u),_()}),ee(()=>{y.off("getMap",l),y.off("updateGeojsonLayer",h),y.off("getGeoJson",p),y.off("selectFeature",u),i&&i.remove()});function l(){return i}function _(){n.value&&(i=Ce({dom:n.value,view:{center:[35,105],zoom:4}}),xe(i),a=Ue({onEachFeature:v}).addTo(i),Pe(i,{name:"图形",layer:a}),at(i,a,{onChange(){f()}}))}function v(m,d){rt(d,{onChange:()=>{f()}}),m.properties||(m.properties={}),s.value&&d.bindPopup(s.value).on("popupopen",()=>{o.value=m,i.hasLayer(d)&&(d instanceof L.Marker?d.setIcon(e):d.setStyle({color:"#ffff00",weight:5,opacity:.65}))}).on("popupclose",()=>{o.value=void 0,i.hasLayer(d)&&(d instanceof L.Marker?d.setIcon(r):a.resetStyle(d))})}function h(m){a.clearLayers();try{a.addData(m),i.fitBounds(a.getBounds())}catch{}}function p(m){m(a==null?void 0:a.toGeoJSON())}function f(){a.getLayers().length===0?y.emit("updateEditor",{type:"FeatureCollection",features:[]}):y.emit("updateEditor",a.toGeoJSON())}function u(m){if(a.getLayers().length>m){const d=a.getLayers()[m];d.openPopup(),i.fitBounds(d.getBounds())}}return(m,d)=>{var x,P;const E=Me,k=Se;return S(),C(N,null,[G("div",{ref_key:"mapContainer",ref:n,class:"map-container"},null,512),te(G("div",{ref_key:"propertyPopup",ref:s,class:"property-popup"},[ot,(x=g(o))!=null&&x.properties&&Object.keys((P=g(o))==null?void 0:P.properties).length?(S(),C("div",it,[c(k,{column:1,border:!0},{default:b(()=>[(S(!0),C(N,null,re(g(o).properties,(I,F,R)=>(S(),H(E,{key:R,label:F.toString()},{default:b(()=>[O(K(I),1)]),_:2},1032,["label"]))),128))]),_:1})])):ae("",!0)],512),[[ne,!1]])],64)}}}),lt=A(st,[["__scopeId","data-v-57bfadf3"]]),ut=T({__name:"Editor",setup(t){const r=Ae();let e={type:"FeatureCollection",features:[]};const a=z(n,500);V(()=>{y.on("updateEditor",a)}),ee(()=>{y.off("updateEditor",a)});const i=z(o,500);function o(s){try{typeof s=="string"?e=JSON.parse(s):e=s,y.emit("updateGeojsonLayer",e)}catch{}}function n(s){var l;(l=r.value)==null||l.update(s)}return(s,l)=>(S(),H(Le,{ref_key:"editor",ref:r,class:"edit-data-json",config:{mode:"text"},content:g(e),onChange:g(i)},null,8,["content","onChange"]))}}),ct=A(ut,[["__scopeId","data-v-df2ec252"]]),ft=T({__name:"PropertyTable",props:{height:{default:null}},setup(t){V(()=>{y.on("updateGeojsonLayer",v),y.on("updateEditor",v)});const r=ve(),e=oe({row:null,col:null,value:null,changed:!1});let a=!1;const i=q(()=>{var p,f;return(f=(p=r.value)==null?void 0:p.features)!=null&&f.length?r.value.features.map(u=>u.properties||{}):[]}),o=q(()=>{var p,f;if((f=(p=r.value)==null?void 0:p.features)!=null&&f.length){const u=h(i.value);if(!u.length)return null;const m=u.map(d=>({title:d,dataKey:d,key:d,width:150,cellRenderer:({rowData:E,column:k,rowIndex:x,columnIndex:P})=>{let I,F;E[k.dataKey]!=null?(F=typeof E[k.dataKey],~["boolean","number","string"].indexOf(F)?I=E[k.dataKey].toString():I=JSON.stringify(E[k.dataKey])):I="";const R=()=>{e.row=x,e.col=P,e.value=I},ce=()=>{if(e.changed){let M;if(e.value!=null?M=e.value.trim():M="",F!=="string")try{M=JSON.parse(M)}catch{}l(x,P,M)}e.row=null,e.col=null,e.value=null,e.changed=!1},fe=M=>{e.value=M,e.changed=!0},pe=M=>{var B;(B=M==null?void 0:M.focus)==null||B.call(M)};return e.row===x&&e.col===P?c(ie,{ref:pe,modelValue:e.value,onInput:fe,onBlur:ce},null):c("div",{class:"table-v2-inline-editing-trigger",onClick:R,title:I},[I])}}));return m.unshift({title:"序号",dataKey:"index",key:"index",width:50,fixed:!0,cellRenderer:({rowIndex:d})=>c("span",{class:"_index"},[d+1])}),m}else return null}),n=z(_,500);function s(p){var u;let f=p.target;if(f.classList.contains("el-table-v2__row")||(f=f.closest(".el-table-v2__row")),f&&f.parentElement){const m=[].indexOf.call(f.parentElement.children,f),d=(u=f.closest(".el-table-v2__root"))==null?void 0:u.querySelectorAll("._index")[m];if(d){const E=Number.parseInt(d.textContent||"1")-1;y.emit("selectFeature",E)}}}function l(p,f,u){var d,E,k,x;const m=(E=(d=r.value)==null?void 0:d.features)==null?void 0:E[p];if(m){m.properties||(m.properties={});const P=(x=(k=o.value)==null?void 0:k[f])==null?void 0:x.dataKey;P&&(m.properties[P]=u)}r.value&&n(he(r.value))}function _(p){a||(a=!0,y.emit("updateEditor",p),a=!1)}function v(){a||y.emit("getGeoJson",p=>{r.value=p})}function h(p){return[...p.reduce((f,u)=>(Object.keys(u).forEach(m=>f.add(m)),f),new Set)]}return(p,f)=>{const u=Je,m=Ne,d=Fe;return g(o)?(S(),C("div",{key:0,"w-full":"",style:ge({height:p.height?`${p.height}px`:void 0})},[c(m,null,{default:b(({height:E,width:k})=>[c(u,{columns:g(o),data:g(i),width:k,height:E,fixed:"",onClick:s},null,8,["columns","data","width","height"])]),_:1})],4)):(S(),H(d,{key:1}))}}}),pt=A(ft,[["__scopeId","data-v-40ed404b"]]),dt={class:"layer-wrapper"},mt=["title"],_t=["title"],yt=T({__name:"AddService",setup(t){let r;const e=oe({count:0,name:"服务 1",url:"",type:"supermap_rest",layers:[]});V(()=>{y.emit("getMap",o=>{r=o})});function a(){const o=e.url,n=e.type,s=e.name;e.count++,e.name=`服务 ${e.count}`;let l;try{l=Ge(r,{name:s,type:n,url:o})}catch{se.error("添加服务失败");return}l&&e.layers.push({name:s,url:o,layer:l,id:Be()})}function i(o){var n;(n=e.layers[o])!=null&&n.layer&&(Ie(r,e.layers[o].layer),e.layers.splice(o,1))}return(o,n)=>{const s=le,l=$e,_=ie,v=Oe,h=Ve,p=Re,f=Te;return S(),C(N,null,[g(e).layers.length?(S(),C(N,{key:0},[G("div",dt,[(S(!0),C(N,null,re(g(e).layers,(u,m)=>(S(),C("div",{key:u.id,class:"layer-item"},[G("div",{class:"layer-item-title",title:u.name},K(u.name),9,mt),G("div",{class:"layer-item-url",title:u.url},K(u.url),9,_t),c(s,{onClick:d=>i(m)},{default:b(()=>[O(" 移除 ")]),_:2},1032,["onClick"])]))),128))]),c(l)],64)):ae("",!0),c(f,{colon:!1,class:"addService"},{default:b(()=>[c(v,{label:"服务名称"},{default:b(()=>[c(_,{modelValue:g(e).name,"onUpdate:modelValue":n[0]||(n[0]=u=>g(e).name=u)},null,8,["modelValue"])]),_:1}),c(v,{label:"服务地址"},{default:b(()=>[c(_,{modelValue:g(e).url,"onUpdate:modelValue":n[1]||(n[1]=u=>g(e).url=u)},null,8,["modelValue"])]),_:1}),c(v,{label:"服务类型"},{default:b(()=>[c(p,{modelValue:g(e).type,"onUpdate:modelValue":n[2]||(n[2]=u=>g(e).type=u)},{default:b(()=>[c(h,{value:"supermap_rest",label:"超图动态"}),c(h,{value:"supermap_tile",label:"超图切片"}),c(h,{value:"arcgis_rest",label:"ArcGIS 动态"}),c(h,{value:"arcgis_tile",label:"ArcGIS 切片"}),c(h,{value:"tms",label:"TMS"})]),_:1},8,["modelValue"])]),_:1}),c(v,{class:"formBtnItem"},{default:b(()=>[c(s,{type:"primary",onClick:a},{default:b(()=>[O(" 添加 ")]),_:1})]),_:1})]),_:1})],64)}}}),vt=A(yt,[["__scopeId","data-v-4dbebe0b"]]),gt={class:"controlMenu"},ht={__name:"ControlMenu",setup(t){function r(i){if(i.target.files.length){const o=i.target.files[0],n=new FileReader;n.onload=()=>{if(n.result&&typeof n.result=="string")try{const s=JSON.parse(n.result);y.emit("updateEditor",s),y.emit("updateGeojsonLayer",s)}catch{}},n.readAsText(o)}i.target.value=""}function e(){y.emit("getGeoJson",i=>{i?De(JSON.stringify(i),"exportFile.geojson"):se.warning("无可导出数据")})}function a(){y.emit("getGeoJson",i=>{if(i){const o=et(i);o<1e6?$.alert(`面积: ${o.toFixed(2)} 平方米`,"信息"):o<1e8?$.alert(`面积: ${(o/1e4).toFixed(2)} 公顷`,"信息"):$.alert(`面积: ${(o/1e6).toFixed(2)} 平方千米`,"信息")}})}return(i,o)=>{const n=le;return S(),C("div",gt,[te(G("input",{ref:"uploader",type:"file",accept:".json,.JSON,.geojson,.GEOJSON",onChange:r},null,544),[[ne,!1]]),c(n,{onClick:o[0]||(o[0]=s=>i.$refs.uploader.click())},{default:b(()=>[O(" 打开 ")]),_:1}),c(n,{onClick:e},{default:b(()=>[O(" 保存 ")]),_:1}),G("i",{class:"i-icon-park-outline-info",onClick:a})])}}},bt=A(ht,[["__scopeId","data-v-416b8397"]]),wt=T({__name:"geoJson",setup(t){const r=J("geoJson"),e=J(),a=q(()=>e.value?Number.parseFloat(getComputedStyle(e.value).height)-40:400);return(i,o)=>{const n=we,s=Ee;return S(),C("div",{ref_key:"wrapper",ref:e,class:"wrapper"},[c(lt),c(s,{modelValue:g(r),"onUpdate:modelValue":o[0]||(o[0]=l=>be(r)?r.value=l:null),type:"card"},{default:b(()=>[c(n,{name:"geoJson",label:"GeoJSON"},{default:b(()=>[c(ct)]),_:1}),c(n,{name:"table",label:"属性表"},{default:b(()=>[c(pt,{height:g(a)},null,8,["height"])]),_:1}),c(n,{name:"addService",label:"添加服务"},{default:b(()=>[c(vt)]),_:1})]),_:1},8,["modelValue"]),c(bt)],512)}}}),or=A(wt,[["__scopeId","data-v-baae8638"]]);export{or as default};
