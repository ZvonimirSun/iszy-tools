import{c0 as C,bS as b,dV as I,aS as G,Q as T,v as o,x as i,N as h,O as f,y as v,h as x,D as c,z as m,am as w,c9 as p,H as L,o as n}from"./index-5f28A1cg.js";import{b as S}from"./_baseRandom-CgWnUD7v.js";import{r as k}from"./range-J1Sv4g6V.js";import"./toFinite-DFIsh9Ao.js";function M(e,t){return C(t,function(a){return e[a]})}function P(e){return e==null?[]:M(e,b(e))}function y(e,t){var a=-1,l=e.length,d=l-1;for(t=t===void 0?l:t;++a<t;){var r=S(a,d),s=e[r];e[r]=e[a],e[a]=s}return e.length=t,e}function R(e){return y(I(e))}function B(e){return y(P(e))}function D(e){var t=G(e)?R:B;return t(e)}class g{static i=[[[0,0,0,0],[0,0,0,0],[1,1,1,1],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]]];static j=[[[1,0,0],[1,1,1],[0,0,0]],[[0,1,1],[0,1,0],[0,1,0]],[[0,0,0],[1,1,1],[0,0,1]],[[0,1,0],[0,1,0],[1,1,0]]];static l=[[[0,0,1],[1,1,1],[0,0,0]],[[0,1,0],[0,1,0],[0,1,1]],[[0,0,0],[1,1,1],[1,0,0]],[[1,1,0],[0,1,0],[0,1,0]]];static o=[[[0,0,0,0],[0,1,1,0],[0,1,1,0],[0,0,0,0]]];static s=[[[0,0,0],[0,1,1],[1,1,0]],[[0,1,0],[0,1,1],[0,0,1]]];static t=[[[0,1,0],[1,1,1],[0,0,0]],[[0,1,0],[0,1,1],[0,1,0]],[[0,0,0],[1,1,1],[0,1,0]],[[0,1,0],[1,1,0],[0,1,0]]];static z=[[[0,0,0],[1,1,0],[0,1,1]],[[0,0,1],[0,1,1],[0,1,0]]];static iLegend=[[0,0,0,0],[1,1,1,1]];static jLegend=[[1,0,0,0],[1,1,1,0]];static lLegend=[[0,0,1,0],[1,1,1,0]];static oLegend=[[0,1,1,0],[0,1,1,0]];static sLegend=[[0,1,1,0],[1,1,0,0]];static tLegend=[[0,1,0,0],[1,1,1,0]];static zLegend=[[1,1,0,0],[0,1,1,0]]}const _=["i","j","l","o","s","t","z"],K={name:"TetrisGame",data:()=>({inited:!1,gridCells:{col:10,row:20},matrix:null,rotate:0,position:null,currentTetrimino:null,nextTetrimino:null,tetriminosShuffle:[],score:0,lines:0,start:!1,end:!1,pause:!1,lock:!1,clearing:!1,clearIndexs:[],intervalID:void 0}),computed:{movable(){return this.start&&!this.end&&!this.clearing&&!this.pause},level(){return Math.ceil(this.lines/10)},nextTetriminoMatrixLegend(){return this.nextTetrimino?g[`${this.nextTetrimino}Legend`]:null},positions(){return this.currentTetrimino?this._getPositions(this._getRotatedMatrix(this.rotate),this.position):null},currentMatrix(){if(this.currentTetrimino){const e=p(this.matrix);for(const t of this.positions)t[0]>=0&&t[0]<this.gridCells.row&&t[1]>=0&&t[1]<this.gridCells.col&&(e[t[0]][t[1]]=this.currentTetrimino);return e}else return this.matrix},speed(){const e=this.level<=20?this.level:20;return 1e3*(.8-(e-1)*.007)**(e-1)},bestScore(){return L().modules.tetris.bestScore}},mounted(){this.resetGame(),this.getNextTetrimino(),this.addListener(),this.inited=!0},beforeUnmount(){this.removeListener()},methods:{playGame(){this.start||(this.score=0,this.lines=0,this.getNextTetrimino(),this.start=!0,this.intervalID=setInterval(()=>{this.clearing||this.moveDown()},this.speed))},resetGame(){clearInterval(this.intervalID);const e=Array.from({length:this.gridCells.row});for(const t of k(this.gridCells.row))e[t]=Array.from({length:this.gridCells.col}).fill("");this.matrix=e,this.rotate=0,this.resetPosition(),this.currentTetrimino=void 0,this.start=!1,this.end=!1,this.pause=!1,this.lock=!1,this.clearing=!1},pauseGame(e){e?this.lock=!0:e===!1&&(this.lock=!1),this.start&&(this.lock===!1||e)&&(this.pause?(this.pause=!this.pause,this.intervalID=setInterval(()=>{this.clearing||this.moveDown()},this.speed)):(this.pause=!this.pause,clearInterval(this.intervalID)))},resetPosition(){this.rotate=0,this.position=[0,Math.ceil(this.gridCells.col/2)]},updateMatrix(){if(this.start){for(const t of this.positions)t[0]<0&&(this.end=!0);if(this.matrix=p(this.currentMatrix),this.end){this.pauseGame(!0),this.clearIndexs=[];for(const t of k(this.gridCells.row))this.clearIndexs.push(t);setTimeout(()=>{this.score>this.bestScore&&this.setBestScore(this.score),this.clearIndexs=[],this.resetGame()},600);return}this.score+=4;const e=[];for(const t in this.matrix)this.matrix[t].filter(l=>l==="").length===0&&e.push(Number.parseInt(t));if(e.length>0){this.clearing=!0,this.pauseGame(!0),this.clearIndexs=e;const t=p(this.matrix);for(let l=this.clearIndexs.length-1;l>=0;l--)t.splice(this.clearIndexs[l],1);const a=Array.from({length:this.clearIndexs.length});for(const l of k(this.clearIndexs.length))a[l]=Array.from({length:this.gridCells.col}).fill("");setTimeout(()=>{switch(this.lines+=this.clearIndexs.length,this.clearIndexs.length){case 1:this.score+=40*this.level;break;case 2:this.score+=100*this.level;break;case 3:this.score+=300*this.level;break;case 4:this.score+=1200*this.level;break}this.clearIndexs=[],this.matrix=[...a,...t],this.getNextTetrimino(),this.resetPosition(),this.clearing=!1,this.pauseGame(!1)},600)}else this.getNextTetrimino(),this.resetPosition()}},getNextTetrimino(){this.currentTetrimino=this.nextTetrimino,this.tetriminosShuffle.length<=7&&(this.tetriminosShuffle=this.tetriminosShuffle.concat(D(_))),this.nextTetrimino=this.tetriminosShuffle.shift()},rotateRight(){this.movable&&!this._hasConflict(this._getPositions(this._getRotatedMatrix(this.rotate-1),this.position))&&this.rotate++},rotateLeft(){this.movable&&!this._hasConflict(this._getPositions(this._getRotatedMatrix(this.rotate-1),this.position))&&this.rotate--},moveLeft(){this.movable&&!this._hasConflict(this._getPositions(this._getRotatedMatrix(this.rotate),[this.position[0],this.position[1]-1]))&&this.position[1]--},moveRight(){this.movable&&!this._hasConflict(this._getPositions(this._getRotatedMatrix(this.rotate),[this.position[0],this.position[1]+1]))&&this.position[1]++},moveDown(){this.movable&&(this._hasConflict(this._getPositions(this._getRotatedMatrix(this.rotate),[this.position[0]+1,this.position[1]]))?this.updateMatrix():this.position[0]++)},moveBottom(){if(this.movable){let e=0;for(;!this._hasConflict(this._getPositions(this._getRotatedMatrix(this.rotate),[this.position[0]+e+1,this.position[1]]));)e++;this.position[0]+=e,this.updateMatrix()}},addListener(){document.addEventListener("keydown",this._keyboardEvent.bind(this))},removeListener(){document.removeEventListener("keydown",this._keyboardEvent.bind(this))},_getRotatedMatrix(e){let t=e%g[this.currentTetrimino].length;return t<0&&(t+=g[this.currentTetrimino].length),g[this.currentTetrimino][t]},_getPositions(e,t){const a=[];for(let l=0;l<e.length;l++)for(let d=0;d<e[l].length;d++)if(e[l][d]===1)switch(this.currentTetrimino){case"i":case"o":a.push([t[0]-2+l,t[1]-2+d]);break;case"j":case"l":case"t":a.push([t[0]-1+l,t[1]-1+d]);break;case"s":case"z":a.push([t[0]-2+l,t[1]-1+d]);break;default:return null}return a},_keyboardEvent(e){if(!(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey))switch(e.code){case"Space":this.start?(this.pause&&this.pauseGame(),this.moveBottom()):this.playGame();break;case"KeyW":case"KeyE":case"ArrowUp":this.pause&&this.pauseGame(),this.rotateRight();break;case"KeyQ":this.pause&&this.pauseGame(),this.rotateLeft();break;case"KeyS":case"ArrowDown":this.pause&&this.pauseGame(),this.moveDown();break;case"KeyA":case"ArrowLeft":this.pause&&this.pauseGame(),this.moveLeft();break;case"KeyD":case"ArrowRight":this.pause&&this.pauseGame(),this.moveRight();break;case"KeyP":this.pauseGame();break;case"KeyR":this.start?this.resetGame():this.playGame();break}},_hasConflict(e){for(const t of e){if(t[0]>=this.gridCells.row||t[1]<0||t[1]>=this.gridCells.col)return!0;if(t[0]>=0&&this.matrix[t[0]][t[1]]!=="")return!0}return!1},setBestScore(e){w().modules.tetris.bestScore=e}}},A={class:"gamePanel"},N={class:"tetrisPanel"},E={class:"tetrisMainPanel"},V={key:1,class:"tetrisCell"},U={class:"otherPanel"},j={class:"infoPanel"},z={class:"info"},F={class:"digital"},Q={class:"info"},H={class:"digital"},O={class:"info"},W={class:"digital"},q={class:"info"},J={class:"digital"},X={class:"nextTetrimino"},Y={key:1,class:"tetrisCell"},Z={class:"controlPanel"};function $(e,t,a,l,d,r){return n(),o("div",null,[i("div",A,[i("div",N,[(n(!0),o(h,null,f(e.gridCells.col*2+e.gridCells.row*2+4,s=>(n(),o("div",{key:`tetrisFrameGrid${s}`,class:"tetrisCell tetrisCellGrid"}))),128)),i("div",E,[e.inited?(n(!0),o(h,{key:0},f(e.gridCells.row,s=>(n(),o(h,{key:s},[(n(!0),o(h,null,f(e.gridCells.col,u=>(n(),o(h,{key:u},[r.currentMatrix[s-1][u-1]?(n(),o("div",{key:0,class:x(["tetrisCell",[`tetrisCellColor-${r.currentMatrix[s-1][u-1]}`,e.clearIndexs.includes(s-1)?"blink":""]])},null,2)):(n(),o("div",V))],64))),128))],64))),128)):v("",!0)])]),i("div",U,[i("div",j,[i("div",z,[t[9]||(t[9]=c(" 最高分: ",-1)),i("span",F,m(r.bestScore),1)]),i("div",Q,[e.start?v("",!0):(n(),o(h,{key:0},[c(" 上轮 ")],64)),t[10]||(t[10]=c(" 得分: ",-1)),i("span",H,m(e.score),1)]),i("div",O,[t[11]||(t[11]=c(" 消除行: ",-1)),i("span",W,m(e.lines),1)]),i("div",q,[t[12]||(t[12]=c(" 级别: ",-1)),i("span",J,m(r.level),1)]),t[13]||(t[13]=i("div",{class:"info"}," 下一个 ",-1)),i("div",X,[e.inited?(n(),o(h,{key:0},f(2,s=>(n(),o(h,{key:s},[(n(),o(h,null,f(4,u=>(n(),o(h,{key:u},[r.nextTetriminoMatrixLegend[s-1][u-1]?(n(),o("div",{key:0,class:x(["tetrisCell",[`tetrisCellColor-${e.nextTetrimino}`]])},null,2)):(n(),o("div",Y))],64))),64))],64))),64)):v("",!0)])]),i("div",Z,[i("div",{class:"controlButton pause",onClick:t[0]||(t[0]=(...s)=>r.pauseGame&&r.pauseGame(...s))}),t[14]||(t[14]=i("div",{class:"pause controlInfo"}," 暂停P ",-1)),e.start?(n(),o("div",{key:0,class:"controlButton restart",onClick:t[1]||(t[1]=(...s)=>r.resetGame&&r.resetGame(...s))})):(n(),o("div",{key:1,class:"controlButton restart",onClick:t[2]||(t[2]=(...s)=>r.playGame&&r.playGame(...s))})),t[15]||(t[15]=i("div",{class:"controlInfo restart"}," 重玩R ",-1)),e.start?(n(),o("div",{key:2,class:"controlButton drop",onClick:t[3]||(t[3]=(...s)=>r.moveBottom&&r.moveBottom(...s))})):(n(),o("div",{key:3,class:"controlButton drop",onClick:t[4]||(t[4]=(...s)=>r.playGame&&r.playGame(...s))})),t[16]||(t[16]=i("div",{class:"controlInfo drop"}," 掉落Space ",-1)),i("div",{class:"controlButton up",onClick:t[5]||(t[5]=(...s)=>r.rotateRight&&r.rotateRight(...s))}),t[17]||(t[17]=i("div",{class:"controlInfo up"}," 旋转 ",-1)),i("div",{class:"controlButton left",onClick:t[6]||(t[6]=(...s)=>r.moveLeft&&r.moveLeft(...s))}),t[18]||(t[18]=i("div",{class:"controlInfo left"}," 左移 ",-1)),i("div",{class:"controlButton right",onClick:t[7]||(t[7]=(...s)=>r.moveRight&&r.moveRight(...s))}),t[19]||(t[19]=i("div",{class:"controlInfo right"}," 右移 ",-1)),i("div",{class:"controlButton down",onClick:t[8]||(t[8]=(...s)=>r.moveDown&&r.moveDown(...s))}),t[20]||(t[20]=i("div",{class:"controlInfo down"}," 下移 ",-1))])])])])}const rt=T(K,[["render",$],["__scopeId","data-v-169a89e6"]]);export{rt as default};
