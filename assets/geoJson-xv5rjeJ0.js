import{a as N,U as H,J as O,v as M,N as J,y as Q,C as u,j as h,x as S,O as Y,w as b,L as Z,E as W,D as I,aq as ee,z as D,o as E,Q as G,a7 as te,ad as ne,aU as V,aV as $,a0 as re,g as K,I as A,Z as le,c as U,n as ue,ag as ce,M as pe}from"./index-BoNn7WOZ.js";import{E as fe,a as de}from"./el-tab-pane-BBJxJVSY.js";import{a as me,E as ye}from"./el-form-item-BpTdFNXJ.js";/* empty css               */import{a as ge,E as _e}from"./el-select-7lGfN0BH.js";import"./el-popper-CgaO_ntC.js";import{E as he}from"./el-divider-D3TDik-d.js";import{L as ve,l as x}from"./leaflet-nvyg8OnX.js";import{a as be,r as we,c as Ee,b as Me,d as ke}from"./mapUtils-e6H4OxdZ.js";import{v as Se}from"./Router-BPQGutwA.js";import{c as Ce}from"./createFile-_M0tjsRb.js";import{V as Le}from"./VanillaJsonEditor-DUNt3ZH2.js";import{u as Pe}from"./useComponentRef-ByAWXt_H.js";import{E as xe,a as Ge}from"./el-descriptions-item-BWlpqQNe.js";import{E as Fe}from"./el-empty-DdHdrqRW.js";import{E as Je,a as Ae}from"./el-table-v2-C1Xo3oRM.js";import"./raf-B0TKDovK.js";import"./strings-gBoXEhJm.js";import"./clamp-BJ3uq2P0.js";import"./omit-dupsm8f2.js";import"./last-D-rYfuUG.js";import"./castArray-DeslAH6K.js";import"./clone-hiGAHnMk.js";import"./index-Dg-mWOmT.js";import"./_baseIteratee-CGvQl9LK.js";import"./index-DWvp0sS1.js";import"./index-B4JAOyGy.js";import"./index-Dh1wW2BN.js";import"./el-dialog-DhUfJJ51.js";import"./el-space-Cupc8dPo.js";import"./jse-theme-dark-Dd-_C1p5.js";import"./memoize-one.esm-BdPwpGay.js";import"./index-D5mNNbb_.js";import"./index-Vcq4gwWv.js";import"./map-DLZM5RXe.js";import"./_baseEach-BE8Tyb0C.js";import"./range-B2GaVmYZ.js";import"./toFinite-CnWYSOEk.js";import"./_castFunction-B6SZI6RA.js";import"./formatBytes-aAslYXQD.js";class y{static _events=new Map;static on(n,e){if(n&&typeof e=="function"){const r=this._events.get(n);r?r.push(e):this._events.set(n,[e])}}static off(n,e){const r=this._events.get(n);if(r)if(typeof e=="function"){for(let o=r.length-1;o>=0;o--)e===r[o]&&r.splice(o,1);r.length===0&&this._events.delete(n)}else this._events.delete(n)}static emit(n,...e){const r=this._events.get(n);if(r)for(const o of r)o(...e)}}var w=63710088e-1,Ie={centimeters:w*100,centimetres:w*100,degrees:360/(2*Math.PI),feet:w*3.28084,inches:w*39.37,kilometers:w/1e3,kilometres:w/1e3,meters:w,metres:w,miles:w/1609.344,millimeters:w*1e3,millimetres:w*1e3,nauticalmiles:w/1852,radians:1,yards:w*1.0936};function oe(t,n,e={}){const r={type:"Feature"};return(e.id===0||e.id)&&(r.id=e.id),e.bbox&&(r.bbox=e.bbox),r.properties=n||{},r.geometry=t,r}function Ne(t,n,e={}){if(!t)throw new Error("coordinates is required");if(!Array.isArray(t))throw new Error("coordinates must be an Array");if(t.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!z(t[0])||!z(t[1]))throw new Error("coordinates must contain numbers");return oe({type:"Point",coordinates:t},n,e)}function Oe(t,n,e={}){for(const o of t){if(o.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");if(o[o.length-1].length!==o[0].length)throw new Error("First and last Position are not equivalent.");for(let a=0;a<o[o.length-1].length;a++)if(o[o.length-1][a]!==o[0][a])throw new Error("First and last Position are not equivalent.")}return oe({type:"Polygon",coordinates:t},n,e)}function Re(t,n="kilometers"){const e=Ie[n];if(!e)throw new Error(n+" units is invalid");return t/e}function q(t){return t%(2*Math.PI)*180/Math.PI}function T(t){return t%360*Math.PI/180}function z(t){return!isNaN(t)&&t!==null&&!Array.isArray(t)}function Ve(t){if(!t)throw new Error("coord is required");if(!Array.isArray(t)){if(t.type==="Feature"&&t.geometry!==null&&t.geometry.type==="Point")return[...t.geometry.coordinates];if(t.type==="Point")return[...t.coordinates]}if(Array.isArray(t)&&t.length>=2&&!Array.isArray(t[0])&&!Array.isArray(t[1]))return[...t];throw new Error("coord must be GeoJSON Point or an Array of numbers")}function Te(t,n,e,r={}){const o=Ve(t),a=T(o[0]),s=T(o[1]),i=T(e),p=Re(n,r.units),g=Math.asin(Math.sin(s)*Math.cos(p)+Math.cos(s)*Math.sin(p)*Math.cos(i)),_=a+Math.atan2(Math.sin(i)*Math.sin(p)*Math.cos(s),Math.cos(p)-Math.sin(s)*Math.sin(g)),v=q(_),m=q(g);return Ne([v,m],r.properties)}function Be(t,n){var e,r,o,a,s,i,p,g,_,v,m=0,d=t.type==="FeatureCollection",l=t.type==="Feature",c=d?t.features.length:1;for(e=0;e<c;e++){for(i=d?t.features[e].geometry:l?t.geometry:t,g=d?t.features[e].properties:l?t.properties:{},_=d?t.features[e].bbox:l?t.bbox:void 0,v=d?t.features[e].id:l?t.id:void 0,p=i?i.type==="GeometryCollection":!1,s=p?i.geometries.length:1,o=0;o<s;o++){if(a=p?i.geometries[o]:i,a===null){if(n(null,m,g,_,v)===!1)return!1;continue}switch(a.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":{if(n(a,m,g,_,v)===!1)return!1;break}case"GeometryCollection":{for(r=0;r<a.geometries.length;r++)if(n(a.geometries[r],m,g,_,v)===!1)return!1;break}default:throw new Error("Unknown Geometry Type")}}m++}}function De(t,n,e){var r=e;return Be(t,function(o,a,s,i,p){a===0&&e===void 0?r=o:r=n(r,o,a,s,i,p)}),r}function $e(t){return De(t,(n,e)=>n+Ue(e),0)}function Ue(t){let n=0,e;switch(t.type){case"Polygon":return j(t.coordinates);case"MultiPolygon":for(e=0;e<t.coordinates.length;e++)n+=j(t.coordinates[e]);return n;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":return 0}return 0}function j(t){let n=0;if(t&&t.length>0){n+=Math.abs(X(t[0]));for(let e=1;e<t.length;e++)n-=Math.abs(X(t[e]))}return n}var Ke=w*w/2,B=Math.PI/180;function X(t){const n=t.length-1;if(n<=2)return 0;let e=0,r=0;for(;r<n;){const o=t[r],a=t[r+1===n?0:r+1],s=t[r+2>=n?(r+2)%n:r+2],i=o[0]*B,p=a[1]*B,g=s[0]*B;e+=(g-i)*Math.sin(p),r++}return e*Ke}function qe(t,n,e={}){const r=e.steps||64,o=e.properties?e.properties:!Array.isArray(t)&&t.type==="Feature"&&t.properties?t.properties:{},a=[];for(let s=0;s<r;s++)a.push(Te(t,n,s*-360/r,e).geometry.coordinates);return a.push(a[0]),Oe([a],o)}function ze(t,{onChange:n}){t.on("pm:change",({layer:e})=>{n(e)})}function je(t,n,{onCreate:e,onRemove:r,onChange:o}={}){t.pm||ve.PM.reInitLayer(t),t.pm.setLang("zh"),t.pm.setGlobalOptions({layerGroup:n}),t.pm.addControls({position:"topright",drawCircleMarker:!1,drawText:!1,rotateMode:!0}),e&&(t.on("pm:create",({shape:s,layer:i})=>{a({shape:s,layer:i}),e(i)}),t.on("pm:cut",({layer:s})=>{a({layer:s}),e(s)})),r&&t.on("pm:remove",({layer:s})=>{r(s)}),o&&(t.on("pm:create",({shape:s,layer:i})=>{a({shape:s,layer:i}),o(i)}),t.on("pm:cut",({layer:s})=>{o(s)}),t.on("pm:remove",({layer:s})=>{o(s)}));function a({shape:s,layer:i}){if(s==="Circle"){const p=i,g=p.getLatLng(),_=p.getRadius();n.addData(qe([g.lng,g.lat],_/1e3))}else n.addData(i.toGeoJSON());n.removeLayer(i)}}function Xe({geojson:t,onEachFeature:n,pointToLayer:e}={}){return x.geoJSON(t,{onEachFeature:n,pointToLayer:e??He})}function He(t,n){return x.marker(n)}const Qe={class:"layer-wrapper"},Ye=["title"],Ze=["title"],We=N({__name:"AddService",setup(t){let n;const e=H({count:0,name:"服务 1",url:"",type:"supermap_rest",layers:[]});O(()=>{y.emit("getMap",a=>{n=a})});function r(){const a=e.url,s=e.type,i=e.name;e.count++,e.name=`服务 ${e.count}`;let p;try{p=be(n,{name:i,type:s,url:a})}catch{ee.error("添加服务失败");return}p&&e.layers.push({name:i,url:a,layer:p,id:Se()})}function o(a){e.layers[a]?.layer&&(we(n,e.layers[a].layer),e.layers.splice(a,1))}return(a,s)=>{const i=W,p=he,g=Z,_=ye,v=_e,m=ge,d=me;return E(),M(J,null,[h(e).layers.length?(E(),M(J,{key:0},[S("div",Qe,[(E(!0),M(J,null,Y(h(e).layers,(l,c)=>(E(),M("div",{key:l.id,class:"layer-item"},[S("div",{class:"layer-item-title",title:l.name},D(l.name),9,Ye),S("div",{class:"layer-item-url",title:l.url},D(l.url),9,Ze),u(i,{onClick:f=>o(c)},{default:b(()=>[...s[3]||(s[3]=[I(" 移除 ",-1)])]),_:1},8,["onClick"])]))),128))]),u(p)],64)):Q("",!0),u(d,{colon:!1,class:"addService"},{default:b(()=>[u(_,{label:"服务名称"},{default:b(()=>[u(g,{modelValue:h(e).name,"onUpdate:modelValue":s[0]||(s[0]=l=>h(e).name=l)},null,8,["modelValue"])]),_:1}),u(_,{label:"服务地址"},{default:b(()=>[u(g,{modelValue:h(e).url,"onUpdate:modelValue":s[1]||(s[1]=l=>h(e).url=l)},null,8,["modelValue"])]),_:1}),u(_,{label:"服务类型"},{default:b(()=>[u(m,{modelValue:h(e).type,"onUpdate:modelValue":s[2]||(s[2]=l=>h(e).type=l)},{default:b(()=>[u(v,{value:"supermap_rest",label:"超图动态"}),u(v,{value:"supermap_tile",label:"超图切片"}),u(v,{value:"arcgis_rest",label:"ArcGIS 动态"}),u(v,{value:"arcgis_tile",label:"ArcGIS 切片"}),u(v,{value:"tms",label:"TMS"})]),_:1},8,["modelValue"])]),_:1}),u(_,{class:"formBtnItem"},{default:b(()=>[u(i,{type:"primary",onClick:r},{default:b(()=>[...s[4]||(s[4]=[I(" 添加 ",-1)])]),_:1})]),_:1})]),_:1})],64)}}}),et=G(We,[["__scopeId","data-v-92b9f3b9"]]),tt={class:"controlMenu"},nt={__name:"ControlMenu",setup(t){function n(o){if(o.target.files.length){const a=o.target.files[0],s=new FileReader;s.onload=()=>{if(s.result&&typeof s.result=="string")try{const i=JSON.parse(s.result);y.emit("updateEditor",i),y.emit("updateGeojsonLayer",i)}catch{}},s.readAsText(a)}o.target.value=""}function e(){y.emit("getGeoJson",o=>{o?Ce(JSON.stringify(o),"exportFile.geojson"):ee.warning("无可导出数据")})}function r(){y.emit("getGeoJson",o=>{if(o){const a=$e(o);a<1e6?V.alert(`面积: ${a.toFixed(2)} 平方米`,"信息"):a<1e8?V.alert(`面积: ${(a/1e4).toFixed(2)} 公顷`,"信息"):V.alert(`面积: ${(a/1e6).toFixed(2)} 平方千米`,"信息")}})}return(o,a)=>{const s=W;return E(),M("div",tt,[te(S("input",{ref:"uploader",type:"file",accept:".json,.JSON,.geojson,.GEOJSON",onChange:n},null,544),[[ne,!1]]),u(s,{onClick:a[0]||(a[0]=i=>o.$refs.uploader.click())},{default:b(()=>[...a[1]||(a[1]=[I(" 打开 ",-1)])]),_:1}),u(s,{onClick:e},{default:b(()=>[...a[2]||(a[2]=[I(" 保存 ",-1)])]),_:1}),S("i",{class:"i-icon-park-outline-info",onClick:r})])}}},rt=G(nt,[["__scopeId","data-v-f5de7732"]]),ot=N({__name:"Editor",setup(t){const n=Pe();let e={type:"FeatureCollection",features:[]};const r=$(s,500);O(()=>{y.on("updateEditor",r)}),re(()=>{y.off("updateEditor",r)});const o=$(a,500);function a(i){try{typeof i=="string"?e=JSON.parse(i):e=i,y.emit("updateGeojsonLayer",e)}catch{}}function s(i){n.value?.update(i)}return(i,p)=>(E(),K(Le,{ref_key:"editor",ref:n,class:"edit-data-json",config:{mode:"text"},content:h(e),onChange:h(o)},null,8,["content","onChange"]))}}),at=G(ot,[["__scopeId","data-v-f3d70d49"]]),st={key:0,class:"content"},it=N({__name:"MainMap",setup(t){const n=new x.Icon.Default,e=new x.Icon.Default({iconUrl:"marker-icon-yellow.png",iconRetinaUrl:"marker-icon-2x-yellow.png"});let r,o;const a=A(),s=A(),i=A();O(()=>{y.on("getMap",p),y.on("updateGeojsonLayer",v),y.on("getGeoJson",m),y.on("selectFeature",l),g()}),re(()=>{y.off("getMap",p),y.off("updateGeojsonLayer",v),y.off("getGeoJson",m),y.off("selectFeature",l),o&&o.remove()});function p(){return o}function g(){s.value&&(o=Ee({dom:s.value,view:{center:[35,105],zoom:4}}),Me(o),r=Xe({onEachFeature:_}).addTo(o),ke(o,{name:"图形",layer:r}),je(o,r,{onChange(){d()}}))}function _(c,f){ze(f,{onChange:()=>{d()}}),c.properties||(c.properties={}),i.value&&f.bindPopup(i.value).on("popupopen",()=>{a.value=c,o.hasLayer(f)&&(f instanceof x.Marker?f.setIcon(e):f.setStyle({color:"#ffff00",weight:5,opacity:.65}))}).on("popupclose",()=>{a.value=void 0,o.hasLayer(f)&&(f instanceof x.Marker?f.setIcon(n):r.resetStyle(f))})}function v(c){r.clearLayers();try{r.addData(c),o.fitBounds(r.getBounds())}catch{}}function m(c){c(r?.toGeoJSON())}function d(){r.getLayers().length===0?y.emit("updateEditor",{type:"FeatureCollection",features:[]}):y.emit("updateEditor",r.toGeoJSON())}function l(c){if(r.getLayers().length>c){const f=r.getLayers()[c];f.openPopup(),o.fitBounds(f.getBounds())}}return(c,f)=>{const L=Ge,P=xe;return E(),M(J,null,[S("div",{ref_key:"mapContainer",ref:s,class:"map-container"},null,512),te(S("div",{ref_key:"propertyPopup",ref:i,class:"property-popup"},[f[0]||(f[0]=S("div",{class:"title"},[S("span",null,"属性")],-1)),h(a)?.properties&&Object.keys(h(a)?.properties).length?(E(),M("div",st,[u(P,{column:1,border:!0},{default:b(()=>[(E(!0),M(J,null,Y(h(a).properties,(C,F,R)=>(E(),K(L,{key:R,label:F.toString()},{default:b(()=>[I(D(C),1)]),_:2},1032,["label"]))),128))]),_:1})])):Q("",!0)],512),[[ne,!1]])],64)}}}),lt=G(it,[["__scopeId","data-v-09090af8"]]),ut=N({__name:"PropertyTable",props:{height:{default:null}},setup(t){O(()=>{y.on("updateGeojsonLayer",_),y.on("updateEditor",_)});const n=le(),e=H({row:null,col:null,value:null,changed:!1});let r=!1;const o=U(()=>n.value?.features?.length?n.value.features.map(m=>m.properties||{}):[]),a=U(()=>{if(n.value?.features?.length){const m=v(o.value);if(!m.length)return null;const d=m.map(l=>({title:l,dataKey:l,key:l,width:150,cellRenderer:({rowData:c,column:f,rowIndex:L,columnIndex:P})=>{let C,F;c[f.dataKey]!=null?(F=typeof c[f.dataKey],~["boolean","number","string"].indexOf(F)?C=c[f.dataKey].toString():C=JSON.stringify(c[f.dataKey])):C="";const R=()=>{e.row=L,e.col=P,e.value=C},ae=()=>{if(e.changed){let k;if(e.value!=null?k=e.value.trim():k="",F!=="string")try{k=JSON.parse(k)}catch{}p(L,P,k)}e.row=null,e.col=null,e.value=null,e.changed=!1},se=k=>{e.value=k,e.changed=!0},ie=k=>{k?.focus?.()};return e.row===L&&e.col===P?u(Z,{ref:ie,modelValue:e.value,onInput:se,onBlur:ae},null):u("div",{class:"table-v2-inline-editing-trigger",onClick:R,title:C},[C])}}));return d.unshift({title:"序号",dataKey:"index",key:"index",width:50,fixed:!0,cellRenderer:({rowIndex:l})=>u("span",{class:"_index"},[l+1])}),d}else return null}),s=$(g,500);function i(m){let d=m.target;if(d.classList.contains("el-table-v2__row")||(d=d.closest(".el-table-v2__row")),d&&d.parentElement){const l=[].indexOf.call(d.parentElement.children,d),c=d.closest(".el-table-v2__root")?.querySelectorAll("._index")[l];if(c){const f=Number.parseInt(c.textContent||"1")-1;y.emit("selectFeature",f)}}}function p(m,d,l){const c=n.value?.features?.[m];if(c){c.properties||(c.properties={});const f=a.value?.[d]?.dataKey;f&&(c.properties[f]=l)}n.value&&s(ce(n.value))}function g(m){r||(r=!0,y.emit("updateEditor",m),r=!1)}function _(){r||y.emit("getGeoJson",m=>{n.value=m})}function v(m){return[...m.reduce((d,l)=>(Object.keys(l).forEach(c=>d.add(c)),d),new Set)]}return(m,d)=>{const l=Ae,c=Je,f=Fe;return h(a)?(E(),M("div",{key:0,"w-full":"",style:ue({height:t.height?`${t.height}px`:void 0})},[u(c,null,{default:b(({height:L,width:P})=>[u(l,{columns:h(a),data:h(o),width:P,height:L,fixed:"",onClick:i},null,8,["columns","data","width","height"])]),_:1})],4)):(E(),K(f,{key:1}))}}}),ct=G(ut,[["__scopeId","data-v-47823758"]]),pt=N({__name:"geoJson",setup(t){const n=A("geoJson"),e=A(),r=U(()=>e.value?Number.parseFloat(getComputedStyle(e.value).height)-40:400);return(o,a)=>{const s=fe,i=de;return E(),M("div",{ref_key:"wrapper",ref:e,class:"wrapper"},[u(lt),u(i,{modelValue:h(n),"onUpdate:modelValue":a[0]||(a[0]=p=>pe(n)?n.value=p:null),type:"card"},{default:b(()=>[u(s,{name:"geoJson",label:"GeoJSON"},{default:b(()=>[u(at)]),_:1}),u(s,{name:"table",label:"属性表"},{default:b(()=>[u(ct,{height:h(r)},null,8,["height"])]),_:1}),u(s,{name:"addService",label:"添加服务"},{default:b(()=>[u(et)]),_:1})]),_:1},8,["modelValue"]),u(rt)],512)}}}),Wt=G(pt,[["__scopeId","data-v-d74242be"]]);export{Wt as default};
