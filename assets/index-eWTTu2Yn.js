var I=Object.defineProperty;var x=(e,t,h)=>t in e?I(e,t,{enumerable:!0,configurable:!0,writable:!0,value:h}):e[t]=h;var c=(e,t,h)=>(x(e,typeof t!="symbol"?t+"":t,h),h);import{v as b}from"./common-jZmGe4Rr.js";import{ad as G,b0 as _,am as k,bS as w,c as r,a as s,F as d,e as g,g as y,W as v,t as p,o as a,d as C,aO as L,aP as P}from"./vendor-e_qgH4qe.js";class n{}c(n,"i",[[[0,0,0,0],[0,0,0,0],[1,1,1,1],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]]]),c(n,"j",[[[1,0,0],[1,1,1],[0,0,0]],[[0,1,1],[0,1,0],[0,1,0]],[[0,0,0],[1,1,1],[0,0,1]],[[0,1,0],[0,1,0],[1,1,0]]]),c(n,"l",[[[0,0,1],[1,1,1],[0,0,0]],[[0,1,0],[0,1,0],[0,1,1]],[[0,0,0],[1,1,1],[1,0,0]],[[1,1,0],[0,1,0],[0,1,0]]]),c(n,"o",[[[0,0,0,0],[0,1,1,0],[0,1,1,0],[0,0,0,0]]]),c(n,"s",[[[0,0,0],[0,1,1],[1,1,0]],[[0,1,0],[0,1,1],[0,0,1]]]),c(n,"t",[[[0,1,0],[1,1,1],[0,0,0]],[[0,1,0],[0,1,1],[0,1,0]],[[0,0,0],[1,1,1],[0,1,0]],[[0,1,0],[1,1,0],[0,1,0]]]),c(n,"z",[[[0,0,0],[1,1,0],[0,1,1]],[[0,0,1],[0,1,1],[0,1,0]]]),c(n,"iLegend",[[0,0,0,0],[1,1,1,1]]),c(n,"jLegend",[[1,0,0,0],[1,1,1,0]]),c(n,"lLegend",[[0,0,1,0],[1,1,1,0]]),c(n,"oLegend",[[0,1,1,0],[0,1,1,0]]),c(n,"sLegend",[[0,1,1,0],[1,1,0,0]]),c(n,"tLegend",[[0,1,0,0],[1,1,1,0]]),c(n,"zLegend",[[1,1,0,0],[0,1,1,0]]);const S=["i","j","l","o","s","t","z"],R={name:"TetrisGame",data:()=>({inited:!1,gridCells:{col:10,row:20},matrix:null,rotate:0,position:null,currentTetrimino:null,nextTetrimino:null,tetriminosShuffle:[],score:0,lines:0,start:!1,end:!1,pause:!1,lock:!1,clearing:!1,clearIndexs:[],intervalID:void 0}),computed:{movable:function(){return this.start&&!this.end&&!this.clearing&&!this.pause},level:function(){return Math.ceil(this.lines/10)},nextTetriminoMatrixLegend:function(){return this.nextTetrimino?n[this.nextTetrimino+"Legend"]:null},positions:function(){return this.currentTetrimino?this._getPositions(this._getRotatedMatrix(this.rotate),this.position):null},currentMatrix:function(){if(this.currentTetrimino){const e=_(this.matrix);for(const t of this.positions)t[0]>=0&&t[0]<this.gridCells.row&&t[1]>=0&&t[1]<this.gridCells.col&&(e[t[0]][t[1]]=this.currentTetrimino);return e}else return this.matrix},speed:function(){const e=this.level<=20?this.level:20;return 1e3*(.8-(e-1)*.007)**(e-1)},bestScore:function(){return b().modules.tetris.bestScore}},mounted(){this.resetGame(),this.getNextTetrimino(),this.addListener(),this.inited=!0},beforeUnmount(){this.removeListener()},methods:{playGame(){this.start||(this.score=0,this.lines=0,this.getNextTetrimino(),this.start=!0,this.intervalID=setInterval(()=>{this.clearing||this.moveDown()},this.speed))},resetGame(){clearInterval(this.intervalID);const e=Array(this.gridCells.row);for(const t of k(this.gridCells.row))e[t]=Array(this.gridCells.col).fill("");this.matrix=e,this.rotate=0,this.resetPosition(),this.currentTetrimino=void 0,this.start=!1,this.end=!1,this.pause=!1,this.lock=!1,this.clearing=!1},pauseGame(e){e?this.lock=!0:e===!1&&(this.lock=!1),this.start&&(this.lock===!1||e)&&(this.pause?(this.pause=!this.pause,this.intervalID=setInterval(()=>{this.clearing||this.moveDown()},this.speed)):(this.pause=!this.pause,clearInterval(this.intervalID)))},resetPosition(){this.rotate=0,this.position=[0,Math.ceil(this.gridCells.col/2)]},updateMatrix(){if(this.start){for(const t of this.positions)t[0]<0&&(this.end=!0);if(this.matrix=_(this.currentMatrix),this.end){this.pauseGame(!0),this.clearIndexs=[];for(const t of k(this.gridCells.row))this.clearIndexs.push(t);setTimeout(()=>{this.score>this.bestScore&&this.setBestScore(this.score),this.clearIndexs=[],this.resetGame()},600);return}this.score+=4;const e=[];for(const t in this.matrix)this.matrix[t].filter(l=>l==="").length===0&&e.push(parseInt(t));if(e.length>0){this.clearing=!0,this.pauseGame(!0),this.clearIndexs=e;const t=_(this.matrix);for(let l=this.clearIndexs.length-1;l>=0;l--)t.splice(this.clearIndexs[l],1);const h=Array(this.clearIndexs.length);for(const l of k(this.clearIndexs.length))h[l]=Array(this.gridCells.col).fill("");setTimeout(()=>{switch(this.lines+=this.clearIndexs.length,this.clearIndexs.length){case 1:this.score+=40*this.level;break;case 2:this.score+=100*this.level;break;case 3:this.score+=300*this.level;break;case 4:this.score+=1200*this.level;break}this.clearIndexs=[],this.matrix=[...h,...t],this.getNextTetrimino(),this.resetPosition(),this.clearing=!1,this.pauseGame(!1)},600)}else this.getNextTetrimino(),this.resetPosition()}},getNextTetrimino(){this.currentTetrimino=this.nextTetrimino,this.tetriminosShuffle.length<=7&&(this.tetriminosShuffle=this.tetriminosShuffle.concat(w(S))),this.nextTetrimino=this.tetriminosShuffle.shift()},rotateRight(){this.movable&&!this._hasConflict(this._getPositions(this._getRotatedMatrix(this.rotate-1),this.position))&&this.rotate++},rotateLeft(){this.movable&&!this._hasConflict(this._getPositions(this._getRotatedMatrix(this.rotate-1),this.position))&&this.rotate--},moveLeft(){this.movable&&!this._hasConflict(this._getPositions(this._getRotatedMatrix(this.rotate),[this.position[0],this.position[1]-1]))&&this.position[1]--},moveRight(){this.movable&&!this._hasConflict(this._getPositions(this._getRotatedMatrix(this.rotate),[this.position[0],this.position[1]+1]))&&this.position[1]++},moveDown(){this.movable&&(this._hasConflict(this._getPositions(this._getRotatedMatrix(this.rotate),[this.position[0]+1,this.position[1]]))?this.updateMatrix():this.position[0]++)},moveBottom(){if(this.movable){let e=0;for(;!this._hasConflict(this._getPositions(this._getRotatedMatrix(this.rotate),[this.position[0]+e+1,this.position[1]]));)e++;this.position[0]+=e,this.updateMatrix()}},addListener(){document.addEventListener("keydown",this._keyboardEvent.bind(this))},removeListener(){document.removeEventListener("keydown",this._keyboardEvent.bind(this))},_getRotatedMatrix(e){let t=e%n[this.currentTetrimino].length;return t<0&&(t+=n[this.currentTetrimino].length),n[this.currentTetrimino][t]},_getPositions(e,t){const h=[];for(let l=0;l<e.length;l++)for(let f=0;f<e[l].length;f++)if(e[l][f]===1)switch(this.currentTetrimino){case"i":case"o":h.push([t[0]-2+l,t[1]-2+f]);break;case"j":case"l":case"t":h.push([t[0]-1+l,t[1]-1+f]);break;case"s":case"z":h.push([t[0]-2+l,t[1]-1+f]);break;default:return null}return h},_keyboardEvent(e){if(!(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey))switch(e.code){case"Space":this.start?(this.pause&&this.pauseGame(),this.moveBottom()):this.playGame();break;case"KeyW":case"KeyE":case"ArrowUp":this.pause&&this.pauseGame(),this.rotateRight();break;case"KeyQ":this.pause&&this.pauseGame(),this.rotateLeft();break;case"KeyS":case"ArrowDown":this.pause&&this.pauseGame(),this.moveDown();break;case"KeyA":case"ArrowLeft":this.pause&&this.pauseGame(),this.moveLeft();break;case"KeyD":case"ArrowRight":this.pause&&this.pauseGame(),this.moveRight();break;case"KeyP":this.pauseGame();break;case"KeyR":this.start?this.resetGame():this.playGame();break}},_hasConflict(e){for(const t of e){if(t[0]>=this.gridCells.row||t[1]<0||t[1]>=this.gridCells.col)return!0;if(t[0]>=0&&this.matrix[t[0]][t[1]]!=="")return!0}return!1},setBestScore(e){b().modules.tetris.bestScore=e}}},u=e=>(L("data-v-3891317f"),e=e(),P(),e),B={class:"gamePanel"},D={class:"tetrisPanel"},T={class:"tetrisMainPanel"},K={key:1,class:"tetrisCell"},A={class:"otherPanel"},N={class:"infoPanel"},E={class:"info"},M={class:"digital"},z={class:"info"},j={class:"digital"},F={class:"info"},U={class:"digital"},V={class:"info"},W={class:"digital"},O=u(()=>s("div",{class:"info"}," 下一个 ",-1)),Q={class:"nextTetrimino"},q={key:1,class:"tetrisCell"},H={class:"controlPanel"},J=u(()=>s("div",{class:"controlInfo pause"}," 暂停P ",-1)),X=u(()=>s("div",{class:"controlInfo restart"}," 重玩R ",-1)),Y=u(()=>s("div",{class:"controlInfo drop"}," 掉落Space ",-1)),Z=u(()=>s("div",{class:"controlInfo up"}," 旋转 ",-1)),$=u(()=>s("div",{class:"controlInfo left"}," 左移 ",-1)),tt=u(()=>s("div",{class:"controlInfo right"}," 右移 ",-1)),et=u(()=>s("div",{class:"controlInfo down"}," 下移 ",-1));function st(e,t,h,l,f,o){return a(),r("div",null,[s("div",B,[s("div",D,[(a(!0),r(d,null,g(e.gridCells.col*2+e.gridCells.row*2+4,i=>(a(),r("div",{key:"tetrisFrameGrid"+i,class:C(["tetrisCell","tetrisCellGrid"])}))),128)),s("div",T,[e.inited?(a(!0),r(d,{key:0},g(e.gridCells.row,i=>(a(),r(d,{key:i},[(a(!0),r(d,null,g(e.gridCells.col,m=>(a(),r(d,{key:m},[o.currentMatrix[i-1][m-1]?(a(),r("div",{key:0,class:C(["tetrisCell","tetrisCellColor-"+o.currentMatrix[i-1][m-1],e.clearIndexs.includes(i-1)?"blink":""])},null,2)):(a(),r("div",K))],64))),128))],64))),128)):y("",!0)])]),s("div",A,[s("div",N,[s("div",E,[v(" 最高分: "),s("span",M,p(o.bestScore),1)]),s("div",z,[e.start?y("",!0):(a(),r(d,{key:0},[v(" 上轮 ")],64)),v(" 得分: "),s("span",j,p(e.score),1)]),s("div",F,[v(" 消除行: "),s("span",U,p(e.lines),1)]),s("div",V,[v(" 级别: "),s("span",W,p(o.level),1)]),O,s("div",Q,[e.inited?(a(),r(d,{key:0},g(2,i=>(a(),r(d,{key:i},[(a(),r(d,null,g(4,m=>(a(),r(d,{key:m},[o.nextTetriminoMatrixLegend[i-1][m-1]?(a(),r("div",{key:0,class:C(["tetrisCell","tetrisCellColor-"+e.nextTetrimino])},null,2)):(a(),r("div",q))],64))),64))],64))),64)):y("",!0)])]),s("div",H,[s("div",{class:"controlButton pause",onClick:t[0]||(t[0]=(...i)=>o.pauseGame&&o.pauseGame(...i))}),J,e.start?(a(),r("div",{key:0,class:"controlButton restart",onClick:t[1]||(t[1]=(...i)=>o.resetGame&&o.resetGame(...i))})):(a(),r("div",{key:1,class:"controlButton restart",onClick:t[2]||(t[2]=(...i)=>o.playGame&&o.playGame(...i))})),X,e.start?(a(),r("div",{key:2,class:"controlButton drop",onClick:t[3]||(t[3]=(...i)=>o.moveBottom&&o.moveBottom(...i))})):(a(),r("div",{key:3,class:"controlButton drop",onClick:t[4]||(t[4]=(...i)=>o.playGame&&o.playGame(...i))})),Y,s("div",{class:"controlButton up",onClick:t[5]||(t[5]=(...i)=>o.rotateRight&&o.rotateRight(...i))}),Z,s("div",{class:"controlButton left",onClick:t[6]||(t[6]=(...i)=>o.moveLeft&&o.moveLeft(...i))}),$,s("div",{class:"controlButton right",onClick:t[7]||(t[7]=(...i)=>o.moveRight&&o.moveRight(...i))}),tt,s("div",{class:"controlButton down",onClick:t[8]||(t[8]=(...i)=>o.moveDown&&o.moveDown(...i))}),et])])])])}const at=G(R,[["render",st],["__scopeId","data-v-3891317f"]]);export{at as default};
