var y=Object.defineProperty;var _=(e,t,r)=>t in e?y(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var d=(e,t,r)=>(_(e,typeof t!="symbol"?t+"":t,r),r);import{aw as E,a4 as I,b5 as M,cM as B,a6 as D,_ as G,j as z,k as p,o as s,m as n,q as l,F as h,p as v,n as k,y as b,b as u,bz as L,bA as R,x as w}from"./index.82f4337f.js";import{t as C}from"./toFinite.060ef74d.js";import{b as A}from"./_baseRandom.67e4faa9.js";function S(e,t){return E(t,function(r){return e[r]})}function T(e){return e==null?[]:S(e,I(e))}var H=Math.ceil,Z=Math.max;function j(e,t,r,i){for(var m=-1,a=Z(H((t-e)/(r||1)),0),o=Array(a);a--;)o[i?a:++m]=e,e+=r;return o}function K(e){return function(t,r,i){return i&&typeof i!="number"&&M(t,r,i)&&(r=i=void 0),t=C(t),r===void 0?(r=t,t=0):r=C(r),i=i===void 0?t<r?1:-1:C(i),j(t,r,i,e)}}var V=K(),P=V;function x(e,t){var r=-1,i=e.length,m=i-1;for(t=t===void 0?i:t;++r<t;){var a=A(r,m),o=e[a];e[a]=e[r],e[r]=o}return e.length=t,e}function Y(e){return x(B(e))}function N(e){return x(T(e))}function F(e){var t=D(e)?Y:N;return t(e)}class c{}d(c,"i",[[[0,0,0,0],[0,0,0,0],[1,1,1,1],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]]]),d(c,"j",[[[1,0,0],[1,1,1],[0,0,0]],[[0,1,1],[0,1,0],[0,1,0]],[[0,0,0],[1,1,1],[0,0,1]],[[0,1,0],[0,1,0],[1,1,0]]]),d(c,"l",[[[0,0,1],[1,1,1],[0,0,0]],[[0,1,0],[0,1,0],[0,1,1]],[[0,0,0],[1,1,1],[1,0,0]],[[1,1,0],[0,1,0],[0,1,0]]]),d(c,"o",[[[0,0,0,0],[0,1,1,0],[0,1,1,0],[0,0,0,0]]]),d(c,"s",[[[0,0,0],[0,1,1],[1,1,0]],[[0,1,0],[0,1,1],[0,0,1]]]),d(c,"t",[[[0,1,0],[1,1,1],[0,0,0]],[[0,1,0],[0,1,1],[0,1,0]],[[0,0,0],[1,1,1],[0,1,0]],[[0,1,0],[1,1,0],[0,1,0]]]),d(c,"z",[[[0,0,0],[1,1,0],[0,1,1]],[[0,0,1],[0,1,1],[0,1,0]]]),d(c,"iLegend",[[0,0,0,0],[1,1,1,1]]),d(c,"jLegend",[[1,0,0,0],[1,1,1,0]]),d(c,"lLegend",[[0,0,1,0],[1,1,1,0]]),d(c,"oLegend",[[0,1,1,0],[0,1,1,0]]),d(c,"sLegend",[[0,1,1,0],[1,1,0,0]]),d(c,"tLegend",[[0,1,0,0],[1,1,1,0]]),d(c,"zLegend",[[1,1,0,0],[0,1,1,0]]);const{mapGetters:U,mapActions:q}=z("tetris"),Q=["i","j","l","o","s","t","z"],W={name:"TetrisGame",data:()=>({inited:!1,gridCells:{col:10,row:20},matrix:null,rotate:0,position:null,currentTetrimino:null,nextTetrimino:null,tetriminosShuffle:[],score:0,lines:0,start:!1,end:!1,pause:!1,lock:!1,clearing:!1,clearIndexs:[],intervalID:void 0}),computed:{movable:function(){return this.start&&!this.end&&!this.clearing&&!this.pause},level:function(){return Math.ceil(this.lines/10)},nextTetriminoMatrixLegend:function(){return this.nextTetrimino?c[this.nextTetrimino+"Legend"]:null},positions:function(){return this.currentTetrimino?this._getPositions(this._getRotatedMatrix(this.rotate),this.position):null},currentMatrix:function(){if(this.currentTetrimino){const e=p(this.matrix);for(const t of this.positions)t[0]>=0&&t[0]<this.gridCells.row&&t[1]>=0&&t[1]<this.gridCells.col&&(e[t[0]][t[1]]=this.currentTetrimino);return e}else return this.matrix},speed:function(){const e=this.level<=20?this.level:20;return 1e3*(.8-(e-1)*.007)**(e-1)},...U(["bestScore"])},mounted(){this.resetGame(),this.getNextTetrimino(),this.addListener(),this.inited=!0},beforeUnmount(){this.removeListener()},methods:{playGame(){this.start||(this.score=0,this.lines=0,this.getNextTetrimino(),this.start=!0,this.intervalID=setInterval(()=>{this.clearing||this.moveDown()},this.speed))},resetGame(){clearInterval(this.intervalID);const e=Array(this.gridCells.row);for(const t of P(this.gridCells.row))e[t]=Array(this.gridCells.col).fill("");this.matrix=e,this.rotate=0,this.resetPosition(),this.currentTetrimino=void 0,this.start=!1,this.end=!1,this.pause=!1,this.lock=!1,this.clearing=!1},pauseGame(e){e?this.lock=!0:e===!1&&(this.lock=!1),this.start&&(this.lock===!1||e)&&(this.pause?(this.pause=!this.pause,this.intervalID=setInterval(()=>{this.clearing||this.moveDown()},this.speed)):(this.pause=!this.pause,clearInterval(this.intervalID)))},resetPosition(){this.rotate=0,this.position=[0,Math.ceil(this.gridCells.col/2)]},updateMatrix(){if(this.start){for(const t of this.positions)t[0]<0&&(this.end=!0);if(this.matrix=p(this.currentMatrix),this.end){this.pauseGame(!0),this.clearIndexs=[];for(const t of P(this.gridCells.row))this.clearIndexs.push(t);setTimeout(()=>{this.score>this.bestScore&&this.setBestScore(this.score),this.clearIndexs=[],this.resetGame()},600);return}this.score+=4;const e=[];for(const t in this.matrix)this.matrix[t].filter(i=>i==="").length===0&&e.push(parseInt(t));if(e.length>0){this.clearing=!0,this.pauseGame(!0),this.clearIndexs=e;const t=p(this.matrix);for(let i=this.clearIndexs.length-1;i>=0;i--)t.splice(this.clearIndexs[i],1);const r=Array(this.clearIndexs.length);for(const i of P(this.clearIndexs.length))r[i]=Array(this.gridCells.col).fill("");setTimeout(()=>{switch(this.lines+=this.clearIndexs.length,this.clearIndexs.length){case 1:this.score+=40*this.level;break;case 2:this.score+=100*this.level;break;case 3:this.score+=300*this.level;break;case 4:this.score+=1200*this.level;break}this.clearIndexs=[],this.matrix=[...r,...t],this.getNextTetrimino(),this.resetPosition(),this.clearing=!1,this.pauseGame(!1)},600)}else this.getNextTetrimino(),this.resetPosition()}},getNextTetrimino(){this.currentTetrimino=this.nextTetrimino,this.tetriminosShuffle.length<=7&&(this.tetriminosShuffle=this.tetriminosShuffle.concat(F(Q))),this.nextTetrimino=this.tetriminosShuffle.shift()},rotateRight(){this.movable&&!this._hasConflict(this._getPositions(this._getRotatedMatrix(this.rotate-1),this.position))&&this.rotate++},rotateLeft(){this.movable&&!this._hasConflict(this._getPositions(this._getRotatedMatrix(this.rotate-1),this.position))&&this.rotate--},moveLeft(){this.movable&&!this._hasConflict(this._getPositions(this._getRotatedMatrix(this.rotate),[this.position[0],this.position[1]-1]))&&this.position[1]--},moveRight(){this.movable&&!this._hasConflict(this._getPositions(this._getRotatedMatrix(this.rotate),[this.position[0],this.position[1]+1]))&&this.position[1]++},moveDown(){this.movable&&(this._hasConflict(this._getPositions(this._getRotatedMatrix(this.rotate),[this.position[0]+1,this.position[1]]))?this.updateMatrix():this.position[0]++)},moveBottom(){if(this.movable){let e=0;for(;!this._hasConflict(this._getPositions(this._getRotatedMatrix(this.rotate),[this.position[0]+e+1,this.position[1]]));)e++;this.position[0]+=e,this.updateMatrix()}},addListener(){document.addEventListener("keydown",this._keyboardEvent.bind(this))},removeListener(){document.removeEventListener("keydown",this._keyboardEvent.bind(this))},_getRotatedMatrix(e){let t=e%c[this.currentTetrimino].length;return t<0&&(t+=c[this.currentTetrimino].length),c[this.currentTetrimino][t]},_getPositions(e,t){const r=[];for(let i=0;i<e.length;i++)for(let m=0;m<e[i].length;m++)if(e[i][m]===1)switch(this.currentTetrimino){case"i":case"o":r.push([t[0]-2+i,t[1]-2+m]);break;case"j":case"l":case"t":r.push([t[0]-1+i,t[1]-1+m]);break;case"s":case"z":r.push([t[0]-2+i,t[1]-1+m]);break;default:return null}return r},_keyboardEvent(e){if(!(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey))switch(e.code){case"Space":this.start?(this.pause&&this.pauseGame(),this.moveBottom()):this.playGame();break;case"KeyW":case"KeyE":case"ArrowUp":this.pause&&this.pauseGame(),this.rotateRight();break;case"KeyQ":this.pause&&this.pauseGame(),this.rotateLeft();break;case"KeyS":case"ArrowDown":this.pause&&this.pauseGame(),this.moveDown();break;case"KeyA":case"ArrowLeft":this.pause&&this.pauseGame(),this.moveLeft();break;case"KeyD":case"ArrowRight":this.pause&&this.pauseGame(),this.moveRight();break;case"KeyP":this.pauseGame();break;case"KeyR":this.start?this.resetGame():this.playGame();break}},_hasConflict(e){for(const t of e){if(t[0]>=this.gridCells.row||t[1]<0||t[1]>=this.gridCells.col)return!0;if(t[0]>=0&&this.matrix[t[0]][t[1]]!=="")return!0}return!1},...q(["setBestScore"])}},f=e=>(L("data-v-5e32622f"),e=e(),R(),e),J={class:"gamePanel"},O={class:"tetrisPanel"},X={class:"tetrisMainPanel"},$={key:1,class:"tetrisCell"},ee={class:"otherPanel"},te={class:"infoPanel"},re={class:"info"},oe=u(" \u6700\u9AD8\u5206: "),ie={class:"digital"},ae={class:"info"},le=u(" \u4E0A\u8F6E "),se=u(" \u5F97\u5206: "),ne={class:"digital"},ce={class:"info"},de=u(" \u6D88\u9664\u884C: "),me={class:"digital"},he={class:"info"},fe=u(" \u7EA7\u522B: "),ge={class:"digital"},ve=f(()=>l("div",{class:"info"}," \u4E0B\u4E00\u4E2A ",-1)),ue={class:"nextTetrimino"},be={key:1,class:"tetrisCell"},pe={class:"controlPanel"},ke=f(()=>l("div",{class:"controlInfo pause"}," \u6682\u505CP ",-1)),we=f(()=>l("div",{class:"controlInfo restart"}," \u91CD\u73A9R ",-1)),Ce=f(()=>l("div",{class:"controlInfo drop"}," \u6389\u843DSpace ",-1)),Pe=f(()=>l("div",{class:"controlInfo up"}," \u65CB\u8F6C ",-1)),xe=f(()=>l("div",{class:"controlInfo left"}," \u5DE6\u79FB ",-1)),ye=f(()=>l("div",{class:"controlInfo right"}," \u53F3\u79FB ",-1)),_e=f(()=>l("div",{class:"controlInfo down"}," \u4E0B\u79FB ",-1));function Ee(e,t,r,i,m,a){return s(),n("div",null,[l("div",J,[l("div",O,[(s(!0),n(h,null,v(e.gridCells.col*2+e.gridCells.row*2+4,o=>(s(),n("div",{key:"tetrisFrameGrid"+o,class:w(["tetrisCell","tetrisCellGrid"])}))),128)),l("div",X,[e.inited?(s(!0),n(h,{key:0},v(e.gridCells.row,o=>(s(),n(h,{key:o},[(s(!0),n(h,null,v(e.gridCells.col,g=>(s(),n(h,{key:g},[a.currentMatrix[o-1][g-1]?(s(),n("div",{key:0,class:w(["tetrisCell","tetrisCellColor-"+a.currentMatrix[o-1][g-1],e.clearIndexs.includes(o-1)?"blink":""])},null,2)):(s(),n("div",$))],64))),128))],64))),128)):k("",!0)])]),l("div",ee,[l("div",te,[l("div",re,[oe,l("span",ie,b(e.bestScore),1)]),l("div",ae,[e.start?k("",!0):(s(),n(h,{key:0},[le],64)),se,l("span",ne,b(e.score),1)]),l("div",ce,[de,l("span",me,b(e.lines),1)]),l("div",he,[fe,l("span",ge,b(a.level),1)]),ve,l("div",ue,[e.inited?(s(),n(h,{key:0},v(2,o=>(s(),n(h,{key:o},[(s(),n(h,null,v(4,g=>(s(),n(h,{key:g},[a.nextTetriminoMatrixLegend[o-1][g-1]?(s(),n("div",{key:0,class:w(["tetrisCell","tetrisCellColor-"+e.nextTetrimino])},null,2)):(s(),n("div",be))],64))),64))],64))),64)):k("",!0)])]),l("div",pe,[l("div",{class:"controlButton pause",onClick:t[0]||(t[0]=(...o)=>a.pauseGame&&a.pauseGame(...o))}),ke,e.start?(s(),n("div",{key:0,class:"controlButton restart",onClick:t[1]||(t[1]=(...o)=>a.resetGame&&a.resetGame(...o))})):(s(),n("div",{key:1,class:"controlButton restart",onClick:t[2]||(t[2]=(...o)=>a.playGame&&a.playGame(...o))})),we,e.start?(s(),n("div",{key:2,class:"controlButton drop",onClick:t[3]||(t[3]=(...o)=>a.moveBottom&&a.moveBottom(...o))})):(s(),n("div",{key:3,class:"controlButton drop",onClick:t[4]||(t[4]=(...o)=>a.playGame&&a.playGame(...o))})),Ce,l("div",{class:"controlButton up",onClick:t[5]||(t[5]=(...o)=>a.rotateRight&&a.rotateRight(...o))}),Pe,l("div",{class:"controlButton left",onClick:t[6]||(t[6]=(...o)=>a.moveLeft&&a.moveLeft(...o))}),xe,l("div",{class:"controlButton right",onClick:t[7]||(t[7]=(...o)=>a.moveRight&&a.moveRight(...o))}),ye,l("div",{class:"controlButton down",onClick:t[8]||(t[8]=(...o)=>a.moveDown&&a.moveDown(...o))}),_e])])])])}var Ge=G(W,[["render",Ee],["__scopeId","data-v-5e32622f"]]);export{Ge as default};
