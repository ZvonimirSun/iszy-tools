var I=Object.defineProperty;var x=(t,e,o)=>e in t?I(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o;var c=(t,e,o)=>x(t,typeof e!="symbol"?e+"":e,o);import{bV as w,bO as G,dD as L,d as S,a2 as P,b6 as _,Q as R,aw as B,F as a,G as i,X as d,Y as g,H as k,L as v,I as p,o as n,n as C,a0 as D,a1 as T}from"./index-CQU3zzuo.js";import{r as y}from"./range-Dj_f6Kfe.js";import{b as K}from"./_baseRandom-CgWnUD7v.js";import"./toFinite-DSDSQeOu.js";function A(t,e){return w(e,function(o){return t[o]})}function N(t){return t==null?[]:A(t,G(t))}function b(t,e){var o=-1,l=t.length,u=l-1;for(e=e===void 0?l:e;++o<e;){var r=K(o,u),s=t[r];t[r]=t[o],t[o]=s}return t.length=e,t}function M(t){return b(L(t))}function E(t){return b(N(t))}function V(t){var e=S(t)?M:E;return e(t)}class h{}c(h,"i",[[[0,0,0,0],[0,0,0,0],[1,1,1,1],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]]]),c(h,"j",[[[1,0,0],[1,1,1],[0,0,0]],[[0,1,1],[0,1,0],[0,1,0]],[[0,0,0],[1,1,1],[0,0,1]],[[0,1,0],[0,1,0],[1,1,0]]]),c(h,"l",[[[0,0,1],[1,1,1],[0,0,0]],[[0,1,0],[0,1,0],[0,1,1]],[[0,0,0],[1,1,1],[1,0,0]],[[1,1,0],[0,1,0],[0,1,0]]]),c(h,"o",[[[0,0,0,0],[0,1,1,0],[0,1,1,0],[0,0,0,0]]]),c(h,"s",[[[0,0,0],[0,1,1],[1,1,0]],[[0,1,0],[0,1,1],[0,0,1]]]),c(h,"t",[[[0,1,0],[1,1,1],[0,0,0]],[[0,1,0],[0,1,1],[0,1,0]],[[0,0,0],[1,1,1],[0,1,0]],[[0,1,0],[1,1,0],[0,1,0]]]),c(h,"z",[[[0,0,0],[1,1,0],[0,1,1]],[[0,0,1],[0,1,1],[0,1,0]]]),c(h,"iLegend",[[0,0,0,0],[1,1,1,1]]),c(h,"jLegend",[[1,0,0,0],[1,1,1,0]]),c(h,"lLegend",[[0,0,1,0],[1,1,1,0]]),c(h,"oLegend",[[0,1,1,0],[0,1,1,0]]),c(h,"sLegend",[[0,1,1,0],[1,1,0,0]]),c(h,"tLegend",[[0,1,0,0],[1,1,1,0]]),c(h,"zLegend",[[1,1,0,0],[0,1,1,0]]);const F=["i","j","l","o","s","t","z"],U={name:"TetrisGame",data:()=>({inited:!1,gridCells:{col:10,row:20},matrix:null,rotate:0,position:null,currentTetrimino:null,nextTetrimino:null,tetriminosShuffle:[],score:0,lines:0,start:!1,end:!1,pause:!1,lock:!1,clearing:!1,clearIndexs:[],intervalID:void 0}),computed:{movable(){return this.start&&!this.end&&!this.clearing&&!this.pause},level(){return Math.ceil(this.lines/10)},nextTetriminoMatrixLegend(){return this.nextTetrimino?h[`${this.nextTetrimino}Legend`]:null},positions(){return this.currentTetrimino?this._getPositions(this._getRotatedMatrix(this.rotate),this.position):null},currentMatrix(){if(this.currentTetrimino){const t=_(this.matrix);for(const e of this.positions)e[0]>=0&&e[0]<this.gridCells.row&&e[1]>=0&&e[1]<this.gridCells.col&&(t[e[0]][e[1]]=this.currentTetrimino);return t}else return this.matrix},speed(){const t=this.level<=20?this.level:20;return 1e3*(.8-(t-1)*.007)**(t-1)},bestScore(){return R().modules.tetris.bestScore}},mounted(){this.resetGame(),this.getNextTetrimino(),this.addListener(),this.inited=!0},beforeUnmount(){this.removeListener()},methods:{playGame(){this.start||(this.score=0,this.lines=0,this.getNextTetrimino(),this.start=!0,this.intervalID=setInterval(()=>{this.clearing||this.moveDown()},this.speed))},resetGame(){clearInterval(this.intervalID);const t=Array.from({length:this.gridCells.row});for(const e of y(this.gridCells.row))t[e]=Array.from({length:this.gridCells.col}).fill("");this.matrix=t,this.rotate=0,this.resetPosition(),this.currentTetrimino=void 0,this.start=!1,this.end=!1,this.pause=!1,this.lock=!1,this.clearing=!1},pauseGame(t){t?this.lock=!0:t===!1&&(this.lock=!1),this.start&&(this.lock===!1||t)&&(this.pause?(this.pause=!this.pause,this.intervalID=setInterval(()=>{this.clearing||this.moveDown()},this.speed)):(this.pause=!this.pause,clearInterval(this.intervalID)))},resetPosition(){this.rotate=0,this.position=[0,Math.ceil(this.gridCells.col/2)]},updateMatrix(){if(this.start){for(const e of this.positions)e[0]<0&&(this.end=!0);if(this.matrix=_(this.currentMatrix),this.end){this.pauseGame(!0),this.clearIndexs=[];for(const e of y(this.gridCells.row))this.clearIndexs.push(e);setTimeout(()=>{this.score>this.bestScore&&this.setBestScore(this.score),this.clearIndexs=[],this.resetGame()},600);return}this.score+=4;const t=[];for(const e in this.matrix)this.matrix[e].filter(l=>l==="").length===0&&t.push(Number.parseInt(e));if(t.length>0){this.clearing=!0,this.pauseGame(!0),this.clearIndexs=t;const e=_(this.matrix);for(let l=this.clearIndexs.length-1;l>=0;l--)e.splice(this.clearIndexs[l],1);const o=Array.from({length:this.clearIndexs.length});for(const l of y(this.clearIndexs.length))o[l]=Array.from({length:this.gridCells.col}).fill("");setTimeout(()=>{switch(this.lines+=this.clearIndexs.length,this.clearIndexs.length){case 1:this.score+=40*this.level;break;case 2:this.score+=100*this.level;break;case 3:this.score+=300*this.level;break;case 4:this.score+=1200*this.level;break}this.clearIndexs=[],this.matrix=[...o,...e],this.getNextTetrimino(),this.resetPosition(),this.clearing=!1,this.pauseGame(!1)},600)}else this.getNextTetrimino(),this.resetPosition()}},getNextTetrimino(){this.currentTetrimino=this.nextTetrimino,this.tetriminosShuffle.length<=7&&(this.tetriminosShuffle=this.tetriminosShuffle.concat(V(F))),this.nextTetrimino=this.tetriminosShuffle.shift()},rotateRight(){this.movable&&!this._hasConflict(this._getPositions(this._getRotatedMatrix(this.rotate-1),this.position))&&this.rotate++},rotateLeft(){this.movable&&!this._hasConflict(this._getPositions(this._getRotatedMatrix(this.rotate-1),this.position))&&this.rotate--},moveLeft(){this.movable&&!this._hasConflict(this._getPositions(this._getRotatedMatrix(this.rotate),[this.position[0],this.position[1]-1]))&&this.position[1]--},moveRight(){this.movable&&!this._hasConflict(this._getPositions(this._getRotatedMatrix(this.rotate),[this.position[0],this.position[1]+1]))&&this.position[1]++},moveDown(){this.movable&&(this._hasConflict(this._getPositions(this._getRotatedMatrix(this.rotate),[this.position[0]+1,this.position[1]]))?this.updateMatrix():this.position[0]++)},moveBottom(){if(this.movable){let t=0;for(;!this._hasConflict(this._getPositions(this._getRotatedMatrix(this.rotate),[this.position[0]+t+1,this.position[1]]));)t++;this.position[0]+=t,this.updateMatrix()}},addListener(){document.addEventListener("keydown",this._keyboardEvent.bind(this))},removeListener(){document.removeEventListener("keydown",this._keyboardEvent.bind(this))},_getRotatedMatrix(t){let e=t%h[this.currentTetrimino].length;return e<0&&(e+=h[this.currentTetrimino].length),h[this.currentTetrimino][e]},_getPositions(t,e){const o=[];for(let l=0;l<t.length;l++)for(let u=0;u<t[l].length;u++)if(t[l][u]===1)switch(this.currentTetrimino){case"i":case"o":o.push([e[0]-2+l,e[1]-2+u]);break;case"j":case"l":case"t":o.push([e[0]-1+l,e[1]-1+u]);break;case"s":case"z":o.push([e[0]-2+l,e[1]-1+u]);break;default:return null}return o},_keyboardEvent(t){if(!(t.altKey||t.ctrlKey||t.metaKey||t.shiftKey))switch(t.code){case"Space":this.start?(this.pause&&this.pauseGame(),this.moveBottom()):this.playGame();break;case"KeyW":case"KeyE":case"ArrowUp":this.pause&&this.pauseGame(),this.rotateRight();break;case"KeyQ":this.pause&&this.pauseGame(),this.rotateLeft();break;case"KeyS":case"ArrowDown":this.pause&&this.pauseGame(),this.moveDown();break;case"KeyA":case"ArrowLeft":this.pause&&this.pauseGame(),this.moveLeft();break;case"KeyD":case"ArrowRight":this.pause&&this.pauseGame(),this.moveRight();break;case"KeyP":this.pauseGame();break;case"KeyR":this.start?this.resetGame():this.playGame();break}},_hasConflict(t){for(const e of t){if(e[0]>=this.gridCells.row||e[1]<0||e[1]>=this.gridCells.col)return!0;if(e[0]>=0&&this.matrix[e[0]][e[1]]!=="")return!0}return!1},setBestScore(t){B().modules.tetris.bestScore=t}}},f=t=>(D("data-v-f3aa8138"),t=t(),T(),t),j={class:"gamePanel"},Q={class:"tetrisPanel"},z={class:"tetrisMainPanel"},H={key:1,class:"tetrisCell"},O={class:"otherPanel"},W={class:"infoPanel"},X={class:"info"},Y={class:"digital"},q={class:"info"},J={class:"digital"},Z={class:"info"},$={class:"digital"},tt={class:"info"},et={class:"digital"},st=f(()=>i("div",{class:"info"}," 下一个 ",-1)),it={class:"nextTetrimino"},rt={key:1,class:"tetrisCell"},ot={class:"controlPanel"},at=f(()=>i("div",{class:"pause controlInfo"}," 暂停P ",-1)),nt=f(()=>i("div",{class:"controlInfo restart"}," 重玩R ",-1)),lt=f(()=>i("div",{class:"controlInfo drop"}," 掉落Space ",-1)),ht=f(()=>i("div",{class:"controlInfo up"}," 旋转 ",-1)),ct=f(()=>i("div",{class:"controlInfo left"}," 左移 ",-1)),dt=f(()=>i("div",{class:"controlInfo right"}," 右移 ",-1)),ut=f(()=>i("div",{class:"controlInfo down"}," 下移 ",-1));function ft(t,e,o,l,u,r){return n(),a("div",null,[i("div",j,[i("div",Q,[(n(!0),a(d,null,g(t.gridCells.col*2+t.gridCells.row*2+4,s=>(n(),a("div",{key:`tetrisFrameGrid${s}`,class:"tetrisCell tetrisCellGrid"}))),128)),i("div",z,[t.inited?(n(!0),a(d,{key:0},g(t.gridCells.row,s=>(n(),a(d,{key:s},[(n(!0),a(d,null,g(t.gridCells.col,m=>(n(),a(d,{key:m},[r.currentMatrix[s-1][m-1]?(n(),a("div",{key:0,class:C(["tetrisCell",[`tetrisCellColor-${r.currentMatrix[s-1][m-1]}`,t.clearIndexs.includes(s-1)?"blink":""]])},null,2)):(n(),a("div",H))],64))),128))],64))),128)):k("",!0)])]),i("div",O,[i("div",W,[i("div",X,[v(" 最高分: "),i("span",Y,p(r.bestScore),1)]),i("div",q,[t.start?k("",!0):(n(),a(d,{key:0},[v(" 上轮 ")],64)),v(" 得分: "),i("span",J,p(t.score),1)]),i("div",Z,[v(" 消除行: "),i("span",$,p(t.lines),1)]),i("div",tt,[v(" 级别: "),i("span",et,p(r.level),1)]),st,i("div",it,[t.inited?(n(),a(d,{key:0},g(2,s=>(n(),a(d,{key:s},[(n(),a(d,null,g(4,m=>(n(),a(d,{key:m},[r.nextTetriminoMatrixLegend[s-1][m-1]?(n(),a("div",{key:0,class:C(["tetrisCell",[`tetrisCellColor-${t.nextTetrimino}`]])},null,2)):(n(),a("div",rt))],64))),64))],64))),64)):k("",!0)])]),i("div",ot,[i("div",{class:"controlButton pause",onClick:e[0]||(e[0]=(...s)=>r.pauseGame&&r.pauseGame(...s))}),at,t.start?(n(),a("div",{key:0,class:"controlButton restart",onClick:e[1]||(e[1]=(...s)=>r.resetGame&&r.resetGame(...s))})):(n(),a("div",{key:1,class:"controlButton restart",onClick:e[2]||(e[2]=(...s)=>r.playGame&&r.playGame(...s))})),nt,t.start?(n(),a("div",{key:2,class:"controlButton drop",onClick:e[3]||(e[3]=(...s)=>r.moveBottom&&r.moveBottom(...s))})):(n(),a("div",{key:3,class:"controlButton drop",onClick:e[4]||(e[4]=(...s)=>r.playGame&&r.playGame(...s))})),lt,i("div",{class:"controlButton up",onClick:e[5]||(e[5]=(...s)=>r.rotateRight&&r.rotateRight(...s))}),ht,i("div",{class:"controlButton left",onClick:e[6]||(e[6]=(...s)=>r.moveLeft&&r.moveLeft(...s))}),ct,i("div",{class:"controlButton right",onClick:e[7]||(e[7]=(...s)=>r.moveRight&&r.moveRight(...s))}),dt,i("div",{class:"controlButton down",onClick:e[8]||(e[8]=(...s)=>r.moveDown&&r.moveDown(...s))}),ut])])])])}const kt=P(U,[["render",ft],["__scopeId","data-v-f3aa8138"]]);export{kt as default};
