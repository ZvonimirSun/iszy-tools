var fe=Object.defineProperty;var de=(t,r,e)=>r in t?fe(t,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[r]=e;var X=(t,r,e)=>de(t,typeof r!="symbol"?r+"":r,e);import{j as T,R as J,T as R,ap as Z,o as S,F as C,G as L,am as ee,m as h,K as c,w as b,X as N,Y as te,l as j,L as O,I as U,H as re,as as ne,a0 as me,a1 as _e,a2 as I,b2 as q,aP as ye,a6 as oe,k as z,q as ge,$ as ae,au as he,aD as se,N as ie,b3 as B,W as ve}from"./index-len2DOAp.js";import{E as be,a as we}from"./el-tab-pane-DDmQ3btj.js";import{E as Ee,a as Me}from"./el-descriptions-item-ZTOvh3dw.js";import{l as x,L as Se}from"./leaflet-src-DHjHqmZG.js";import{c as ke,a as Ce,b as Pe,d as Ge,r as Le}from"./leaflet-geoman-Ckj5wH9P.js";import{V as Fe}from"./VanillaJsonEditor-DbdbukG9.js";import{u as xe}from"./useComponentRef-CulpIPJQ.js";import{E as Ie}from"./el-empty-BSZBJgDK.js";import{E as Ae,a as Je}from"./el-table-v2-BGHGADPj.js";import{a as Ne,E as Oe}from"./el-form-item-DPWEOm_H.js";/* empty css               */import{E as Te,a as Re}from"./el-select-AH9OtrYv.js";import"./el-popper-C99AQLKO.js";import{E as Ve}from"./el-divider-CRDlqbSc.js";import{v as $e}from"./Router-SOUowP8y.js";import{c as Be}from"./createFile-3QbkbLQZ.js";import"./strings-dQx4YNGq.js";import"./el-dialog-D334vWa2.js";import"./index-BF3_8Zu_.js";import"./isUndefined-DCTLXrZ8.js";import"./el-space-QbN_jEpJ.js";import"./jse-theme-dark-B9us-OB6.js";import"./memoize-one.esm-BdPwpGay.js";import"./index-BvpJkw56.js";import"./_baseSlice-icyMYoiK.js";import"./toFinite-DQu004uH.js";import"./range-Djp5jL-m.js";import"./map-CCYZqJz-.js";import"./_baseIteratee-t4ZODsgW.js";import"./_baseEach-DAGX6Rot.js";import"./_castFunction-CKV2NCNg.js";import"./formatBytes-aAslYXQD.js";import"./castArray-BUqJCIvV.js";import"./raf-DvPji2Ct.js";import"./index-BVm_oBHH.js";import"./index-Cd9gZ4dd.js";class _{static on(r,e){if(r&&typeof e=="function"){const n=this._events.get(r);n?n.push(e):this._events.set(r,[e])}}static off(r,e){const n=this._events.get(r);if(n)if(typeof e=="function"){for(let o=n.length-1;o>=0;o--)e===n[o]&&n.splice(o,1);n.length===0&&this._events.delete(r)}else this._events.delete(r)}static emit(r,...e){const n=this._events.get(r);if(n)for(const o of n)o(...e)}}X(_,"_events",new Map);function De({geojson:t,onEachFeature:r,pointToLayer:e}={}){return x.geoJSON(t,{onEachFeature:r,pointToLayer:e??Ke})}function Ke(t,r){return x.marker(r)}var w=63710088e-1,Ue={centimeters:w*100,centimetres:w*100,degrees:360/(2*Math.PI),feet:w*3.28084,inches:w*39.37,kilometers:w/1e3,kilometres:w/1e3,meters:w,metres:w,miles:w/1609.344,millimeters:w*1e3,millimetres:w*1e3,nauticalmiles:w/1852,radians:1,yards:w*1.0936};function le(t,r,e={}){const n={type:"Feature"};return(e.id===0||e.id)&&(n.id=e.id),e.bbox&&(n.bbox=e.bbox),n.properties=r||{},n.geometry=t,n}function qe(t,r,e={}){if(!t)throw new Error("coordinates is required");if(!Array.isArray(t))throw new Error("coordinates must be an Array");if(t.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!Y(t[0])||!Y(t[1]))throw new Error("coordinates must contain numbers");return le({type:"Point",coordinates:t},r,e)}function ze(t,r,e={}){for(const o of t){if(o.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");if(o[o.length-1].length!==o[0].length)throw new Error("First and last Position are not equivalent.");for(let a=0;a<o[o.length-1].length;a++)if(o[o.length-1][a]!==o[0][a])throw new Error("First and last Position are not equivalent.")}return le({type:"Polygon",coordinates:t},r,e)}function je(t,r="kilometers"){const e=Ue[r];if(!e)throw new Error(r+" units is invalid");return t/e}function H(t){return t%(2*Math.PI)*180/Math.PI}function D(t){return t%360*Math.PI/180}function Y(t){return!isNaN(t)&&t!==null&&!Array.isArray(t)}function Xe(t){if(!t)throw new Error("coord is required");if(!Array.isArray(t)){if(t.type==="Feature"&&t.geometry!==null&&t.geometry.type==="Point")return[...t.geometry.coordinates];if(t.type==="Point")return[...t.coordinates]}if(Array.isArray(t)&&t.length>=2&&!Array.isArray(t[0])&&!Array.isArray(t[1]))return[...t];throw new Error("coord must be GeoJSON Point or an Array of numbers")}function He(t,r,e,n={}){const o=Xe(t),a=D(o[0]),s=D(o[1]),i=D(e),l=je(r,n.units),y=Math.asin(Math.sin(s)*Math.cos(l)+Math.cos(s)*Math.sin(l)*Math.cos(i)),g=a+Math.atan2(Math.sin(i)*Math.sin(l)*Math.cos(s),Math.cos(l)-Math.sin(s)*Math.sin(y)),v=H(g),f=H(y);return qe([v,f],n.properties)}function Ye(t,r){var e,n,o,a,s,i,l,y,g,v,f=0,p=t.type==="FeatureCollection",u=t.type==="Feature",m=p?t.features.length:1;for(e=0;e<m;e++){for(i=p?t.features[e].geometry:u?t.geometry:t,y=p?t.features[e].properties:u?t.properties:{},g=p?t.features[e].bbox:u?t.bbox:void 0,v=p?t.features[e].id:u?t.id:void 0,l=i?i.type==="GeometryCollection":!1,s=l?i.geometries.length:1,o=0;o<s;o++){if(a=l?i.geometries[o]:i,a===null){if(r(null,f,y,g,v)===!1)return!1;continue}switch(a.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":{if(r(a,f,y,g,v)===!1)return!1;break}case"GeometryCollection":{for(n=0;n<a.geometries.length;n++)if(r(a.geometries[n],f,y,g,v)===!1)return!1;break}default:throw new Error("Unknown Geometry Type")}}f++}}function We(t,r,e){var n=e;return Ye(t,function(o,a,s,i,l){a===0&&e===void 0?n=o:n=r(n,o,a,s,i,l)}),n}function Qe(t){return We(t,(r,e)=>r+Ze(e),0)}function Ze(t){let r=0,e;switch(t.type){case"Polygon":return W(t.coordinates);case"MultiPolygon":for(e=0;e<t.coordinates.length;e++)r+=W(t.coordinates[e]);return r;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":return 0}return 0}function W(t){let r=0;if(t&&t.length>0){r+=Math.abs(Q(t[0]));for(let e=1;e<t.length;e++)r-=Math.abs(Q(t[e]))}return r}var et=w*w/2,K=Math.PI/180;function Q(t){const r=t.length-1;if(r<=2)return 0;let e=0,n=0;for(;n<r;){const o=t[n],a=t[n+1===r?0:n+1],s=t[n+2>=r?(n+2)%r:n+2],i=o[0]*K,l=a[1]*K,y=s[0]*K;e+=(y-i)*Math.sin(l),n++}return e*et}function tt(t,r,e={}){const n=e.steps||64,o=e.properties?e.properties:!Array.isArray(t)&&t.type==="Feature"&&t.properties?t.properties:{},a=[];for(let s=0;s<n;s++)a.push(He(t,r,s*-360/n,e).geometry.coordinates);return a.push(a[0]),ze([a],o)}function rt(t,{onChange:r}){t.on("pm:change",({layer:e})=>{r(e)})}function nt(t,r,{onCreate:e,onRemove:n,onChange:o}={}){t.pm||Se.PM.reInitLayer(t),t.pm.setLang("zh"),t.pm.setGlobalOptions({layerGroup:r}),t.pm.addControls({position:"topright",drawCircleMarker:!1,drawText:!1,rotateMode:!0}),e&&(t.on("pm:create",({shape:s,layer:i})=>{a({shape:s,layer:i}),e(i)}),t.on("pm:cut",({layer:s})=>{a({layer:s}),e(s)})),n&&t.on("pm:remove",({layer:s})=>{n(s)}),o&&(t.on("pm:create",({shape:s,layer:i})=>{a({shape:s,layer:i}),o(i)}),t.on("pm:cut",({layer:s})=>{o(s)}),t.on("pm:remove",({layer:s})=>{o(s)}));function a({shape:s,layer:i}){if(s==="Circle"){const l=i,y=l.getLatLng(),g=l.getRadius();r.addData(tt([y.lng,y.lat],g/1e3))}else r.addData(i.toGeoJSON());r.removeLayer(i)}}const ot=t=>(me("data-v-57bfadf3"),t=t(),_e(),t),at=ot(()=>L("div",{class:"title"},[L("span",null,"属性")],-1)),st={key:0,class:"content"},it=T({__name:"MainMap",setup(t){const r=new x.Icon.Default,e=new x.Icon.Default({iconUrl:"marker-icon-yellow.png",iconRetinaUrl:"marker-icon-2x-yellow.png"});let n,o;const a=J(),s=J(),i=J();R(()=>{_.on("getMap",l),_.on("updateGeojsonLayer",v),_.on("getGeoJson",f),_.on("selectFeature",u),y()}),Z(()=>{_.off("getMap",l),_.off("updateGeojsonLayer",v),_.off("getGeoJson",f),_.off("selectFeature",u),o&&o.remove()});function l(){return o}function y(){s.value&&(o=ke({dom:s.value,view:{center:[35,105],zoom:4}}),Ce(o),n=De({onEachFeature:g}).addTo(o),Pe(o,{name:"图形",layer:n}),nt(o,n,{onChange(){p()}}))}function g(m,d){rt(d,{onChange:()=>{p()}}),m.properties||(m.properties={}),i.value&&d.bindPopup(i.value).on("popupopen",()=>{a.value=m,o.hasLayer(d)&&(d instanceof x.Marker?d.setIcon(e):d.setStyle({color:"#ffff00",weight:5,opacity:.65}))}).on("popupclose",()=>{a.value=void 0,o.hasLayer(d)&&(d instanceof x.Marker?d.setIcon(r):n.resetStyle(d))})}function v(m){n.clearLayers();try{n.addData(m),o.fitBounds(n.getBounds())}catch{}}function f(m){m(n==null?void 0:n.toGeoJSON())}function p(){n.getLayers().length===0?_.emit("updateEditor",{type:"FeatureCollection",features:[]}):_.emit("updateEditor",n.toGeoJSON())}function u(m){if(n.getLayers().length>m){const d=n.getLayers()[m];d.openPopup(),o.fitBounds(d.getBounds())}}return(m,d)=>{var P,G;const E=Ee,k=Me;return S(),C(N,null,[L("div",{ref_key:"mapContainer",ref:s,class:"map-container"},null,512),ee(L("div",{ref_key:"propertyPopup",ref:i,class:"property-popup"},[at,(P=h(a))!=null&&P.properties&&Object.keys((G=h(a))==null?void 0:G.properties).length?(S(),C("div",st,[c(k,{column:1,border:!0},{default:b(()=>[(S(!0),C(N,null,te(h(a).properties,(F,A,V)=>(S(),j(E,{key:V,label:A.toString()},{default:b(()=>[O(U(F),1)]),_:2},1032,["label"]))),128))]),_:1})])):re("",!0)],512),[[ne,!1]])],64)}}}),lt=I(it,[["__scopeId","data-v-57bfadf3"]]),ut=T({__name:"Editor",setup(t){const r=xe();let e={type:"FeatureCollection",features:[]};const n=q(s,500);R(()=>{_.on("updateEditor",n)}),Z(()=>{_.off("updateEditor",n)});const o=q(a,500);function a(i){try{typeof i=="string"?e=JSON.parse(i):e=i,_.emit("updateGeojsonLayer",e)}catch{}}function s(i){var l;(l=r.value)==null||l.update(i)}return(i,l)=>(S(),j(Fe,{ref_key:"editor",ref:r,class:"edit-data-json",config:{mode:"text"},content:h(e),onChange:h(o)},null,8,["content","onChange"]))}}),ct=I(ut,[["__scopeId","data-v-df2ec252"]]),pt=T({__name:"PropertyTable",props:{height:{default:null}},setup(t){R(()=>{_.on("updateGeojsonLayer",g),_.on("updateEditor",g)});const r=ye(),e=oe({row:null,col:null,value:null,changed:!1});let n=!1;const o=z(()=>{var f,p;return(p=(f=r.value)==null?void 0:f.features)!=null&&p.length?r.value.features.map(u=>u.properties||{}):[]}),a=z(()=>{var f,p;if((p=(f=r.value)==null?void 0:f.features)!=null&&p.length){const u=v(o.value);if(!u.length)return null;const m=u.map(d=>({title:d,dataKey:d,key:d,width:150,cellRenderer:({rowData:E,column:k,rowIndex:P,columnIndex:G})=>{let F,A;E[k.dataKey]!=null?(A=typeof E[k.dataKey],~["boolean","number","string"].indexOf(A)?F=E[k.dataKey].toString():F=JSON.stringify(E[k.dataKey])):F="";const V=()=>{e.row=P,e.col=G,e.value=F},ue=()=>{if(e.changed){let M;if(e.value!=null?M=e.value.trim():M="",A!=="string")try{M=JSON.parse(M)}catch{}l(P,G,M)}e.row=null,e.col=null,e.value=null,e.changed=!1},ce=M=>{e.value=M,e.changed=!0},pe=M=>{var $;($=M==null?void 0:M.focus)==null||$.call(M)};return e.row===P&&e.col===G?c(ae,{ref:pe,modelValue:e.value,onInput:ce,onBlur:ue},null):c("div",{class:"table-v2-inline-editing-trigger",onClick:V,title:F},[F])}}));return m.unshift({title:"序号",dataKey:"index",key:"index",width:50,fixed:!0,cellRenderer:({rowIndex:d})=>c("span",{class:"_index"},[d+1])}),m}else return null}),s=q(y,500);function i(f){var u;let p=f.target;if(p.classList.contains("el-table-v2__row")||(p=p.closest(".el-table-v2__row")),p&&p.parentElement){const m=[].indexOf.call(p.parentElement.children,p),d=(u=p.closest(".el-table-v2__root"))==null?void 0:u.querySelectorAll("._index")[m];if(d){const E=Number.parseInt(d.textContent||"1")-1;_.emit("selectFeature",E)}}}function l(f,p,u){var d,E,k,P;const m=(E=(d=r.value)==null?void 0:d.features)==null?void 0:E[f];if(m){m.properties||(m.properties={});const G=(P=(k=a.value)==null?void 0:k[p])==null?void 0:P.dataKey;G&&(m.properties[G]=u)}r.value&&s(he(r.value))}function y(f){n||(n=!0,_.emit("updateEditor",f),n=!1)}function g(){n||_.emit("getGeoJson",f=>{r.value=f})}function v(f){return[...f.reduce((p,u)=>(Object.keys(u).forEach(m=>p.add(m)),p),new Set)]}return(f,p)=>{const u=Ae,m=Je,d=Ie;return h(a)?(S(),C("div",{key:0,"w-full":"",style:ge({height:f.height?`${f.height}px`:void 0})},[c(m,null,{default:b(({height:E,width:k})=>[c(u,{columns:h(a),data:h(o),width:k,height:E,fixed:"",onClick:i},null,8,["columns","data","width","height"])]),_:1})],4)):(S(),j(d,{key:1}))}}}),ft=I(pt,[["__scopeId","data-v-40ed404b"]]),dt={class:"layer-wrapper"},mt=["title"],_t=["title"],yt=T({__name:"AddService",setup(t){let r;const e=oe({count:0,name:"服务 1",url:"",type:"supermap_rest",layers:[]});R(()=>{_.emit("getMap",a=>{r=a})});function n(){const a=e.url,s=e.type,i=e.name;e.count++,e.name=`服务 ${e.count}`;let l;try{l=Ge(r,{name:i,type:s,url:a})}catch{se.error("添加服务失败");return}l&&e.layers.push({name:i,url:a,layer:l,id:$e()})}function o(a){var s;(s=e.layers[a])!=null&&s.layer&&(Le(r,e.layers[a].layer),e.layers.splice(a,1))}return(a,s)=>{const i=ie,l=Ve,y=ae,g=Ne,v=Te,f=Re,p=Oe;return S(),C(N,null,[h(e).layers.length?(S(),C(N,{key:0},[L("div",dt,[(S(!0),C(N,null,te(h(e).layers,(u,m)=>(S(),C("div",{key:u.id,class:"layer-item"},[L("div",{class:"layer-item-title",title:u.name},U(u.name),9,mt),L("div",{class:"layer-item-url",title:u.url},U(u.url),9,_t),c(i,{onClick:d=>o(m)},{default:b(()=>[O(" 移除 ")]),_:2},1032,["onClick"])]))),128))]),c(l)],64)):re("",!0),c(p,{colon:!1,class:"addService"},{default:b(()=>[c(g,{label:"服务名称"},{default:b(()=>[c(y,{modelValue:h(e).name,"onUpdate:modelValue":s[0]||(s[0]=u=>h(e).name=u)},null,8,["modelValue"])]),_:1}),c(g,{label:"服务地址"},{default:b(()=>[c(y,{modelValue:h(e).url,"onUpdate:modelValue":s[1]||(s[1]=u=>h(e).url=u)},null,8,["modelValue"])]),_:1}),c(g,{label:"服务类型"},{default:b(()=>[c(f,{modelValue:h(e).type,"onUpdate:modelValue":s[2]||(s[2]=u=>h(e).type=u)},{default:b(()=>[c(v,{value:"supermap_rest",label:"超图动态"}),c(v,{value:"supermap_tile",label:"超图切片"}),c(v,{value:"arcgis_rest",label:"ArcGIS 动态"}),c(v,{value:"arcgis_tile",label:"ArcGIS 切片"}),c(v,{value:"tms",label:"TMS"})]),_:1},8,["modelValue"])]),_:1}),c(g,{class:"formBtnItem"},{default:b(()=>[c(i,{type:"primary",onClick:n},{default:b(()=>[O(" 添加 ")]),_:1})]),_:1})]),_:1})],64)}}}),gt=I(yt,[["__scopeId","data-v-4dbebe0b"]]),ht={class:"controlMenu"},vt={__name:"ControlMenu",setup(t){function r(o){if(o.target.files.length){const a=o.target.files[0],s=new FileReader;s.onload=()=>{if(s.result&&typeof s.result=="string")try{const i=JSON.parse(s.result);_.emit("updateEditor",i),_.emit("updateGeojsonLayer",i)}catch{}},s.readAsText(a)}o.target.value=""}function e(){_.emit("getGeoJson",o=>{o?Be(JSON.stringify(o),"exportFile.geojson"):se.warning("无可导出数据")})}function n(){_.emit("getGeoJson",o=>{if(o){const a=Qe(o);a<1e6?B.alert(`面积: ${a.toFixed(2)} 平方米`,"信息"):a<1e8?B.alert(`面积: ${(a/1e4).toFixed(2)} 公顷`,"信息"):B.alert(`面积: ${(a/1e6).toFixed(2)} 平方千米`,"信息")}})}return(o,a)=>{const s=ie;return S(),C("div",ht,[ee(L("input",{ref:"uploader",type:"file",accept:".json,.JSON,.geojson,.GEOJSON",onChange:r},null,544),[[ne,!1]]),c(s,{onClick:a[0]||(a[0]=i=>o.$refs.uploader.click())},{default:b(()=>[O(" 打开 ")]),_:1}),c(s,{onClick:e},{default:b(()=>[O(" 保存 ")]),_:1}),L("i",{class:"i-icon-park-outline-info",onClick:n})])}}},bt=I(vt,[["__scopeId","data-v-416b8397"]]),wt=T({__name:"geoJson",setup(t){const r=J("geoJson"),e=J(),n=z(()=>e.value?Number.parseFloat(getComputedStyle(e.value).height)-40:400);return(o,a)=>{const s=be,i=we;return S(),C("div",{ref_key:"wrapper",ref:e,class:"wrapper"},[c(lt),c(i,{modelValue:h(r),"onUpdate:modelValue":a[0]||(a[0]=l=>ve(r)?r.value=l:null),type:"card"},{default:b(()=>[c(s,{name:"geoJson",label:"GeoJSON"},{default:b(()=>[c(ct)]),_:1}),c(s,{name:"table",label:"属性表"},{default:b(()=>[c(ft,{height:h(n)},null,8,["height"])]),_:1}),c(s,{name:"addService",label:"添加服务"},{default:b(()=>[c(gt)]),_:1})]),_:1},8,["modelValue"]),c(bt)],512)}}}),ar=I(wt,[["__scopeId","data-v-baae8638"]]);export{ar as default};
