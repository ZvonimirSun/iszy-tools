import{l as o}from"./common-nI2yxfUv.js";var x=window.XMLHttpRequest&&"withCredentials"in new window.XMLHttpRequest,$=document.documentElement.style.pointerEvents==="",v={cors:x,pointerEvents:$},tt={attributionWidthOffset:55},A=0;function w(t){var e="";t.f=t.f||"json";for(var i in t)if(Object.prototype.hasOwnProperty.call(t,i)){var r=t[i],s=Object.prototype.toString.call(r),n;e.length&&(e+="&"),s==="[object Array]"?n=Object.prototype.toString.call(r[0])==="[object Object]"?JSON.stringify(r):r.join(","):s==="[object Object]"?n=JSON.stringify(r):s==="[object Date]"?n=r.valueOf():n=r,e+=encodeURIComponent(i)+"="+encodeURIComponent(n)}const a="%27";return e.replaceAll("'",a)}function T(t,e){var i=new window.XMLHttpRequest;return i.onerror=function(r){i.onreadystatechange=o.Util.falseFn,t.call(e,{error:{code:500,message:"XMLHttpRequest error"}},null)},i.onreadystatechange=function(){var r,s;if(i.readyState===4){try{r=JSON.parse(i.responseText)}catch{r=null,s={code:500,message:"Could not parse response as JSON. This could also be caused by a CORS or XMLHttpRequest error."}}!s&&r.error&&(s=r.error,r=null),i.onerror=o.Util.falseFn,t.call(e,s,r)}},i.ontimeout=function(){this.onerror()},i}function et(t,e,i,r){var s=T(i,r);return s.open("POST",t),typeof r<"u"&&r!==null&&typeof r.options<"u"&&(s.timeout=r.options.timeout),s.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),s.send(w(e)),s}function k(t,e,i,r){var s=T(i,r);return s.open("GET",t+"?"+w(e),!0),typeof r<"u"&&r!==null&&typeof r.options<"u"&&(s.timeout=r.options.timeout,r.options.withCredentials&&(s.withCredentials=!0)),s.send(null),s}function G(t,e,i,r){var s=w(e),n=T(i,r),a=(t+"?"+s).length;if(a<=2e3&&v.cors?n.open("GET",t+"?"+s):a>2e3&&v.cors&&(n.open("POST",t),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8")),typeof r<"u"&&r!==null&&typeof r.options<"u"&&(n.timeout=r.options.timeout,r.options.withCredentials&&(n.withCredentials=!0)),a<=2e3&&v.cors)n.send(null);else if(a>2e3&&v.cors)n.send(s);else{if(a<=2e3&&!v.cors)return F(t,e,i,r);y("a request to "+t+" was longer then 2000 characters and this browser cannot make a cross-domain post request. Please use a proxy https://developers.arcgis.com/esri-leaflet/api-reference/request/");return}return n}function F(t,e,i,r){window._EsriLeafletCallbacks=window._EsriLeafletCallbacks||{};var s="c"+A;e.callback="window._EsriLeafletCallbacks."+s,window._EsriLeafletCallbacks[s]=function(a){if(window._EsriLeafletCallbacks[s]!==!0){var u,l=Object.prototype.toString.call(a);l==="[object Object]"||l==="[object Array]"||(u={error:{code:500,message:"Expected array or object as JSONP response"}},a=null),!u&&a.error&&(u=a,a=null),i.call(r,u,a),window._EsriLeafletCallbacks[s]=!0}};var n=o.DomUtil.create("script",null,document.body);return n.type="text/javascript",n.src=t+"?"+w(e),n.id=s,n.onerror=function(a){if(a&&window._EsriLeafletCallbacks[s]!==!0){var u={error:{code:500,message:"An unknown error occurred"}};i.call(r,u),window._EsriLeafletCallbacks[s]=!0}},o.DomUtil.addClass(n,"esri-leaflet-jsonp"),A++,{id:s,url:n.src,abort:function(){window._EsriLeafletCallbacks._callback[s]({code:0,message:"Request aborted."})}}}var L=v.cors?k:F;L.CORS=k;L.JSONP=F;function y(){console&&console.warn&&console.warn.apply(console,arguments)}var b={request:G,get:L,post:et};/* @preserve
* @terraformer/arcgis - v2.1.1 - MIT
* Copyright (c) 2012-2022 Environmental Systems Research Institute, Inc.
* Tue Aug 02 2022 14:23:48 GMT-0700 (Pacific Daylight Time)
*/var it=function(e,i,r,s){var n=(s[0]-r[0])*(e[1]-r[1])-(s[1]-r[1])*(e[0]-r[0]),a=(i[0]-e[0])*(e[1]-r[1])-(i[1]-e[1])*(e[0]-r[0]),u=(s[1]-r[1])*(i[0]-e[0])-(s[0]-r[0])*(i[1]-e[1]);if(u!==0){var l=n/u,h=a/u;if(l>=0&&l<=1&&h>=0&&h<=1)return!0}return!1},rt=function(e,i){for(var r=!1,s=-1,n=e.length,a=n-1;++s<n;a=s)(e[s][1]<=i[1]&&i[1]<e[a][1]||e[a][1]<=i[1]&&i[1]<e[s][1])&&i[0]<(e[a][0]-e[s][0])*(i[1]-e[s][1])/(e[a][1]-e[s][1])+e[s][0]&&(r=!r);return r},st=function(e,i){for(var r=0;r<e.length;r++)if(e[r]!==i[r])return!1;return!0},Z=function(e,i){for(var r=0;r<e.length-1;r++)for(var s=0;s<i.length-1;s++)if(it(e[r],e[r+1],i[s],i[s+1]))return!0;return!1},R=function(e){return st(e[0],e[e.length-1])||e.push(e[0]),e},P=function(e){var i=0,r=0,s=e.length,n=e[r],a;for(r;r<s-1;r++)a=e[r+1],i+=(a[0]-n[0])*(a[1]+n[1]),n=a;return i>=0},N=function(e){var i={};for(var r in e)e.hasOwnProperty(r)&&(i[r]=e[r]);return i},nt=function(e,i){var r=Z(e,i),s=rt(e,i[0]);return!!(!r&&s)},at=function(e){for(var i=[],r=[],s,n,a,u=0;u<e.length;u++){var l=R(e[u].slice(0));if(!(l.length<4))if(P(l)){var h=[l.slice().reverse()];i.push(h)}else r.push(l.slice().reverse())}for(var c=[];r.length;){a=r.pop();var d=!1;for(s=i.length-1;s>=0;s--)if(n=i[s][0],nt(n,a)){i[s].push(a),d=!0;break}d||c.push(a)}for(;c.length;){a=c.pop();var f=!1;for(s=i.length-1;s>=0;s--)if(n=i[s][0],Z(n,a)){i[s].push(a),f=!0;break}f||i.push([a.reverse()])}return i.length===1?{type:"Polygon",coordinates:i[0]}:{type:"MultiPolygon",coordinates:i}},ot=function(e,i){for(var r=i?[i,"OBJECTID","FID"]:["OBJECTID","FID"],s=0;s<r.length;s++){var n=r[s];if(n in e&&(typeof e[n]=="string"||typeof e[n]=="number"))return e[n]}throw Error("No valid id attribute found")},ut=function t(e,i){var r={};if(e.features){r.type="FeatureCollection",r.features=[];for(var s=0;s<e.features.length;s++)r.features.push(t(e.features[s],i))}if(typeof e.x=="number"&&typeof e.y=="number"&&(r.type="Point",r.coordinates=[e.x,e.y],typeof e.z=="number"&&r.coordinates.push(e.z)),e.points&&(r.type="MultiPoint",r.coordinates=e.points.slice(0)),e.paths&&(e.paths.length===1?(r.type="LineString",r.coordinates=e.paths[0].slice(0)):(r.type="MultiLineString",r.coordinates=e.paths.slice(0))),e.rings&&(r=at(e.rings.slice(0))),typeof e.xmin=="number"&&typeof e.ymin=="number"&&typeof e.xmax=="number"&&typeof e.ymax=="number"&&(r.type="Polygon",r.coordinates=[[[e.xmax,e.ymax],[e.xmin,e.ymax],[e.xmin,e.ymin],[e.xmax,e.ymin],[e.xmax,e.ymax]]]),(e.geometry||e.attributes)&&(r.type="Feature",r.geometry=e.geometry?t(e.geometry):null,r.properties=e.attributes?N(e.attributes):null,e.attributes))try{r.id=ot(e.attributes,i)}catch{}return JSON.stringify(r.geometry)===JSON.stringify({})&&(r.geometry=null),e.spatialReference&&e.spatialReference.wkid&&e.spatialReference.wkid!==4326&&console.warn("Object converted in non-standard crs - "+JSON.stringify(e.spatialReference)),r},U=function(e){var i=[],r=e.slice(0),s=R(r.shift().slice(0));if(s.length>=4){P(s)||s.reverse(),i.push(s);for(var n=0;n<r.length;n++){var a=R(r[n].slice(0));a.length>=4&&(P(a)&&a.reverse(),i.push(a))}}return i},lt=function(e){for(var i=[],r=0;r<e.length;r++)for(var s=U(e[r]),n=s.length-1;n>=0;n--){var a=s[n].slice(0);i.push(a)}return i},ht=function t(e,i){i=i||"OBJECTID";var r={wkid:4326},s={},n;switch(e.type){case"Point":s.x=e.coordinates[0],s.y=e.coordinates[1],e.coordinates[2]!=null&&(s.z=e.coordinates[2]),s.spatialReference=r;break;case"MultiPoint":s.points=e.coordinates.slice(0),e.coordinates[0][2]!=null&&(s.hasZ=!0),s.spatialReference=r;break;case"LineString":s.paths=[e.coordinates.slice(0)],e.coordinates[0][2]!=null&&(s.hasZ=!0),s.spatialReference=r;break;case"MultiLineString":s.paths=e.coordinates.slice(0),e.coordinates[0][0][2]!=null&&(s.hasZ=!0),s.spatialReference=r;break;case"Polygon":s.rings=U(e.coordinates.slice(0)),e.coordinates[0][0][2]!=null&&(s.hasZ=!0),s.spatialReference=r;break;case"MultiPolygon":s.rings=lt(e.coordinates.slice(0)),e.coordinates[0][0][0][2]!=null&&(s.hasZ=!0),s.spatialReference=r;break;case"Feature":e.geometry&&(s.geometry=t(e.geometry,i)),s.attributes=e.properties?N(e.properties):{},e.id&&(s.attributes[i]=e.id);break;case"FeatureCollection":for(s=[],n=0;n<e.features.length;n++)s.push(t(e.features[n],i));break;case"GeometryCollection":for(s=[],n=0;n<e.geometries.length;n++)s.push(t(e.geometries[n],i));break}return s},ft='Powered by <a href="https://www.esri.com">Esri</a>';function C(t,e){return ht(t,e)}function ct(t,e){return ut(t,e)}function M(t){if(t.xmin!=="NaN"&&t.ymin!=="NaN"&&t.xmax!=="NaN"&&t.ymax!=="NaN"){var e=o.latLng(t.ymin,t.xmin),i=o.latLng(t.ymax,t.xmax);return o.latLngBounds(e,i)}else return null}function D(t){return t=o.latLngBounds(t),{xmin:t.getSouthWest().lng,ymin:t.getSouthWest().lat,xmax:t.getNorthEast().lng,ymax:t.getNorthEast().lat,spatialReference:{wkid:4326}}}var J=/^(OBJECTID|FID|OID|ID)$/i;function dt(t){var e;if(t.objectIdFieldName)e=t.objectIdFieldName;else if(t.fields){for(var i=0;i<=t.fields.length-1;i++)if(t.fields[i].type==="esriFieldTypeOID"){e=t.fields[i].name;break}if(!e){for(i=0;i<=t.fields.length-1;i++)if(t.fields[i].name.match(J)){e=t.fields[i].name;break}}}return e}function pt(t){for(var e in t.attributes)if(e.match(J))return e}function I(t,e){var i,r=t.features||t.results,s=r&&r.length;e?i=e:i=dt(t);var n={type:"FeatureCollection",features:[]};if(s)for(var a=r.length-1;a>=0;a--){var u=ct(r[a],i||pt(r[a]));n.features.push(u)}return n}function q(t){return t=o.Util.trim(t),t[t.length-1]!=="/"&&(t+="/"),t}function mt(t){if(t.url.indexOf("?")!==-1){t.requestParams=t.requestParams||{};var e=t.url.substring(t.url.indexOf("?")+1);t.url=t.url.split("?")[0],t.requestParams=JSON.parse('{"'+decodeURI(e).replace(/"/g,'\\"').replace(/&/g,'","').replace(/=/g,'":"')+'"}')}return t.url=q(t.url.split("?")[0]),t}function vt(t){return/^(?!.*utility\.arcgis\.com).*\.arcgis\.com.*FeatureServer/i.test(t)}function z(t){var e;switch(t){case"Point":e="esriGeometryPoint";break;case"MultiPoint":e="esriGeometryMultipoint";break;case"LineString":e="esriGeometryPolyline";break;case"MultiLineString":e="esriGeometryPolyline";break;case"Polygon":e="esriGeometryPolygon";break;case"MultiPolygon":e="esriGeometryPolygon";break}return e}function S(t){return t.getSize().x-tt.attributionWidthOffset+"px"}function W(t){if(t.attributionControl){if(t.attributionControl._esriAttributionLayerCount||(t.attributionControl._esriAttributionLayerCount=0),t.attributionControl._esriAttributionLayerCount===0){if(!t.attributionControl._esriAttributionAddedOnce){var e=document.createElement("style");e.type="text/css",e.innerHTML=".esri-truncated-attribution:hover {white-space: normal;}",document.getElementsByTagName("head")[0].appendChild(e);var i=document.createElement("style");i.type="text/css",i.innerHTML=".esri-truncated-attribution {vertical-align: -3px;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;display: inline-block;transition: 0s white-space;transition-delay: 1s;max-width: "+S(t)+";}",document.getElementsByTagName("head")[0].appendChild(i),t.on("resize",function(r){t.attributionControl&&(t.attributionControl._container.style.maxWidth=S(r.target))}),t.attributionControl._esriAttributionAddedOnce=!0}o.DomUtil.addClass(t.attributionControl._container,"esri-truncated-attribution:hover"),o.DomUtil.addClass(t.attributionControl._container,"esri-truncated-attribution")}t.attributionControl._esriAttributionLayerCount=t.attributionControl._esriAttributionLayerCount+1}}function V(t){t.attributionControl&&(t.attributionControl._esriAttributionLayerCount&&t.attributionControl._esriAttributionLayerCount===1&&(o.DomUtil.removeClass(t.attributionControl._container,"esri-truncated-attribution:hover"),o.DomUtil.removeClass(t.attributionControl._container,"esri-truncated-attribution")),t.attributionControl._esriAttributionLayerCount=t.attributionControl._esriAttributionLayerCount-1)}function j(t){var e={geometry:null,geometryType:null};if(t instanceof o.LatLngBounds)return e.geometry=D(t),e.geometryType="esriGeometryEnvelope",e;if(t.getLatLng&&(t=t.getLatLng()),t instanceof o.LatLng&&(t={type:"Point",coordinates:[t.lng,t.lat]}),t instanceof o.GeoJSON&&(t=t.getLayers()[0].feature.geometry,e.geometry=C(t),e.geometryType=z(t.type)),t.toGeoJSON&&(t=t.toGeoJSON()),t.type==="Feature"&&(t=t.geometry),t.type==="Point"||t.type==="LineString"||t.type==="Polygon"||t.type==="MultiPolygon")return e.geometry=C(t),e.geometryType=z(t.type),e;y("invalid geometry passed to spatial query. Should be L.LatLng, L.LatLngBounds, L.Marker or a GeoJSON Point, Line, Polygon or MultiPolygon object")}function qt(t,e){v.cors&&G(t,{},o.Util.bind(function(i,r){if(!i){e._esriAttributions=[];for(var s=0;s<r.contributors.length;s++)for(var n=r.contributors[s],a=0;a<n.coverageAreas.length;a++){var u=n.coverageAreas[a],l=o.latLng(u.bbox[0],u.bbox[1]),h=o.latLng(u.bbox[2],u.bbox[3]);e._esriAttributions.push({attribution:n.attribution,score:u.score,bounds:o.latLngBounds(l,h),minZoom:u.zoomMin,maxZoom:u.zoomMax})}e._esriAttributions.sort(function(d,f){return f.score-d.score});var c={target:e};_t(c)}},this))}function _t(t){var e=t.target,i=e._esriAttributions;if(!(!e||!e.attributionControl)){var r=e.attributionControl._container.querySelector(".esri-dynamic-attribution");if(r&&i){for(var s="",n=e.getBounds(),a=o.latLngBounds(n.getSouthWest().wrap(),n.getNorthEast().wrap()),u=e.getZoom(),l=0;l<i.length;l++){var h=i[l],c=h.attribution;!s.match(c)&&h.bounds.intersects(a)&&u>=h.minZoom&&u<=h.maxZoom&&(s+=", "+c)}s=ft+" | "+s.substr(2),r.innerHTML=s,r.style.maxWidth=S(e),e.fire("attributionupdated",{attribution:s})}}}var O=o.Class.extend({options:{proxy:!1,useCors:x},generateSetter:function(t,e){return o.Util.bind(function(i){return this.params[t]=i,this},e)},initialize:function(t){if(t.request&&t.options?(this._service=t,o.Util.setOptions(this,t.options)):(o.Util.setOptions(this,t),this.options.url=q(t.url)),this.params=o.Util.extend({},this.params||{}),this.setters)for(var e in this.setters){var i=this.setters[e];this[e]=this.generateSetter(i,this)}},token:function(t){return this._service?this._service.authenticate(t):this.params.token=t,this},apikey:function(t){return this.token(t)},format:function(t){return this.params.returnUnformattedValues=!t,this},request:function(t,e){return this.options.requestParams&&o.Util.extend(this.params,this.options.requestParams),this._service?this._service.request(this.path,this.params,t,e):this._request("request",this.path,this.params,t,e)},_request:function(t,e,i,r,s){var n=this.options.proxy?this.options.proxy+"?"+this.options.url+e:this.options.url+e;return(t==="get"||t==="request")&&!this.options.useCors?b.get.JSONP(n,i,r,s):b[t](n,i,r,s)}}),yt=O.extend({setters:{offset:"resultOffset",limit:"resultRecordCount",fields:"outFields",precision:"geometryPrecision",featureIds:"objectIds",returnGeometry:"returnGeometry",returnM:"returnM",transform:"datumTransformation",token:"token"},path:"query",params:{returnGeometry:!0,where:"1=1",outSR:4326,outFields:"*"},within:function(t){return this._setGeometryParams(t),this.params.spatialRel="esriSpatialRelContains",this},intersects:function(t){return this._setGeometryParams(t),this.params.spatialRel="esriSpatialRelIntersects",this},contains:function(t){return this._setGeometryParams(t),this.params.spatialRel="esriSpatialRelWithin",this},crosses:function(t){return this._setGeometryParams(t),this.params.spatialRel="esriSpatialRelCrosses",this},touches:function(t){return this._setGeometryParams(t),this.params.spatialRel="esriSpatialRelTouches",this},overlaps:function(t){return this._setGeometryParams(t),this.params.spatialRel="esriSpatialRelOverlaps",this},bboxIntersects:function(t){return this._setGeometryParams(t),this.params.spatialRel="esriSpatialRelEnvelopeIntersects",this},indexIntersects:function(t){return this._setGeometryParams(t),this.params.spatialRel="esriSpatialRelIndexIntersects",this},nearby:function(t,e){return t=o.latLng(t),this.params.geometry=[t.lng,t.lat],this.params.geometryType="esriGeometryPoint",this.params.spatialRel="esriSpatialRelIntersects",this.params.units="esriSRUnit_Meter",this.params.distance=e,this.params.inSR=4326,this},where:function(t){return this.params.where=t,this},between:function(t,e){return this.params.time=[t.valueOf(),e.valueOf()],this},simplify:function(t,e){var i=Math.abs(t.getBounds().getWest()-t.getBounds().getEast());return this.params.maxAllowableOffset=i/t.getSize().y*e,this},orderBy:function(t,e){return e=e||"ASC",this.params.orderByFields=this.params.orderByFields?this.params.orderByFields+",":"",this.params.orderByFields+=[t,e].join(" "),this},run:function(t,e){return this._cleanParams(),this.options.isModern||vt(this.options.url)&&this.options.isModern===void 0?(this.params.f="geojson",this.request(function(i,r){this._trapSQLerrors(i),t.call(e,i,r,r)},this)):this.request(function(i,r){this._trapSQLerrors(i),t.call(e,i,r&&I(r),r)},this)},count:function(t,e){return this._cleanParams(),this.params.returnCountOnly=!0,this.request(function(i,r){t.call(this,i,r&&r.count,r)},e)},ids:function(t,e){return this._cleanParams(),this.params.returnIdsOnly=!0,this.request(function(i,r){t.call(this,i,r&&r.objectIds,r)},e)},bounds:function(t,e){return this._cleanParams(),this.params.returnExtentOnly=!0,this.request(function(i,r){r&&r.extent&&M(r.extent)?t.call(e,i,M(r.extent),r):(i={message:"Invalid Bounds"},t.call(e,i,null,r))},e)},distinct:function(){return this.params.returnGeometry=!1,this.params.returnDistinctValues=!0,this},pixelSize:function(t){var e=o.point(t);return this.params.pixelSize=[e.x,e.y],this},layer:function(t){return this.path=t+"/query",this},_trapSQLerrors:function(t){t&&t.code==="400"&&y("one common syntax error in query requests is encasing string values in double quotes instead of single quotes")},_cleanParams:function(){delete this.params.returnIdsOnly,delete this.params.returnExtentOnly,delete this.params.returnCountOnly},_setGeometryParams:function(t){this.params.inSR=4326;var e=j(t);this.params.geometry=e.geometry,this.params.geometryType=e.geometryType}});function B(t){return new yt(t)}var gt=O.extend({setters:{contains:"contains",text:"searchText",fields:"searchFields",spatialReference:"sr",sr:"sr",layers:"layers",returnGeometry:"returnGeometry",maxAllowableOffset:"maxAllowableOffset",precision:"geometryPrecision",dynamicLayers:"dynamicLayers",returnZ:"returnZ",returnM:"returnM",gdbVersion:"gdbVersion",token:"token"},path:"find",params:{sr:4326,contains:!0,returnGeometry:!0,returnZ:!0,returnM:!1},layerDefs:function(t,e){return this.params.layerDefs=this.params.layerDefs?this.params.layerDefs+";":"",this.params.layerDefs+=[t,e].join(":"),this},simplify:function(t,e){var i=Math.abs(t.getBounds().getWest()-t.getBounds().getEast());return this.params.maxAllowableOffset=i/t.getSize().y*e,this},run:function(t,e){return this.request(function(i,r){t.call(e,i,r&&I(r),r)},e)}});function bt(t){return new gt(t)}var Q=O.extend({path:"identify",between:function(t,e){return this.params.time=[t.valueOf(),e.valueOf()],this}}),Ct=Q.extend({setters:{layers:"layers",precision:"geometryPrecision",tolerance:"tolerance",returnGeometry:"returnGeometry"},params:{sr:4326,layers:"all",tolerance:3,returnGeometry:!0},on:function(t){var e=D(t.getBounds()),i=t.getSize();return this.params.imageDisplay=[i.x,i.y,96],this.params.mapExtent=[e.xmin,e.ymin,e.xmax,e.ymax],this},at:function(t){return t.length===2&&(t=o.latLng(t)),this._setGeometryParams(t),this},layerDef:function(t,e){return this.params.layerDefs=this.params.layerDefs?this.params.layerDefs+";":"",this.params.layerDefs+=[t,e].join(":"),this},simplify:function(t,e){var i=Math.abs(t.getBounds().getWest()-t.getBounds().getEast());return this.params.maxAllowableOffset=i/t.getSize().y*e,this},run:function(t,e){return this.request(function(i,r){if(i)t.call(e,i,void 0,r);else{var s=I(r);r.results=r.results.reverse();for(var n=0;n<s.features.length;n++){var a=s.features[n];a.layerId=r.results[n].layerId}t.call(e,void 0,s,r)}})},_setGeometryParams:function(t){var e=j(t);this.params.geometry=e.geometry,this.params.geometryType=e.geometryType}});function xt(t){return new Ct(t)}var wt=Q.extend({setters:{setMosaicRule:"mosaicRule",setRenderingRule:"renderingRule",setPixelSize:"pixelSize",returnCatalogItems:"returnCatalogItems",returnGeometry:"returnGeometry"},params:{returnGeometry:!1},at:function(t){return t=o.latLng(t),this.params.geometry=JSON.stringify({x:t.lng,y:t.lat,spatialReference:{wkid:4326}}),this.params.geometryType="esriGeometryPoint",this},getMosaicRule:function(){return this.params.mosaicRule},getRenderingRule:function(){return this.params.renderingRule},getPixelSize:function(){return this.params.pixelSize},run:function(t,e){return this.request(function(i,r){t.call(e,i,r&&this._responseToGeoJSON(r),r)},this)},_responseToGeoJSON:function(t){var e=t.location,i=t.catalogItems,r=t.catalogItemVisibilities,s={pixel:{type:"Feature",geometry:{type:"Point",coordinates:[e.x,e.y]},crs:{type:"EPSG",properties:{code:e.spatialReference.wkid}},properties:{OBJECTID:t.objectId,name:t.name,value:t.value},id:t.objectId}};if(t.properties&&t.properties.Values&&(s.pixel.properties.values=t.properties.Values),i&&i.features&&(s.catalogItems=I(i),r&&r.length===s.catalogItems.features.length))for(var n=r.length-1;n>=0;n--)s.catalogItems.features[n].properties.catalogItemVisibility=r[n];return s}});function It(t){return new wt(t)}var E=o.Evented.extend({options:{proxy:!1,useCors:x,timeout:0},initialize:function(t){t=t||{},this._requestQueue=[],this._authenticating=!1,o.Util.setOptions(this,t),this.options.url=q(this.options.url)},get:function(t,e,i,r){return this._request("get",t,e,i,r)},post:function(t,e,i,r){return this._request("post",t,e,i,r)},request:function(t,e,i,r){return this._request("request",t,e,i,r)},metadata:function(t,e){return this._request("get","",{},t,e)},authenticate:function(t){return this._authenticating=!1,this.options.token=t,this._runQueue(),this},getTimeout:function(){return this.options.timeout},setTimeout:function(t){this.options.timeout=t},_request:function(t,e,i,r,s){this.fire("requeststart",{url:this.options.url+e,params:i,method:t},!0);var n=this._createServiceCallback(t,e,i,r,s);if(this.options.token&&(i.token=this.options.token),this.options.requestParams&&o.Util.extend(i,this.options.requestParams),this._authenticating)this._requestQueue.push([t,e,i,r,s]);else{var a=this.options.proxy?this.options.proxy+"?"+this.options.url+e:this.options.url+e;return(t==="get"||t==="request")&&!this.options.useCors?b.get.JSONP(a,i,n,s):b[t](a,i,n,s)}},_createServiceCallback:function(t,e,i,r,s){return o.Util.bind(function(n,a){n&&(n.code===499||n.code===498)&&(this._authenticating=!0,this._requestQueue.push([t,e,i,r,s]),this.fire("authenticationrequired",{authenticate:o.Util.bind(this.authenticate,this)},!0),n.authenticate=o.Util.bind(this.authenticate,this)),r.call(s,n,a),n?this.fire("requesterror",{url:this.options.url+e,params:i,message:n.message,code:n.code,method:t},!0):this.fire("requestsuccess",{url:this.options.url+e,params:i,response:a,method:t},!0),this.fire("requestend",{url:this.options.url+e,params:i,method:t},!0)},this)},_runQueue:function(){for(var t=this._requestQueue.length-1;t>=0;t--){var e=this._requestQueue[t],i=e.shift();this[i].apply(this,e)}this._requestQueue=[]}}),Rt=E.extend({identify:function(){return xt(this)},find:function(){return bt(this)},query:function(){return B(this)}});function Ot(t){return new Rt(t)}var Pt=E.extend({query:function(){return B(this)},identify:function(){return It(this)}});function Bt(t){return new Pt(t)}var St=E.extend({options:{idAttribute:"OBJECTID"},query:function(){return B(this)},addFeature:function(t,e,i){this.addFeatures(t,e,i)},addFeatures:function(t,e,i){for(var r=t.features?t.features:[t],s=r.length-1;s>=0;s--)delete r[s].id;return t=C(t),t=r.length>1?t:[t],this.post("addFeatures",{features:t},function(n,a){var u=a&&a.addResults?a.addResults.length>1?a.addResults:a.addResults[0]:void 0;e&&e.call(i,n||a.addResults[0].error,u)},i)},updateFeature:function(t,e,i){this.updateFeatures(t,e,i)},updateFeatures:function(t,e,i){var r=t.features?t.features:[t];return t=C(t,this.options.idAttribute),t=r.length>1?t:[t],this.post("updateFeatures",{features:t},function(s,n){var a=n&&n.updateResults?n.updateResults.length>1?n.updateResults:n.updateResults[0]:void 0;e&&e.call(i,s||n.updateResults[0].error,a)},i)},deleteFeature:function(t,e,i){this.deleteFeatures(t,e,i)},deleteFeatures:function(t,e,i){return this.post("deleteFeatures",{objectIds:t},function(r,s){var n=s&&s.deleteResults?s.deleteResults.length>1?s.deleteResults:s.deleteResults[0]:void 0;e&&e.call(i,r||s.deleteResults[0].error,n)},i)}});function Tt(t){return new St(t)}var Ft=o.ImageOverlay.extend({onAdd:function(t){this._topLeft=t.getPixelBounds().min,o.ImageOverlay.prototype.onAdd.call(this,t)},_reset:function(){this._map.options.crs===o.CRS.EPSG3857?o.ImageOverlay.prototype._reset.call(this):o.DomUtil.setPosition(this._image,this._topLeft.subtract(this._map.getPixelOrigin()))}}),Et=o.Layer.extend({options:{opacity:1,position:"front",f:"image",useCors:x,attribution:null,interactive:!1,alt:""},onAdd:function(t){W(t),this.options.zIndex&&(this.options.position=null),this._update=o.Util.throttle(this._update,this.options.updateInterval,this),t.on("moveend",this._update,this),this._currentImage&&this._currentImage._bounds.equals(this._map.getBounds())?t.addLayer(this._currentImage):this._currentImage&&(this._map.removeLayer(this._currentImage),this._currentImage=null),this._update(),this._popup&&(this._map.on("click",this._getPopupData,this),this._map.on("dblclick",this._resetPopupState,this)),this.metadata(function(e,i){!e&&!this.options.attribution&&t.attributionControl&&i.copyrightText&&(this.options.attribution=i.copyrightText,t.attributionControl.addAttribution(this.getAttribution()))},this)},onRemove:function(t){V(t),this._currentImage&&this._map.removeLayer(this._currentImage),this._popup&&(this._map.off("click",this._getPopupData,this),this._map.off("dblclick",this._resetPopupState,this)),this._map.off("moveend",this._update,this)},bindPopup:function(t,e){return this._shouldRenderPopup=!1,this._lastClick=!1,this._popup=o.popup(e),this._popupFunction=t,this._map&&(this._map.on("click",this._getPopupData,this),this._map.on("dblclick",this._resetPopupState,this)),this},unbindPopup:function(){return this._map&&(this._map.closePopup(this._popup),this._map.off("click",this._getPopupData,this),this._map.off("dblclick",this._resetPopupState,this)),this._popup=!1,this},bringToFront:function(){return this.options.position="front",this._currentImage&&(this._currentImage.bringToFront(),this._setAutoZIndex(Math.max)),this},bringToBack:function(){return this.options.position="back",this._currentImage&&(this._currentImage.bringToBack(),this._setAutoZIndex(Math.min)),this},setZIndex:function(t){return this.options.zIndex=t,this._currentImage&&this._currentImage.setZIndex(t),this},_setAutoZIndex:function(t){if(this._currentImage){for(var e=this._currentImage.getPane().children,i=-t(-1/0,1/0),r=0,s=e.length,n;r<s;r++)n=e[r].style.zIndex,e[r]!==this._currentImage._image&&n&&(i=t(i,+n));isFinite(i)&&(this.options.zIndex=i+t(-1,1),this.setZIndex(this.options.zIndex))}},getAttribution:function(){return this.options.attribution},getOpacity:function(){return this.options.opacity},setOpacity:function(t){return this.options.opacity=t,this._currentImage&&this._currentImage.setOpacity(t),this},getTimeRange:function(){return[this.options.from,this.options.to]},setTimeRange:function(t,e){return this.options.from=t,this.options.to=e,this._update(),this},metadata:function(t,e){return this.service.metadata(t,e),this},authenticate:function(t){return this.service.authenticate(t),this},redraw:function(){this._update()},_renderImage:function(t,e,i){if(this._map){if(i&&(t="data:"+i+";base64,"+t),!t)return;var r=new Ft(t,e,{opacity:0,crossOrigin:this.options.withCredentials?"use-credentials":this.options.useCors,alt:this.options.alt,pane:this.options.pane||this.getPane(),interactive:this.options.interactive}).addTo(this._map),s=function(){this._map.removeLayer(r),this.fire("error"),r.off("load",n,this)},n=function(a){if(r.off("error",s,this),this._map){var u=a.target,l=this._currentImage;u._bounds.equals(e)&&u._bounds.equals(this._map.getBounds())?(this._currentImage=u,this.options.position==="front"?this.bringToFront():this.options.position==="back"&&this.bringToBack(),this.options.zIndex&&this.setZIndex(this.options.zIndex),this._map&&this._currentImage._map?this._currentImage.setOpacity(this.options.opacity):this._currentImage._map.removeLayer(this._currentImage),l&&this._map&&this._map.removeLayer(l),l&&l._map&&l._map.removeLayer(l)):this._map.removeLayer(u)}this.fire("load",{bounds:e})};r.once("error",s,this),r.once("load",n,this)}},_update:function(){if(this._map){var t=this._map.getZoom(),e=this._map.getBounds();if(!this._animatingZoom&&!(this._map._panTransition&&this._map._panTransition._inProgress)){if(t>this.options.maxZoom||t<this.options.minZoom){this._currentImage&&(this._currentImage._map.removeLayer(this._currentImage),this._currentImage=null);return}var i=this._buildExportParams();o.Util.extend(i,this.options.requestParams),i?(this._requestExport(i,e),this.fire("loading",{bounds:e})):this._currentImage&&(this._currentImage._map.removeLayer(this._currentImage),this._currentImage=null)}}},_renderPopup:function(t,e,i,r){if(t=o.latLng(t),this._shouldRenderPopup&&this._lastClick.equals(t)){var s=this._popupFunction(e,i,r);s&&this._popup.setLatLng(t).setContent(s).openOn(this._map)}},_resetPopupState:function(t){this._shouldRenderPopup=!1,this._lastClick=t.latlng},_calculateBbox:function(){var t=this._map.getPixelBounds(),e=this._map.unproject(t.getBottomLeft()),i=this._map.unproject(t.getTopRight()),r=this._map.options.crs.project(i),s=this._map.options.crs.project(e),n=o.bounds(r,s);return[n.getBottomLeft().x,n.getBottomLeft().y,n.getTopRight().x,n.getTopRight().y].join(",")},_calculateImageSize:function(){var t=this._map.getPixelBounds(),e=this._map.getSize(),i=this._map.unproject(t.getBottomLeft()),r=this._map.unproject(t.getTopRight()),s=this._map.latLngToLayerPoint(r).y,n=this._map.latLngToLayerPoint(i).y;return(s>0||n<e.y)&&(e.y=n-s),e.x+","+e.y}}),g=o.Layer.extend({options:{cellSize:512,updateWhenIdle:o.Browser.mobile,updateInterval:150,noWrap:!1,keepBuffer:1.5},initialize:function(t){o.Util.setOptions(this,t)},onAdd:function(t){this._cells={},this._activeCells={},this._resetView(),this._update()},onRemove:function(t){this._removeAllCells(),this._cellZoom=void 0},isLoading:function(){return this._loading},redraw:function(){return this._map&&(this._removeAllCells(),this._update()),this},getEvents:function(){var t={viewprereset:this._invalidateAll,viewreset:this._resetView,zoom:this._resetView,moveend:this._onMoveEnd};return this.options.updateWhenIdle||(this._onMove||(this._onMove=o.Util.throttle(this._onMoveEnd,this.options.updateInterval,this)),t.move=this._onMove),t},createCell:function(){return document.createElement("div")},removeCell:function(){},reuseCell:function(){},cellLeave:function(){},cellEnter:function(){},getCellSize:function(){var t=this.options.cellSize;return t instanceof o.Point?t:new o.Point(t,t)},_pruneCells:function(){if(this._map){var t,e;for(t in this._cells)e=this._cells[t],e.retain=e.current;for(t in this._cells)if(e=this._cells[t],e.current&&!e.active){var i=e.coords;this._retainParent(i.x,i.y,i.z,i.z-5)||this._retainChildren(i.x,i.y,i.z,i.z+2)}for(t in this._cells)this._cells[t].retain||this._removeCell(t)}},_removeAllCells:function(){for(var t in this._cells)this._removeCell(t)},_invalidateAll:function(){this._removeAllCells(),this._cellZoom=void 0},_retainParent:function(t,e,i,r){var s=Math.floor(t/2),n=Math.floor(e/2),a=i-1,u=new o.Point(+s,+n);u.z=+a;var l=this._cellCoordsToKey(u),h=this._cells[l];return h&&h.active?(h.retain=!0,!0):(h&&h.loaded&&(h.retain=!0),a>r?this._retainParent(s,n,a,r):!1)},_retainChildren:function(t,e,i,r){for(var s=2*t;s<2*t+2;s++)for(var n=2*e;n<2*e+2;n++){var a=new o.Point(s,n);a.z=i+1;var u=this._cellCoordsToKey(a),l=this._cells[u];if(l&&l.active){l.retain=!0;continue}else l&&l.loaded&&(l.retain=!0);i+1<r&&this._retainChildren(s,n,i+1,r)}},_resetView:function(t){var e=t&&(t.pinch||t.flyTo);e||this._setView(this._map.getCenter(),this._map.getZoom(),e,e)},_setView:function(t,e,i,r){var s=Math.round(e);r||(this._cellZoom=s,this._abortLoading&&this._abortLoading(),this._resetGrid(),s!==void 0&&this._update(t),i||this._pruneCells(),this._noPrune=!!i)},_resetGrid:function(){var t=this._map,e=t.options.crs,i=this._cellSize=this.getCellSize(),r=this._cellZoom,s=this._map.getPixelWorldBounds(this._cellZoom);s&&(this._globalCellRange=this._pxBoundsToCellRange(s)),this._wrapX=e.wrapLng&&!this.options.noWrap&&[Math.floor(t.project([0,e.wrapLng[0]],r).x/i.x),Math.ceil(t.project([0,e.wrapLng[1]],r).x/i.y)],this._wrapY=e.wrapLat&&!this.options.noWrap&&[Math.floor(t.project([e.wrapLat[0],0],r).y/i.x),Math.ceil(t.project([e.wrapLat[1],0],r).y/i.y)]},_onMoveEnd:function(t){var e=t&&(t.pinch||t.flyTo);e||!this._map||this._map._animatingZoom||this._update()},_getCelldPixelBounds:function(t){var e=this._map,i=e._animatingZoom?Math.max(e._animateToZoom,e.getZoom()):e.getZoom(),r=e.getZoomScale(i,this._cellZoom),s=e.project(t,this._cellZoom).floor(),n=e.getSize().divideBy(r*2);return new o.Bounds(s.subtract(n),s.add(n))},_update:function(t){var e=this._map;if(e){var i=Math.round(e.getZoom());t===void 0&&(t=e.getCenter());var r=this._getCelldPixelBounds(t),s=this._pxBoundsToCellRange(r),n=s.getCenter(),a=[],u=this.options.keepBuffer,l=new o.Bounds(s.getBottomLeft().subtract([u,-u]),s.getTopRight().add([u,-u]));if(!(isFinite(s.min.x)&&isFinite(s.min.y)&&isFinite(s.max.x)&&isFinite(s.max.y)))throw new Error("Attempted to load an infinite number of cells");for(var h in this._cells){var c=this._cells[h].coords;(c.z!==this._cellZoom||!l.contains(new o.Point(c.x,c.y)))&&(this._cells[h].current=!1)}if(Math.abs(i-this._cellZoom)>1){this._setView(t,i);return}for(var d=s.min.y;d<=s.max.y;d++)for(var f=s.min.x;f<=s.max.x;f++){var m=new o.Point(f,d);if(m.z=this._cellZoom,!!this._isValidCell(m)){var _=this._cells[this._cellCoordsToKey(m)];_?_.current=!0:a.push(m)}}if(a.sort(function(X,Y){return X.distanceTo(n)-Y.distanceTo(n)}),a.length!==0)for(this._loading||(this._loading=!0),f=0;f<a.length;f++){var H=this._cellCoordsToKey(a[f]),K=this._keyToCellCoords(H);this._activeCells[K]?this._reuseCell(a[f]):this._createCell(a[f])}}},_isValidCell:function(t){var e=this._map.options.crs;if(!e.infinite){var i=this._globalCellRange;if(!e.wrapLng&&(t.x<i.min.x||t.x>i.max.x)||!e.wrapLat&&(t.y<i.min.y||t.y>i.max.y))return!1}if(!this.options.bounds)return!0;var r=this._cellCoordsToBounds(t);return o.toLatLngBounds(this.options.bounds).overlaps(r)},_keyToBounds:function(t){return this._cellCoordsToBounds(this._keyToCellCoords(t))},_cellCoordsToNwSe:function(t){var e=this._map,i=this.getCellSize(),r=t.scaleBy(i),s=r.add(i),n=e.unproject(r,t.z),a=e.unproject(s,t.z);return[n,a]},_cellCoordsToBounds:function(t){var e=this._cellCoordsToNwSe(t),i=new o.LatLngBounds(e[0],e[1]);return this.options.noWrap||(i=this._map.wrapLatLngBounds(i)),i},_cellCoordsToKey:function(t){return t.x+":"+t.y+":"+t.z},_keyToCellCoords:function(t){var e=t.split(":"),i=new o.Point(+e[0],+e[1]);return i.z=+e[2],i},_removeCell:function(t){var e=this._cells[t];if(e){var i=this._keyToCellCoords(t),r=this._wrapCoords(i),s=this._cellCoordsToBounds(this._wrapCoords(i));e.current=!1,delete this._cells[t],this._activeCells[t]=e,this.cellLeave(s,r,t),this.fire("cellleave",{key:t,coords:r,bounds:s})}},_reuseCell:function(t){var e=this._cellCoordsToKey(t);this._cells[e]=this._activeCells[e],this._cells[e].current=!0;var i=this._wrapCoords(t),r=this._cellCoordsToBounds(this._wrapCoords(t));this.cellEnter(r,i,e),this.fire("cellenter",{key:e,coords:i,bounds:r})},_createCell:function(t){var e=this._cellCoordsToKey(t),i=this._wrapCoords(t),r=this._cellCoordsToBounds(this._wrapCoords(t));this.createCell(r,i,e),this.fire("cellcreate",{key:e,coords:i,bounds:r}),this._cells[e]={coords:t,current:!0},o.Util.requestAnimFrame(this._pruneCells,this)},_cellReady:function(t,e,i){var r=this._cellCoordsToKey(t);i=this._cells[r],i&&(i.loaded=+new Date,i.active=!0)},_getCellPos:function(t){return t.scaleBy(this.getCellSize())},_wrapCoords:function(t){var e=new o.Point(this._wrapX?o.Util.wrapNum(t.x,this._wrapX):t.x,this._wrapY?o.Util.wrapNum(t.y,this._wrapY):t.y);return e.z=t.z,e},_pxBoundsToCellRange:function(t){var e=this.getCellSize();return new o.Bounds(t.min.unscaleBy(e).floor(),t.max.unscaleBy(e).ceil().subtract([1,1]))}});function p(t){this.values=[].concat(t||[])}p.prototype.query=function(t){var e=this.getIndex(t);return this.values[e]};p.prototype.getIndex=function(e){this.dirty&&this.sort();for(var i=0,r=this.values.length-1,s,n;i<=r;)if(s=(i+r)/2|0,n=this.values[Math.round(s)],+n.value<+e)i=s+1;else if(+n.value>+e)r=s-1;else return s;return Math.abs(~r)};p.prototype.between=function(e,i){var r=this.getIndex(e),s=this.getIndex(i);if(r===0&&s===0)return[];for(;this.values[r-1]&&this.values[r-1].value===e;)r--;for(;this.values[s+1]&&this.values[s+1].value===i;)s++;return this.values[s]&&this.values[s].value===i&&this.values[s+1]&&s++,this.values.slice(r,s)};p.prototype.insert=function(e){return this.values.splice(this.getIndex(e.value),0,e),this};p.prototype.bulkAdd=function(e,i){return this.values=this.values.concat([].concat(e||[])),i?this.sort():this.dirty=!0,this};p.prototype.sort=function(){return this.values.sort(function(e,i){return+i.value-+e.value}).reverse(),this.dirty=!1,this};var At=g.extend({options:{attribution:null,where:"1=1",fields:["*"],from:!1,to:!1,timeField:!1,timeFilterMode:"server",simplifyFactor:0,precision:6,fetchAllFeatures:!1},initialize:function(t){if(g.prototype.initialize.call(this,t),t=mt(t),t=o.Util.setOptions(this,t),this.service=Tt(t),this.service.addEventParent(this),this.options.fields[0]!=="*"){for(var e=!1,i=0;i<this.options.fields.length;i++)this.options.fields[i].match(/^(OBJECTID|FID|OID|ID)$/i)&&(e=!0);e===!1&&y("no known esriFieldTypeOID field detected in fields Array.  Please add an attribute field containing unique IDs to ensure the layer can be drawn correctly.")}this.options.timeField.start&&this.options.timeField.end?(this._startTimeIndex=new p,this._endTimeIndex=new p):this.options.timeField&&(this._timeIndex=new p),this._cache={},this._currentSnapshot=[],this._activeRequests=0},onAdd:function(t){return W(t),this.service.metadata(function(e,i){if(!e){var r=i.supportedQueryFormats,s=!1;(this.service.options.isModern===!1||this.options.fetchAllFeatures)&&(s=!0),!s&&r&&r.indexOf("geoJSON")!==-1&&(this.service.options.isModern=!0),i.objectIdField&&(this.service.options.idAttribute=i.objectIdField),!this.options.attribution&&t.attributionControl&&i.copyrightText&&(this.options.attribution=i.copyrightText,t.attributionControl.addAttribution(this.getAttribution()))}},this),t.on("zoomend",this._handleZoomChange,this),g.prototype.onAdd.call(this,t)},onRemove:function(t){return V(t),t.off("zoomend",this._handleZoomChange,this),g.prototype.onRemove.call(this,t)},getAttribution:function(){return this.options.attribution},createCell:function(t,e){this._visibleZoom()&&this._requestFeatures(t,e)},_requestFeatures:function(t,e,i,r){this._activeRequests++,r=r||0;var s=this.options.where;return this._activeRequests===1&&this.fire("loading",{bounds:t},!0),this._buildQuery(t,r).run(function(n,a,u){u&&u.exceededTransferLimit&&this.fire("drawlimitexceeded"),this.options.where===s&&(!n&&a&&a.features.length&&o.Util.requestAnimFrame(o.Util.bind(function(){this._addFeatures(a.features,e),this._postProcessFeatures(t)},this)),!n&&a&&!a.features.length&&this._postProcessFeatures(t),n&&this._postProcessFeatures(t),i&&i.call(this,n,a),u&&(u.exceededTransferLimit||u.properties&&u.properties.exceededTransferLimit)&&this.options.fetchAllFeatures&&this._requestFeatures(t,e,i,r+a.features.length))},this)},_postProcessFeatures:function(t){this._activeRequests--,this._activeRequests<=0&&this.fire("load",{bounds:t})},_cacheKey:function(t){return t.z+":"+t.x+":"+t.y},_addFeatures:function(t,e){if(e){var i=this._cacheKey(e);this._cache[i]=this._cache[i]||[]}for(var r=t.length-1;r>=0;r--){var s=t[r].id;this._currentSnapshot.indexOf(s)===-1&&this._currentSnapshot.push(s),typeof i<"u"&&this._cache[i].indexOf(s)===-1&&this._cache[i].push(s)}this.options.timeField&&this._buildTimeIndexes(t),this.createLayers(t)},_buildQuery:function(t,e){var i=this.service.query().intersects(t).where(this.options.where).fields(this.options.fields).precision(this.options.precision);return this.options.fetchAllFeatures&&!isNaN(parseInt(e))&&(i=i.offset(e)),i.params.resultType="tile",this.options.requestParams&&o.Util.extend(i.params,this.options.requestParams),this.options.simplifyFactor&&i.simplify(this._map,this.options.simplifyFactor),this.options.timeFilterMode==="server"&&this.options.from&&this.options.to&&i.between(this.options.from,this.options.to),i},setWhere:function(t,e,i){this.options.where=t&&t.length?t:"1=1";for(var r=[],s=[],n=0,a=null,u=o.Util.bind(function(f,m){if(f&&(a=f),m)for(var _=m.features.length-1;_>=0;_--)s.push(m.features[_].id);n--,n<=0&&this._visibleZoom()&&t===this.options.where&&(this._currentSnapshot=s,o.Util.requestAnimFrame(o.Util.bind(function(){this.removeLayers(r),this.addLayers(s),e&&e.call(i,a)},this)))},this),l=this._currentSnapshot.length-1;l>=0;l--)r.push(this._currentSnapshot[l]);this._cache={};for(var h in this._cells){n++;var c=this._keyToCellCoords(h),d=this._cellCoordsToBounds(c);this._requestFeatures(d,c,u)}return this},getWhere:function(){return this.options.where},getTimeRange:function(){return[this.options.from,this.options.to]},setTimeRange:function(t,e,i,r){var s=this.options.from,n=this.options.to,a=0,u=null,l=o.Util.bind(function(f){f&&(u=f),this._filterExistingFeatures(s,n,t,e),a--,i&&a<=0&&i.call(r,u)},this);if(this.options.from=t,this.options.to=e,this._filterExistingFeatures(s,n,t,e),this.options.timeFilterMode==="server")for(var h in this._cells){a++;var c=this._keyToCellCoords(h),d=this._cellCoordsToBounds(c);this._requestFeatures(d,c,l)}return this},refresh:function(){this.setWhere(this.options.where)},_filterExistingFeatures:function(t,e,i,r){var s=t&&e?this._getFeaturesInTimeRange(t,e):this._currentSnapshot,n=this._getFeaturesInTimeRange(i,r);if(n.indexOf)for(var a=0;a<n.length;a++){var u=s.indexOf(n[a]);u>=0&&s.splice(u,1)}o.Util.requestAnimFrame(o.Util.bind(function(){this.removeLayers(s),this.addLayers(n)},this))},_getFeaturesInTimeRange:function(t,e){var i=[],r;if(this.options.timeField.start&&this.options.timeField.end){var s=this._startTimeIndex.between(t,e),n=this._endTimeIndex.between(t,e);r=s.concat(n)}else if(this._timeIndex)r=this._timeIndex.between(t,e);else return y("You must set timeField in the layer constructor in order to manipulate the start and end time filter."),[];for(var a=r.length-1;a>=0;a--)i.push(r[a].id);return i},_buildTimeIndexes:function(t){var e,i;if(this.options.timeField.start&&this.options.timeField.end){var r=[],s=[];for(e=t.length-1;e>=0;e--)i=t[e],r.push({id:i.id,value:new Date(i.properties[this.options.timeField.start])}),s.push({id:i.id,value:new Date(i.properties[this.options.timeField.end])});this._startTimeIndex.bulkAdd(r),this._endTimeIndex.bulkAdd(s)}else{var n=[];for(e=t.length-1;e>=0;e--)i=t[e],n.push({id:i.id,value:new Date(i.properties[this.options.timeField])});this._timeIndex.bulkAdd(n)}},_featureWithinTimeRange:function(t){if(!this.options.from||!this.options.to)return!0;var e=+this.options.from.valueOf(),i=+this.options.to.valueOf();if(typeof this.options.timeField=="string"){var r=+t.properties[this.options.timeField];return r>=e&&r<=i}if(this.options.timeField.start&&this.options.timeField.end){var s=+t.properties[this.options.timeField.start],n=+t.properties[this.options.timeField.end];return s>=e&&s<=i||n>=e&&n<=i||s<=e&&n>=i}},_visibleZoom:function(){if(!this._map)return!1;var t=this._map.getZoom();return!(t>this.options.maxZoom||t<this.options.minZoom)},_handleZoomChange:function(){if(!this._visibleZoom())this.removeLayers(this._currentSnapshot),this._currentSnapshot=[];else for(var t in this._cells){var e=this._cells[t].coords,i=this._cacheKey(e);this._cache[i]&&this.addLayers(this._cache[i])}},authenticate:function(t){return this.service.authenticate(t),this},metadata:function(t,e){return this.service.metadata(t,e),this},query:function(){return this.service.query()},_getMetadata:function(t){if(this._metadata){var e;t(e,this._metadata)}else this.metadata(o.Util.bind(function(i,r){this._metadata=r,t(i,this._metadata)},this))},addFeature:function(t,e,i){this.addFeatures(t,e,i)},addFeatures:function(t,e,i){this._getMetadata(o.Util.bind(function(r,s){if(r){e&&e.call(this,r,null);return}var n=t.features?t.features:[t];this.service.addFeatures(t,o.Util.bind(function(a,u){if(!a){for(var l=n.length-1;l>=0;l--)n[l].properties[s.objectIdField]=n.length>1?u[l].objectId:u.objectId,n[l].id=n.length>1?u[l].objectId:u.objectId;this._addFeatures(n)}e&&e.call(i,a,u)},this))},this))},updateFeature:function(t,e,i){this.updateFeatures(t,e,i)},updateFeatures:function(t,e,i){var r=t.features?t.features:[t];this.service.updateFeatures(t,function(s,n){if(!s){for(var a=r.length-1;a>=0;a--)this.removeLayers([r[a].id],!0);this._addFeatures(r)}e&&e.call(i,s,n)},this)},deleteFeature:function(t,e,i){this.deleteFeatures(t,e,i)},deleteFeatures:function(t,e,i){return this.service.deleteFeatures(t,function(r,s){var n=s.length?s:[s];if(!r&&n.length>0)for(var a=n.length-1;a>=0;a--)this.removeLayers([n[a].objectId],!0);e&&e.call(i,r,s)},this)}});export{At as F,Et as R,qt as _,_t as a,mt as g,Bt as i,Ot as m,$ as p,V as r,W as s,y as w};
