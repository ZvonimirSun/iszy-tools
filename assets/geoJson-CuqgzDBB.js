var fe=Object.defineProperty;var de=(t,n,e)=>n in t?fe(t,n,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[n]=e;var X=(t,n,e)=>de(t,typeof n!="symbol"?n+"":n,e);import{j as T,R as J,T as R,ad as Q,o as S,F as C,G as L,aj as ee,m as h,K as c,w as b,X as N,Y as te,l as z,L as O,I as U,H as ne,ap as re,a0 as me,a1 as _e,a2 as I,aZ as q,ab as ye,a6 as oe,k as j,q as ge,$ as ae,as as he,aC as se,N as ie,a_ as B,W as ve}from"./index-B64UzQ7O.js";import{E as be,a as we}from"./el-tab-pane-C7_eia0t.js";import{E as Ee,a as Me}from"./el-descriptions-item-B9EUDbyX.js";import{l as x,L as Se}from"./leaflet-src-BnmI86B7.js";import{c as ke,a as Ce,b as Pe,d as Ge,r as Le}from"./leaflet-geoman-ARjv0fYN.js";import{V as Fe}from"./VanillaJsonEditor-nLNVIU6S.js";import{u as xe}from"./useComponentRef-B9nY-MAs.js";import{E as Ie}from"./el-empty-CuKm-DsC.js";import{E as Ae,a as Je}from"./el-table-v2-B3tEd0kT.js";import{a as Ne,E as Oe}from"./el-form-item-kovEj_mb.js";/* empty css               */import{E as Te,a as Re}from"./el-select-DJpUoPud.js";import"./el-popper-BdJY1EqL.js";import{E as Ve}from"./el-divider-BgDs0RYf.js";import{v as $e}from"./Router-C0aDl8pN.js";import{c as Be}from"./createFile-Ce56hxh9.js";import"./strings-DT960cQm.js";import"./el-dialog-6jBpT6o3.js";import"./index-chG_rj5Z.js";import"./isUndefined-DCTLXrZ8.js";import"./el-space-C8juaj_X.js";import"./jse-theme-dark-CFmzvhlh.js";import"./memoize-one.esm-BdPwpGay.js";import"./index-DDFCK9dU.js";import"./range-CCn-ECPT.js";import"./toFinite-CCKxI8X3.js";import"./map-D4qGIjMb.js";import"./_baseIteratee-w-aZALqf.js";import"./_baseEach-D39NVPE_.js";import"./_castFunction-D5jfTCvG.js";import"./formatBytes-aAslYXQD.js";import"./castArray-0GIcrlWO.js";import"./raf-CqDAvC0t.js";import"./index-D8EXOWEK.js";import"./index-C78kZw_K.js";class _{static on(n,e){if(n&&typeof e=="function"){const r=this._events.get(n);r?r.push(e):this._events.set(n,[e])}}static off(n,e){const r=this._events.get(n);if(r)if(typeof e=="function"){for(let o=r.length-1;o>=0;o--)e===r[o]&&r.splice(o,1);r.length===0&&this._events.delete(n)}else this._events.delete(n)}static emit(n,...e){const r=this._events.get(n);if(r)for(const o of r)o(...e)}}X(_,"_events",new Map);function De({geojson:t,onEachFeature:n,pointToLayer:e}={}){return x.geoJSON(t,{onEachFeature:n,pointToLayer:e??Ke})}function Ke(t,n){return x.marker(n)}var w=63710088e-1,Ue={centimeters:w*100,centimetres:w*100,degrees:360/(2*Math.PI),feet:w*3.28084,inches:w*39.37,kilometers:w/1e3,kilometres:w/1e3,meters:w,metres:w,miles:w/1609.344,millimeters:w*1e3,millimetres:w*1e3,nauticalmiles:w/1852,radians:1,yards:w*1.0936};function le(t,n,e={}){const r={type:"Feature"};return(e.id===0||e.id)&&(r.id=e.id),e.bbox&&(r.bbox=e.bbox),r.properties=n||{},r.geometry=t,r}function qe(t,n,e={}){if(!t)throw new Error("coordinates is required");if(!Array.isArray(t))throw new Error("coordinates must be an Array");if(t.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!Y(t[0])||!Y(t[1]))throw new Error("coordinates must contain numbers");return le({type:"Point",coordinates:t},n,e)}function je(t,n,e={}){for(const o of t){if(o.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");if(o[o.length-1].length!==o[0].length)throw new Error("First and last Position are not equivalent.");for(let a=0;a<o[o.length-1].length;a++)if(o[o.length-1][a]!==o[0][a])throw new Error("First and last Position are not equivalent.")}return le({type:"Polygon",coordinates:t},n,e)}function ze(t,n="kilometers"){const e=Ue[n];if(!e)throw new Error(n+" units is invalid");return t/e}function H(t){return t%(2*Math.PI)*180/Math.PI}function D(t){return t%360*Math.PI/180}function Y(t){return!isNaN(t)&&t!==null&&!Array.isArray(t)}function Xe(t){if(!t)throw new Error("coord is required");if(!Array.isArray(t)){if(t.type==="Feature"&&t.geometry!==null&&t.geometry.type==="Point")return[...t.geometry.coordinates];if(t.type==="Point")return[...t.coordinates]}if(Array.isArray(t)&&t.length>=2&&!Array.isArray(t[0])&&!Array.isArray(t[1]))return[...t];throw new Error("coord must be GeoJSON Point or an Array of numbers")}function He(t,n,e,r={}){const o=Xe(t),a=D(o[0]),s=D(o[1]),i=D(e),l=ze(n,r.units),y=Math.asin(Math.sin(s)*Math.cos(l)+Math.cos(s)*Math.sin(l)*Math.cos(i)),g=a+Math.atan2(Math.sin(i)*Math.sin(l)*Math.cos(s),Math.cos(l)-Math.sin(s)*Math.sin(y)),v=H(g),f=H(y);return qe([v,f],r.properties)}function Ye(t,n){var e,r,o,a,s,i,l,y,g,v,f=0,p=t.type==="FeatureCollection",u=t.type==="Feature",m=p?t.features.length:1;for(e=0;e<m;e++){for(i=p?t.features[e].geometry:u?t.geometry:t,y=p?t.features[e].properties:u?t.properties:{},g=p?t.features[e].bbox:u?t.bbox:void 0,v=p?t.features[e].id:u?t.id:void 0,l=i?i.type==="GeometryCollection":!1,s=l?i.geometries.length:1,o=0;o<s;o++){if(a=l?i.geometries[o]:i,a===null){if(n(null,f,y,g,v)===!1)return!1;continue}switch(a.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":{if(n(a,f,y,g,v)===!1)return!1;break}case"GeometryCollection":{for(r=0;r<a.geometries.length;r++)if(n(a.geometries[r],f,y,g,v)===!1)return!1;break}default:throw new Error("Unknown Geometry Type")}}f++}}function We(t,n,e){var r=e;return Ye(t,function(o,a,s,i,l){a===0&&e===void 0?r=o:r=n(r,o,a,s,i,l)}),r}function Ze(t){return We(t,(n,e)=>n+Qe(e),0)}function Qe(t){let n=0,e;switch(t.type){case"Polygon":return W(t.coordinates);case"MultiPolygon":for(e=0;e<t.coordinates.length;e++)n+=W(t.coordinates[e]);return n;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":return 0}return 0}function W(t){let n=0;if(t&&t.length>0){n+=Math.abs(Z(t[0]));for(let e=1;e<t.length;e++)n-=Math.abs(Z(t[e]))}return n}var et=w*w/2,K=Math.PI/180;function Z(t){const n=t.length-1;if(n<=2)return 0;let e=0,r=0;for(;r<n;){const o=t[r],a=t[r+1===n?0:r+1],s=t[r+2>=n?(r+2)%n:r+2],i=o[0]*K,l=a[1]*K,y=s[0]*K;e+=(y-i)*Math.sin(l),r++}return e*et}function tt(t,n,e={}){const r=e.steps||64,o=e.properties?e.properties:!Array.isArray(t)&&t.type==="Feature"&&t.properties?t.properties:{},a=[];for(let s=0;s<r;s++)a.push(He(t,n,s*-360/r,e).geometry.coordinates);return a.push(a[0]),je([a],o)}function nt(t,{onChange:n}){t.on("pm:change",({layer:e})=>{n(e)})}function rt(t,n,{onCreate:e,onRemove:r,onChange:o}={}){t.pm||Se.PM.reInitLayer(t),t.pm.setLang("zh"),t.pm.setGlobalOptions({layerGroup:n}),t.pm.addControls({position:"topright",drawCircleMarker:!1,drawText:!1,rotateMode:!0}),e&&(t.on("pm:create",({shape:s,layer:i})=>{a({shape:s,layer:i}),e(i)}),t.on("pm:cut",({layer:s})=>{a({layer:s}),e(s)})),r&&t.on("pm:remove",({layer:s})=>{r(s)}),o&&(t.on("pm:create",({shape:s,layer:i})=>{a({shape:s,layer:i}),o(i)}),t.on("pm:cut",({layer:s})=>{o(s)}),t.on("pm:remove",({layer:s})=>{o(s)}));function a({shape:s,layer:i}){if(s==="Circle"){const l=i,y=l.getLatLng(),g=l.getRadius();n.addData(tt([y.lng,y.lat],g/1e3))}else n.addData(i.toGeoJSON());n.removeLayer(i)}}const ot=t=>(me("data-v-e660fe9d"),t=t(),_e(),t),at=ot(()=>L("div",{class:"title"},[L("span",null,"属性")],-1)),st={key:0,class:"content"},it=T({__name:"MainMap",setup(t){const n=new x.Icon.Default,e=new x.Icon.Default({iconUrl:"marker-icon-yellow.png",iconRetinaUrl:"marker-icon-2x-yellow.png"});let r,o;const a=J(),s=J(),i=J();R(()=>{_.on("getMap",l),_.on("updateGeojsonLayer",v),_.on("getGeoJson",f),_.on("selectFeature",u),y()}),Q(()=>{_.off("getMap",l),_.off("updateGeojsonLayer",v),_.off("getGeoJson",f),_.off("selectFeature",u),o&&o.remove()});function l(){return o}function y(){s.value&&(o=ke({dom:s.value,view:{center:[35,105],zoom:4}}),Ce(o),r=De({onEachFeature:g}).addTo(o),Pe(o,{name:"图形",layer:r}),rt(o,r,{onChange(){p()}}))}function g(m,d){nt(d,{onChange:()=>{p()}}),m.properties||(m.properties={}),i.value&&d.bindPopup(i.value).on("popupopen",()=>{a.value=m,o.hasLayer(d)&&(d instanceof x.Marker?d.setIcon(e):d.setStyle({color:"#ffff00",weight:5,opacity:.65}))}).on("popupclose",()=>{a.value=void 0,o.hasLayer(d)&&(d instanceof x.Marker?d.setIcon(n):r.resetStyle(d))})}function v(m){r.clearLayers();try{r.addData(m),o.fitBounds(r.getBounds())}catch{}}function f(m){m(r==null?void 0:r.toGeoJSON())}function p(){r.getLayers().length===0?_.emit("updateEditor",{type:"FeatureCollection",features:[]}):_.emit("updateEditor",r.toGeoJSON())}function u(m){if(r.getLayers().length>m){const d=r.getLayers()[m];d.openPopup(),o.fitBounds(d.getBounds())}}return(m,d)=>{var P,G;const E=Ee,k=Me;return S(),C(N,null,[L("div",{ref_key:"mapContainer",ref:s,class:"map-container"},null,512),ee(L("div",{ref_key:"propertyPopup",ref:i,class:"property-popup"},[at,(P=h(a))!=null&&P.properties&&Object.keys((G=h(a))==null?void 0:G.properties).length?(S(),C("div",st,[c(k,{column:1,border:!0},{default:b(()=>[(S(!0),C(N,null,te(h(a).properties,(F,A,V)=>(S(),z(E,{key:V,label:A.toString()},{default:b(()=>[O(U(F),1)]),_:2},1032,["label"]))),128))]),_:1})])):ne("",!0)],512),[[re,!1]])],64)}}}),lt=I(it,[["__scopeId","data-v-e660fe9d"]]),ut=T({__name:"Editor",setup(t){const n=xe();let e={type:"FeatureCollection",features:[]};const r=q(s,500);R(()=>{_.on("updateEditor",r)}),Q(()=>{_.off("updateEditor",r)});const o=q(a,500);function a(i){try{typeof i=="string"?e=JSON.parse(i):e=i,_.emit("updateGeojsonLayer",e)}catch{}}function s(i){var l;(l=n.value)==null||l.update(i)}return(i,l)=>(S(),z(Fe,{ref_key:"editor",ref:n,class:"edit-data-json",config:{mode:"text"},content:h(e),onChange:h(o)},null,8,["content","onChange"]))}}),ct=I(ut,[["__scopeId","data-v-df2ec252"]]),pt=T({__name:"PropertyTable",props:{height:{default:null}},setup(t){R(()=>{_.on("updateGeojsonLayer",g),_.on("updateEditor",g)});const n=ye(),e=oe({row:null,col:null,value:null,changed:!1});let r=!1;const o=j(()=>{var f,p;return(p=(f=n.value)==null?void 0:f.features)!=null&&p.length?n.value.features.map(u=>u.properties||{}):[]}),a=j(()=>{var f,p;if((p=(f=n.value)==null?void 0:f.features)!=null&&p.length){const u=v(o.value);if(!u.length)return null;const m=u.map(d=>({title:d,dataKey:d,key:d,width:150,cellRenderer:({rowData:E,column:k,rowIndex:P,columnIndex:G})=>{let F,A;E[k.dataKey]!=null?(A=typeof E[k.dataKey],~["boolean","number","string"].indexOf(A)?F=E[k.dataKey].toString():F=JSON.stringify(E[k.dataKey])):F="";const V=()=>{e.row=P,e.col=G,e.value=F},ue=()=>{if(e.changed){let M;if(e.value!=null?M=e.value.trim():M="",A!=="string")try{M=JSON.parse(M)}catch{}l(P,G,M)}e.row=null,e.col=null,e.value=null,e.changed=!1},ce=M=>{e.value=M,e.changed=!0},pe=M=>{var $;($=M==null?void 0:M.focus)==null||$.call(M)};return e.row===P&&e.col===G?c(ae,{ref:pe,modelValue:e.value,onInput:ce,onBlur:ue},null):c("div",{class:"table-v2-inline-editing-trigger",onClick:V,title:F},[F])}}));return m.unshift({title:"序号",dataKey:"index",key:"index",width:50,fixed:!0,cellRenderer:({rowIndex:d})=>c("span",{class:"_index"},[d+1])}),m}else return null}),s=q(y,500);function i(f){var u;let p=f.target;if(p.classList.contains("el-table-v2__row")||(p=p.closest(".el-table-v2__row")),p&&p.parentElement){const m=[].indexOf.call(p.parentElement.children,p),d=(u=p.closest(".el-table-v2__root"))==null?void 0:u.querySelectorAll("._index")[m];if(d){const E=Number.parseInt(d.textContent||"1")-1;_.emit("selectFeature",E)}}}function l(f,p,u){var d,E,k,P;const m=(E=(d=n.value)==null?void 0:d.features)==null?void 0:E[f];if(m){m.properties||(m.properties={});const G=(P=(k=a.value)==null?void 0:k[p])==null?void 0:P.dataKey;G&&(m.properties[G]=u)}n.value&&s(he(n.value))}function y(f){r||(r=!0,_.emit("updateEditor",f),r=!1)}function g(){r||_.emit("getGeoJson",f=>{n.value=f})}function v(f){return[...f.reduce((p,u)=>(Object.keys(u).forEach(m=>p.add(m)),p),new Set)]}return(f,p)=>{const u=Ae,m=Je,d=Ie;return h(a)?(S(),C("div",{key:0,"w-full":"",style:ge({height:f.height?`${f.height}px`:void 0})},[c(m,null,{default:b(({height:E,width:k})=>[c(u,{columns:h(a),data:h(o),width:k,height:E,fixed:"",onClick:i},null,8,["columns","data","width","height"])]),_:1})],4)):(S(),z(d,{key:1}))}}}),ft=I(pt,[["__scopeId","data-v-40ed404b"]]),dt={class:"layer-wrapper"},mt=["title"],_t=["title"],yt=T({__name:"AddService",setup(t){let n;const e=oe({count:0,name:"服务 1",url:"",type:"supermap_rest",layers:[]});R(()=>{_.emit("getMap",a=>{n=a})});function r(){const a=e.url,s=e.type,i=e.name;e.count++,e.name=`服务 ${e.count}`;let l;try{l=Ge(n,{name:i,type:s,url:a})}catch{se.error("添加服务失败");return}l&&e.layers.push({name:i,url:a,layer:l,id:$e()})}function o(a){var s;(s=e.layers[a])!=null&&s.layer&&(Le(n,e.layers[a].layer),e.layers.splice(a,1))}return(a,s)=>{const i=ie,l=Ve,y=ae,g=Ne,v=Te,f=Re,p=Oe;return S(),C(N,null,[h(e).layers.length?(S(),C(N,{key:0},[L("div",dt,[(S(!0),C(N,null,te(h(e).layers,(u,m)=>(S(),C("div",{key:u.id,class:"layer-item"},[L("div",{class:"layer-item-title",title:u.name},U(u.name),9,mt),L("div",{class:"layer-item-url",title:u.url},U(u.url),9,_t),c(i,{onClick:d=>o(m)},{default:b(()=>[O(" 移除 ")]),_:2},1032,["onClick"])]))),128))]),c(l)],64)):ne("",!0),c(p,{colon:!1,class:"addService"},{default:b(()=>[c(g,{label:"服务名称"},{default:b(()=>[c(y,{modelValue:h(e).name,"onUpdate:modelValue":s[0]||(s[0]=u=>h(e).name=u)},null,8,["modelValue"])]),_:1}),c(g,{label:"服务地址"},{default:b(()=>[c(y,{modelValue:h(e).url,"onUpdate:modelValue":s[1]||(s[1]=u=>h(e).url=u)},null,8,["modelValue"])]),_:1}),c(g,{label:"服务类型"},{default:b(()=>[c(f,{modelValue:h(e).type,"onUpdate:modelValue":s[2]||(s[2]=u=>h(e).type=u)},{default:b(()=>[c(v,{value:"supermap_rest",label:"超图动态"}),c(v,{value:"supermap_tile",label:"超图切片"}),c(v,{value:"arcgis_rest",label:"ArcGIS 动态"}),c(v,{value:"arcgis_tile",label:"ArcGIS 切片"}),c(v,{value:"tms",label:"TMS"})]),_:1},8,["modelValue"])]),_:1}),c(g,{class:"formBtnItem"},{default:b(()=>[c(i,{type:"primary",onClick:r},{default:b(()=>[O(" 添加 ")]),_:1})]),_:1})]),_:1})],64)}}}),gt=I(yt,[["__scopeId","data-v-4dbebe0b"]]),ht={class:"controlMenu"},vt={__name:"ControlMenu",setup(t){function n(o){if(o.target.files.length){const a=o.target.files[0],s=new FileReader;s.onload=()=>{if(s.result&&typeof s.result=="string")try{const i=JSON.parse(s.result);_.emit("updateEditor",i),_.emit("updateGeojsonLayer",i)}catch{}},s.readAsText(a)}o.target.value=""}function e(){_.emit("getGeoJson",o=>{o?Be(JSON.stringify(o),"exportFile.geojson"):se.warning("无可导出数据")})}function r(){_.emit("getGeoJson",o=>{if(o){const a=Ze(o);a<1e6?B.alert(`面积: ${a.toFixed(2)} 平方米`,"信息"):a<1e8?B.alert(`面积: ${(a/1e4).toFixed(2)} 公顷`,"信息"):B.alert(`面积: ${(a/1e6).toFixed(2)} 平方千米`,"信息")}})}return(o,a)=>{const s=ie;return S(),C("div",ht,[ee(L("input",{ref:"uploader",type:"file",accept:".json,.JSON,.geojson,.GEOJSON",onChange:n},null,544),[[re,!1]]),c(s,{onClick:a[0]||(a[0]=i=>o.$refs.uploader.click())},{default:b(()=>[O(" 打开 ")]),_:1}),c(s,{onClick:e},{default:b(()=>[O(" 保存 ")]),_:1}),L("i",{class:"i-icon-park-outline-info",onClick:r})])}}},bt=I(vt,[["__scopeId","data-v-416b8397"]]),wt=T({__name:"geoJson",setup(t){const n=J("geoJson"),e=J(),r=j(()=>e.value?Number.parseFloat(getComputedStyle(e.value).height)-40:400);return(o,a)=>{const s=be,i=we;return S(),C("div",{ref_key:"wrapper",ref:e,class:"wrapper"},[c(lt),c(i,{modelValue:h(n),"onUpdate:modelValue":a[0]||(a[0]=l=>ve(n)?n.value=l:null),type:"card"},{default:b(()=>[c(s,{name:"geoJson",label:"GeoJSON"},{default:b(()=>[c(ct)]),_:1}),c(s,{name:"table",label:"属性表"},{default:b(()=>[c(ft,{height:h(r)},null,8,["height"])]),_:1}),c(s,{name:"addService",label:"添加服务"},{default:b(()=>[c(gt)]),_:1})]),_:1},8,["modelValue"]),c(bt)],512)}}}),on=I(wt,[["__scopeId","data-v-baae8638"]]);export{on as default};
